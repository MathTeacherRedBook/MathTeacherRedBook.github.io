<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑ - Êèê‰æõÁ≠îÈ¢òÂç°ÁîüÊàê„ÄÅÁï™ËåÑÊó∂Èíü„ÄÅËØæË°®ÁÆ°ÁêÜ„ÄÅÂáΩÊï∞ÁªòÂà∂Á≠â‰∏ì‰∏öÂäüËÉΩ">
    <meta name="keywords" content="Êï∞Â≠¶ÊïôÂ≠¶,Á≠îÈ¢òÂç°ÁîüÊàê,Áï™ËåÑÊó∂Èíü,ËØæË°®,ÂáΩÊï∞ÁªòÂà∂,ÊïôÂ∏àÂ∑•ÂÖ∑">
    <meta name="author" content="Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏à">
    <meta name="theme-color" content="#0071e3">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìê</text></svg>">
    <title>Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?5d0914528f74ad1ba2153b4ecc0310a8";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    <style>
        /* ========== CSSÂèòÈáèÂíå‰∏ªÈ¢òÁ≥ªÁªü ========== */
        :root {
            --primary-color: #0071e3;
            --success-color: #34c759;
            --warning-color: #FF9500;
            --error-color: #ff3b30;
            --bg-color: #f5f5f7;
            --text-color: #1d1d1f;
            --text-secondary: #86868b;
            --card-bg: #ffffff;
            --border-color: #e5e5e7;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --primary-color: #2997ff;
            --success-color: #30d158;
            --warning-color: #ffd60a;
            --error-color: #ff453a;
            --bg-color: #000000;
            --text-color: #f5f5f7;
            --text-secondary: #86868b;
            --card-bg: #1c1c1e;
            --border-color: #38383a;
            --gray-200: #374151;
            --gray-700: #e5e7eb;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* ========== ÂÖ®Â±ÄÊ†∑ÂºèÂíå‰ºòÂåñ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Microsoft YaHei", "SimSun", sans-serif;
            background-color: var(--bg-color);
            min-height:  100vh;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Âä†ËΩΩÂä®Áîª */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* ÊåâÈíÆÁÑ¶ÁÇπÁä∂ÊÄÅ‰ºòÂåñ */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .nav-tabs {
            display: flex;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            position: relative;
        }

        .nav-tab:hover {
            background-color: var(--bg-color);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Á≠îÈ¢òÂç°ÁîüÊàêÁ®ãÂ∫èÊ†∑Âºè */
        .answer-sheet-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .answer-sheet-settings {
            flex: 0 0 350px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            height: fit-content;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .answer-sheet-settings h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
            text-align: center;
        }

        .as-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }

        .as-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .as-section-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .as-form-group {
            margin-bottom: 12px;
        }

        .as-form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }

        .as-form-group input[type="text"],
        .as-form-group input[type="number"],
        .as-form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .as-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .as-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .as-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .as-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .as-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .as-btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .as-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
        }

        .answer-sheet-preview {
            flex: 1;
            min-width: 600px;
        }

        .a4-sheet {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
        }

        @media print {
            .a4-sheet {
                width: 100% !important;
                min-height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
        }

        .answer-sheet {
            font-family: "SimSun", "Microsoft YaHei", sans-serif;
            color: #000;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .sheet-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: "SimHei", sans-serif;
        }

        .student-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 16px;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-underline {
            border-bottom: 1px solid #000;
            min-width: 80px;
            height: 20px;
            display: inline-block;
        }

        .seal-area {
            position: absolute;
            top: 20mm;
            right: 20mm;
            width: 80px;
            height: 80px;
            border: 1px dashed #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
        }

        .notice-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #000;
        }

        .notice-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .notice-content {
            font-size: 12px;
            line-height: 1.6;
        }

        .section-block {
            margin-bottom: 25px;
        }

        .section-title-main {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #000;
        }

        .mcq-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .mcq-item {
            border: 1px solid #000;
            padding: 8px 5px;
            text-align: center;
        }

        .mcq-num {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .mcq-options {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
        }

        .mcq-option {
            width: 14px;
            height: 14px;
            border: 1px solid #000;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }

        .blank-section {
            margin-bottom: 20px;
        }

        .blank-item {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .blank-num {
            font-weight: bold;
            margin-right: 10px;
            min-width: 30px;
        }

        .blank-line {
            flex: 1;
            border-bottom: 1px solid #000;
            min-height: 25px;
        }

        .problem-section {
            margin-bottom: 30px;
        }

        .problem-item {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .problem-num {
            font-weight: bold;
            font-size: 16px;
        }

        .problem-score {
            font-size: 14px;
            color: #333;
        }

        .problem-answer-area {
            border: 1px solid #000;
            min-height: 180px;
            position: relative;
        }

        .problem-answer-area::after {
            content: "Ëß£Á≠îÂå∫Âüü";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 14px;
        }

        .problem-score-box {
            position: absolute;
            bottom: 5px;
            right: 5px;
            border: 1px solid #000;
            padding: 2px 8px;
            font-size: 12px;
        }

        /* ÊâìËçâÁ∫∏Ê†∑Âºè */
        .scratch-paper-container {
            background-color: #ffffff;
            width: 100%;
        }

        .scratch-paper-header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 2px solid #000;
            margin-bottom: 20px;
        }

        .scratch-paper-title {
            font-size: 24px;
            font-weight: bold;
            font-family: "SimHei", sans-serif;
        }

        .scratch-paper-modules {
            display: grid;
            gap: 0;
            width: 100%;
        }

        .scratch-paper-module {
            border: 1px dashed #999;
            min-height: 150px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .scratch-paper-module-label {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-bottom: 5px;
            font-family: "SimSun", sans-serif;
            flex-shrink: 0;
        }

        /* Áï™ËåÑÊó∂ÈíüÊ†∑Âºè */
        .tomato-container {
            max-width: 450px;
            margin: 40px auto;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 40px;
            text-align: center;
        }

        .tomato-current-time {
            font-size: 18px;
            color: #86868b;
            margin-bottom: 20px;
        }

        .tomato-timer-display {
            font-size: 72px;
            font-weight: 300;
            margin: 30px 0;
            color: #1d1d1f;
            letter-spacing: -2px;
        }

        .tomato-mode-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tomato-mode-btn {
            background-color: #f5f5f7;
            border: none;
            border-radius: 18px;
            padding: 8px 16px;
            font-size: 14px;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tomato-mode-btn.active {
            background-color: #0071e3;
            color: white;
        }

        .tomato-mode-btn:hover:not(.active) {
            background-color: #e8e8ed;
        }

        .tomato-control-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
        }

        .tomato-control-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tomato-control-btn.reset {
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .tomato-control-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .tomato-control-btn:active {
            transform: translateY(0);
        }

        .tomato-stats {
            font-size: 14px;
            color: #86868b;
        }

        /* ËØæË°®Á®ãÂ∫èÊ†∑Âºè */
        .schedule-container-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .schedule-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .schedule-header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .schedule-date-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .schedule-date-controls button {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 980px;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .schedule-date-controls button:hover {
            background-color: #0077ed;
        }

        .schedule-date-controls button:active {
            transform: scale(0.98);
        }

        .schedule-date-display {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .schedule-controls-bar {
            background-color: #f5f5f7;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .schedule-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 980px;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            min-height: 32px;
        }

        .schedule-btn:hover {
            background-color: #0077ed;
        }

        .schedule-btn:active {
            transform: scale(0.98);
        }

        .schedule-btn-secondary {
            background-color: #e8e8ed;
            color: #1d1d1f;
        }

        .schedule-btn-secondary:hover {
            background-color: #dedee3;
        }

        .schedule-btn-success {
            background-color: #34c759;
        }

        .schedule-btn-success:hover {
            background-color: #30b350;
        }

        .schedule-btn-danger {
            background-color: #ff3b30;
        }

        .schedule-btn-danger:hover {
            background-color: #e6352b;
        }
        }

        .schedule-table-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            page-break-inside: avoid;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #e5e5e7;
            padding: 12px;
            text-align: center;
            min-width: 120px;
            page-break-inside: avoid;
        }

        .schedule-table th {
            background-color: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .schedule-table td {
            height: 80px;
            vertical-align: top;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .schedule-table td:hover {
            background-color: #fafafa;
        }

        .schedule-time-column {
            width: 140px;
            min-width: 140px;
            background-color: #f5f5f7;
            font-weight: 500;
        }

        .schedule-time-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .schedule-time-input:focus {
            outline: none;
            border-color: #0071e3;
        }

        .schedule-date-subtitle {
            font-size: 12px;
            color: #86868b;
            font-weight: normal;
            margin-top: 4px;
        }

        .schedule-course-card {
            background-color: #007aff;
            color: white;
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .schedule-course-card:hover {
            transform: scale(1.02);
        }

        .schedule-course-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .schedule-course-location {
            font-size: 11px;
            opacity: 0.9;
        }

        .schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .schedule-modal.show {
            display: flex;
        }

        .schedule-modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 90%;
            max-width: 400px;
        }

        .schedule-modal-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .schedule-form-group {
            margin-bottom: 15px;
        }

        .schedule-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .schedule-form-group input,
        .schedule-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .schedule-form-group input:focus,
        .schedule-form-group select:focus {
            outline: none;
            border-color: #0071e3;
        }

        .schedule-color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .schedule-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .schedule-color-option.selected {
            border-color: #1d1d1f;
        }

        .schedule-color-option:hover {
            transform: scale(1.1);
        }

        .schedule-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .schedule-modal-buttons .schedule-btn {
            flex: 1;
        }

        .schedule-btn-danger {
            background-color: #ff3b30;
        }

        /* ÂáΩÊï∞ÁªòÂà∂Ê†∑Âºè */
        .tab-active {
            border-bottom: 2px solid #0071E3;
            color: #0071E3;
            font-medium;
        }

        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .input-apple {
            border-radius: 8px;
            border: 1px solid #d2d2d7;
            background: white;
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .input-apple:focus {
            outline: none;
            border-color: #0071E3;
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.2);
        }

        .btn-apple {
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-apple:hover {
            opacity: 0.9;
        }

        .btn-hover:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* È¢úËâ≤Á±ªÂÆö‰πâ */
        .bg-primary {
            background-color: #0071E3;
        }

        .bg-gray-200 {
            background-color: #e5e7eb;
        }

        .bg-warning {
            background-color: #FF9500;
        }

        .text-white {
            color: white;
        }

        .text-gray-700 {
            color: #374151;
        }

        .coord-tooltip {
            position: fixed;
            background: rgba(29, 29, 31, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
        }

        .func-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .func-delete {
            color: #ff3b30;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .func-delete:hover {
            color: #ff2d55;
        }

        .chart-height {
            height: clamp(350px, 65vh, 600px);
        }

        .force-horizontal {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
        }

        .left-panel {
            flex: 0 0 450px;
            min-width: 450px;
            max-width: 450px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .right-panel {
            flex: 1;
            min-width: 500px;
        }

        @media (max-width: 1200px) {
            .left-panel {
                flex: 0 0 400px;
                min-width: 400px;
                max-width: 400px;
            }
            .right-panel {
                min-width: 450px;
            }
        }

        @media (max-width: 992px) {
            .force-horizontal {
                flex-wrap: wrap !important;
            }
            .left-panel {
                flex: 0 0 100%;
                min-width: 100%;
                max-width: 100%;
                max-height: 500px;
                margin-bottom: 1rem;
            }
            .right-panel {
                flex: 0 0 100%;
                min-width: 100%;
            }
        }

        @media print {
            .nav-tabs,
            .answer-sheet-settings,
            .no-print {
                display: none;
            }
            .answer-sheet-preview {
                flex: 1;
                width: 100%;
            }
            .a4-sheet {
                box-shadow: none;
                width: 100%;
                min-height: auto;
                padding: 15mm;
                margin: 0;
            }
            .schedule-table-container {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            .schedule-table {
                page-break-inside: auto;
            }
            .schedule-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .schedule-table th,
            .schedule-table td {
                padding: 8px;
            }
        }

        @media (max-width: 768px) {
            .tomato-timer-display {
                font-size: 60px;
            }
            .tomato-container {
                padding: 30px 20px;
            }
            .schedule-table th,
            .schedule-table td {
                min-width: 80px;
                padding: 8px;
                font-size: 12px;
            }
            .schedule-course-card {
                font-size: 10px;
                padding: 6px;
            }
            .schedule-time-column {
                width: 100px;
                min-width: 100px;
            }
            .answer-sheet-settings {
                flex: 1 1 100%;
                position: relative;
                top: 0;
                max-height: none;
            }
            .answer-sheet-preview {
                min-width: 100%;
            }
            .a4-sheet {
                width: 100%;
                transform-origin: top left;
            }
            .month-plan-layout {
                flex-direction: column !important;
            }
            .month-plan-detail-panel {
                width: 100% !important;
            }
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 999;
            font-size: 20px;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }

        .theme-toggle-btn:active {
            transform: scale(0.95);
        }

        /* ËØæË°®Á®ãÂ∫èÈÄâÈ°πÂç°Ê†∑Âºè */
        .schedule-view-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .schedule-view-tab:hover {
            background: var(--bg-color);
        }

        .schedule-view-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* Âá†‰ΩïÁªòÂõæÊ†∑Âºè */
        .geometry-tool-btn {
            transition: all 0.2s ease;
        }
        
        .geometry-tool-btn:hover {
            transform: translateY(-2px);
        }
        
        .geometry-tool-btn.active {
            background: rgba(0, 113, 227, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .geometry-color-btn,
        .geometry-fill-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .geometry-color-btn:hover,
        .geometry-fill-btn:hover {
            transform: scale(1.1);
        }
        
        .geometry-color-btn.active,
        .geometry-fill-btn.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        #geometry-canvas {
            background-image: 
                linear-gradient(rgba(200, 200, 200, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 200, 200, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #geometry-canvas.grid-hidden {
            background-image: none;
        }

        /* Êî∂ÂÖ•ËÆ∞ÂΩïÊ†∑Âºè - ËãπÊûúÈ£éÊ†º */
        .income-stats-card {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .income-stats-card {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .income-stat-item {
            background: white;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid #e5e5e7;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .income-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .income-stat-icon.blue { background: #e8f4fd; color: #0071e3; }
        .income-stat-icon.green { background: #e8f5e9; color: #34c759; }
        .income-stat-icon.orange { background: #fff3e0; color: #ff9500; }
        .income-stat-icon.teal { background: #e0f2f1; color: #009688; }

        .income-stat-content {
            flex: 1;
        }

        .income-stat-label {
            font-size: 11px;
            color: #86868b;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .income-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .income-calendar-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #e5e5e7;
        }

        .income-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .income-weekday {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            padding: 8px;
        }

        .income-weekend {
            color: #ef4444;
        }

        .income-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .income-day-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f8fafc;
            border: 2px solid transparent;
            min-height: 80px;
        }

        .income-day-cell:hover {
            background: #e0f2fe;
            border-color: #38bdf8;
            transform: translateY(-2px);
        }

        .income-day-cell.other-month {
            opacity: 0.4;
            background: #f1f5f9;
        }

        .income-day-cell.today {
            border-color: #10b981;
            background: #d1fae5;
        }

        .income-day-cell.has-data {
            background: #dbeafe;
        }

        .income-day-number {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .income-day-cell.weekend .income-day-number {
            color: #ef4444;
        }

        .income-day-hours {
            font-size: 11px;
            color: #3b82f6;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-bottom: 2px;
        }

        .income-day-amount {
            font-size: 11px;
            color: #ec4899;
            font-weight: 600;
            background: rgba(236, 72, 153, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .income-day-rest {
            font-size: 12px;
            color: #9ca3af;
            margin-top: auto;
        }

        /* Êî∂ÂÖ•ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü */
        .income-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .income-modal.show {
            display: flex;
        }

        .income-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .income-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .income-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .income-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
        }

        .income-modal-close:hover {
            color: #374151;
        }

        .income-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .income-form-group {
            margin-bottom: 16px;
        }

        .income-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .income-form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .income-form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .income-form-group input[readonly] {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .income-form-summary {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .income-form-summary-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
        }

        .income-form-total {
            font-size: 16px;
            font-weight: 700;
            color: #059669;
            border-top: 1px dashed #86efac;
            padding-top: 8px;
            margin-top: 8px;
        }

        .income-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .income-modal-actions {
            display: flex;
            gap: 12px;
        }

        .income-btn-cancel {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 15px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-cancel:hover {
            background: #f3f4f6;
        }

        .income-btn-save {
            padding: 10px 24px;
            background: #10b981;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-save:hover {
            background: #059669;
        }

        .income-btn-delete {
            padding: 10px 16px;
            background: #ef4444;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-btn-delete:hover {
            background: #dc2626;
        }

        /* Â≠¶ÁîüÁÆ°ÁêÜÊ†∑Âºè - ËãπÊûúÈ£éÊ†º */
        .apple-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 980px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            min-height: 36px;
        }

        .apple-btn-primary {
            background: #0071e3;
            color: white;
        }

        .apple-btn-primary:hover {
            background: #0077ed;
        }

        .apple-btn-primary:active {
            background: #0068d1;
            transform: scale(0.98);
        }

        .apple-btn-secondary {
            background: #e8e8ed;
            color: #1d1d1f;
        }

        .apple-btn-secondary:hover {
            background: #dedee3;
        }

        .apple-btn-secondary:active {
            background: #d4d4d9;
            transform: scale(0.98);
        }

        /* ÂÖ¨ÂºèÁºñËæëÂô®Ê†∑Âºè */
        .formula-level-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 980px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #e8e8ed;
            color: #1d1d1f;
        }

        .formula-level-btn:hover {
            background: #dedee3;
        }

        .formula-level-btn.active {
            background: #0071e3;
            color: white;
        }

        .formula-symbol-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e5e5e7;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-symbol-btn:hover {
            background: #f5f5f7;
            border-color: #0071e3;
        }

        .formula-symbol-btn:active {
            transform: scale(0.95);
            background: #e8e8ed;
        }

        .formula-item {
            padding: 10px 12px;
            border-radius: 10px;
            background: #f5f5f7;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .formula-item:hover {
            background: #e8e8ed;
        }

        .formula-item:active {
            transform: scale(0.98);
        }

        .formula-category-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 12px 0 8px 0;
            padding-left: 4px;
        }

        #formula-editor {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        #formula-preview {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.8;
        }

        .student-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .student-status-active {
            background: #d1fae5;
            color: #059669;
        }

        .student-status-paused {
            background: #fef3c7;
            color: #d97706;
        }

        .student-status-graduated {
            background: #e5e7eb;
            color: #6b7280;
        }

        .student-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .student-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .student-info-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .student-name {
            font-weight: 600;
            color: #1f2937;
        }

        .student-phone {
            font-size: 12px;
            color: #6b7280;
        }

        .student-hours-info {
            text-align: center;
        }

        .student-hours-text {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .student-hours-remaining {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .student-action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .student-action-view {
            background: #dbeafe;
            color: #2563eb;
        }

        .student-action-view:hover {
            background: #bfdbfe;
        }

        .student-action-edit {
            background: #fef3c7;
            color: #d97706;
            margin-left: 8px;
        }

        .student-action-edit:hover {
            background: #fde68a;
        }

        .student-detail-section {
            margin-bottom: 20px;
        }

        .student-detail-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .student-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .student-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .student-weak-points {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .student-weak-point-tag {
            background: #fee2e2;
            color: #dc2626;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* ÊúàËÆ°ÂàíÊ†∑Âºè */
        .month-calendar-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin: 0 20px;
        }

        .month-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-color);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            background: rgba(0, 113, 227, 0.1);
        }
        
        [data-theme="dark"] .calendar-day.today {
            background: rgba(41, 151, 255, 0.2);
        }

        .calendar-day.selected {
            border-color: var(--primary-color);
            background: rgba(0, 113, 227, 0.15);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        [data-theme="dark"] .calendar-day.selected {
            background: rgba(41, 151, 255, 0.25);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .calendar-day.today .calendar-day-number {
            color: var(--primary-color);
        }

        .calendar-dots {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* ÊúàËÆ°ÂàíËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü - Â§çÁî®Áé∞ÊúâÊ†∑Âºè */
    </style>
</head>
<body>
    <!-- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ -->
    <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="ÂàáÊç¢‰∏ªÈ¢ò" title="Ctrl+DÂàáÊç¢‰∏ªÈ¢ò">
        üåô
    </button>
    <div class="nav-tabs" role="navigation" aria-label="‰∏ªÂØºËà™">
        <button class="nav-tab active" data-tab="home" role="tab" aria-selected="true">üè† ‰∏ªÈ°µ</button>
        <button class="nav-tab" data-tab="answer-sheet" role="tab" aria-selected="false">üìù Á≠îÈ¢òÂç°ÁîüÊàê</button>
        <button class="nav-tab" data-tab="tomato" role="tab" aria-selected="false">üçÖ Áï™ËåÑÊó∂Èíü</button>
        <button class="nav-tab" data-tab="schedule" role="tab" aria-selected="false">üìÖ ËØæË°®Á®ãÂ∫è</button>
        <button class="nav-tab" data-tab="function" role="tab" aria-selected="false">üìä ÂáΩÊï∞ÁªòÂà∂</button>
        <button class="nav-tab" data-tab="geometry" role="tab" aria-selected="false">üìê Âá†‰ΩïÁªòÂõæ</button>
        <button class="nav-tab" data-tab="income" role="tab" aria-selected="false">üí∞ Êî∂ÂÖ•ËÆ∞ÂΩï</button>
        <button class="nav-tab" data-tab="students" role="tab" aria-selected="false">üë®‚Äçüéì Â≠¶ÁîüÁÆ°ÁêÜ</button>
        <button class="nav-tab" data-tab="feedback" role="tab" aria-selected="false">üìù ËØæÂêéÂèçÈ¶à</button>
    </div>

    <!-- Â§©Ê∞îÊ®°Âùó -->
    <div id="weatherWidget" class="fixed top-20 right-4 z-40 bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4 min-w-[200px] border border-gray-200">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-600 flex items-center gap-1">
                üìç <span id="weatherCity">ÂÆö‰Ωç‰∏≠...</span>
                <button onclick="requestLocationPermission()" class="text-blue-500 hover:text-blue-700 text-xs" title="ÈáçÊñ∞ÂÆö‰Ωç">
                    <i class="fa fa-location-arrow"></i>
                </button>
            </span>
            <button onclick="refreshWeather()" class="text-gray-400 hover:text-blue-500 transition-colors" title="Âà∑Êñ∞Â§©Ê∞î">
                <i class="fa fa-refresh text-sm"></i>
            </button>
        </div>
        <div id="weatherContent" class="text-center">
            <div class="text-4xl mb-2" id="weatherIcon">üå§Ô∏è</div>
            <div class="text-2xl font-bold text-gray-800" id="weatherTemp">--¬∞</div>
            <div class="text-sm text-gray-600" id="weatherDesc">Âä†ËΩΩ‰∏≠...</div>
            <div class="flex justify-center gap-4 mt-2 text-xs text-gray-500">
                <span>üíß <span id="weatherHumidity">--%</span></span>
                <span>üí® <span id="weatherWind">--Á∫ß</span></span>
            </div>
        </div>
        <div id="weatherError" class="hidden text-center text-sm text-red-500">
            Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•
            <button onclick="initWeather()" class="block mx-auto mt-2 text-blue-500 hover:underline">ÈáçËØï</button>
        </div>
        <div id="weatherLocationPrompt" class="hidden text-center text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded-lg">
            <p class="mb-2">ÈúÄË¶ÅËé∑ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆÊù•ÊòæÁ§∫ÂΩìÂú∞Â§©Ê∞î</p>
            <button onclick="requestLocationPermission()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                ÂÖÅËÆ∏ÂÆö‰Ωç
            </button>
            <button onclick="useDefaultLocation()" class="text-gray-500 hover:text-gray-700 px-2 py-1 text-xs">
                ‰ΩøÁî®ÈªòËÆ§
            </button>
        </div>
    </div>

    <!-- ‰∏ªÈ°µ -->
    <div class="tab-content active" id="home">
        <!-- ËãπÊûúÈ£éÊ†ºÁöÑheroÂå∫Âüü -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 py-20 md:py-32">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-semibold text-gray-900 mb-6">
                    Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑
                </h1>
                <p class="text-xl md:text-2xl text-gray-600 mb-10 max-w-3xl mx-auto">
                    ‰∏ì‰∏∫Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àÊâìÈÄ†ÁöÑÂÖçË¥πËæÖÂä©Â∑•ÂÖ∑ÈõÜ<br>
                    <span class="text-lg">Ê∂µÁõñÁ≠îÈ¢òÂç°ÁîüÊàê„ÄÅÂáΩÊï∞ÁªòÂà∂„ÄÅÂá†‰ΩïÁªòÂõæ„ÄÅËØæË°®ÁÆ°ÁêÜ„ÄÅÂ≠¶ÁîüÁÆ°ÁêÜ„ÄÅÊî∂ÂÖ•ÁªüËÆ°Á≠â8Â§ßÂäüËÉΩ</span>
                </p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="scrollToFeatures()" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-medium hover:bg-blue-700 transition-colors duration-300 transform hover:-translate-y-1 shadow-lg">
                        üöÄ ÂºÄÂßã‰ΩøÁî®
                    </button>
                    <button onclick="switchTab('students')" class="bg-white text-gray-900 px-8 py-3 rounded-full text-lg font-medium hover:bg-gray-100 transition-colors duration-300 transform hover:-translate-y-1 shadow-md border border-gray-200">
                        üë®‚Äçüéì ÁÆ°ÁêÜÂ≠¶Áîü
                    </button>
                </div>
                <!-- Âø´Êç∑ÂäüËÉΩÂÖ•Âè£ -->
                <div class="mt-10 flex flex-wrap justify-center gap-3">
                    <span class="text-gray-500 text-sm">Âø´ÈÄüËÆøÈóÆÔºö</span>
                    <button onclick="switchTab('answer-sheet')" class="text-sm bg-white/80 hover:bg-white px-4 py-2 rounded-full transition-colors border border-gray-200">
                        üìù Á≠îÈ¢òÂç°
                    </button>
                    <button onclick="switchTab('function')" class="text-sm bg-white/80 hover:bg-white px-4 py-2 rounded-full transition-colors border border-gray-200">
                        üìä ÂáΩÊï∞ÁªòÂà∂
                    </button>
                    <button onclick="switchTab('geometry')" class="text-sm bg-white/80 hover:bg-white px-4 py-2 rounded-full transition-colors border border-gray-200">
                        üìê Âá†‰ΩïÁªòÂõæ
                    </button>
                    <button onclick="switchTab('income')" class="text-sm bg-white/80 hover:bg-white px-4 py-2 rounded-full transition-colors border border-gray-200">
                        üí∞ Êî∂ÂÖ•ËÆ∞ÂΩï
                    </button>
                    <button onclick="switchTab('feedback')" class="text-sm bg-white/80 hover:bg-white px-4 py-2 rounded-full transition-colors border border-gray-200">
                        üìù ËØæÂêéÂèçÈ¶à
                    </button>
                </div>
            </div>
        </div>

        <!-- Â∞èÁ∫¢‰π¶ÂÖ≥Ê≥®Âå∫Âüü -->
        <div class="py-16 bg-gradient-to-r from-red-50 to-pink-50">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-white rounded-3xl shadow-xl p-8 md:p-12 flex flex-col md:flex-row items-center gap-8 md:gap-12">
                    <!-- ‰∫åÁª¥Á†ÅÂå∫Âüü -->
                    <div class="flex-shrink-0">
                        <a href="https://www.xiaohongshu.com/discovery/item/67bdcd1a000000002900a81e?source=webshare&xhsshare=pc_web&xsec_token=ABtk6u0VsuMS3LlGa1O46qOCNIfsNM4Zj1GnaNYwcvbdE=&xsec_source=pc_share" target="_blank" rel="noopener noreferrer" class="block relative group">
                            <div class="w-48 h-48 bg-gray-100 rounded-2xl border-4 border-red-500 flex items-center justify-center overflow-hidden group-hover:shadow-lg transition-shadow">
                                <!-- ËøôÈáåÊîæÁΩÆÂ∞èÁ∫¢‰π¶‰∫åÁª¥Á†ÅÂõæÁâá -->
                                <img id="xiaohongshu-qr" src="./images/xiaohongshu-qr.png" alt="Â∞èÁ∫¢‰π¶‰∫åÁª¥Á†Å" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="hidden w-full h-full flex-col items-center justify-center text-gray-400">
                                    <i class="fa fa-qrcode text-4xl mb-2"></i>
                                    <span class="text-sm">ËØ∑Ê∑ªÂä†‰∫åÁª¥Á†ÅÂõæÁâá</span>
                                </div>
                            </div>
                            <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-1 rounded-full text-sm font-medium group-hover:bg-red-600 transition-colors">
                                Êâ´Á†ÅÂÖ≥Ê≥®
                            </div>
                        </a>
                    </div>

                    <!-- ÊñáÂ≠óÂÜÖÂÆπ -->
                    <div class="flex-1 text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start gap-3 mb-4">
                            <i class="fa fa-book text-red-500 text-2xl"></i>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900">ÂÖ≥Ê≥®ÊàëÔºåËé∑ÂèñÊõ¥Â§öÊïôÂ≠¶Âπ≤Ë¥ß</h2>
                        </div>
                        <p class="text-gray-600 mb-6 text-lg">
                            ÂàÜ‰∫´Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àÁöÑÊó•Â∏∏ÊïôÂ≠¶ÁªèÈ™å„ÄÅÂ§áËØæÊäÄÂ∑ß„ÄÅÂ≠¶ÁîüÊ°à‰æãÔºå‰ª•ÂèäÊõ¥Â§öÂÆûÁî®ÊïôÂ≠¶ËµÑÊ∫ê
                        </p>
                        <div class="flex flex-wrap items-center justify-center md:justify-start gap-4">
                            <div class="bg-red-50 px-6 py-3 rounded-xl border-2 border-red-200">
                                <span class="text-gray-500 text-sm">Â∞èÁ∫¢‰π¶Ë¥¶Âè∑</span>
                                <div class="text-red-600 font-bold text-xl" id="xiaohongshu-id">4152927294</div>
                            </div>
                            <button onclick="copyXiaohongshuId()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center gap-2">
                                <i class="fa fa-copy"></i>
                                Â§çÂà∂Ë¥¶Âè∑
                            </button>
                            <a href="https://www.xiaohongshu.com/discovery/item/67bdcd1a000000002900a81e?source=webshare&xhsshare=pc_web&xsec_token=ABtk6u0VsuMS3LlGa1O46qOCNIfsNM4Zj1GnaNYwcvbdE=&xsec_source=pc_share" target="_blank" rel="noopener noreferrer" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center gap-2">
                                <i class="fa fa-external-link"></i>
                                ËÆøÈóÆ‰∏ªÈ°µ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂäüËÉΩÁâπÁÇπÂå∫Âüü -->
        <div id="features" class="py-20 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-semibold text-center text-gray-900 mb-6">
                    ‰πùÂ§ßÊ†∏ÂøÉÂäüËÉΩÔºåÂä©ÂäõÁã¨Á´ãÊïôÂ≠¶
                </h2>
                <p class="text-center text-gray-600 mb-16 max-w-3xl mx-auto">
                    ‰ªéÂ§áËØæÂà∞ÊéàËØæÔºå‰ªéÊó∂Èó¥ÁÆ°ÁêÜÂà∞Ë¥¢Âä°ÁªüËÆ°ÔºåÂÜçÂà∞ËØæÂêéÂèçÈ¶àÔºå‰∏ÄÁ´ôÂºèËß£ÂÜ≥Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àÁöÑÊâÄÊúâÈúÄÊ±Ç
                </p>

                <!-- Á¨¨‰∏ÄË°åÔºöÊïôÂ≠¶Â∑•ÂÖ∑ -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
                        <i class="fa fa-graduation-cap text-blue-500"></i>
                        ÊïôÂ≠¶Â∑•ÂÖ∑
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Á≠îÈ¢òÂç°ÁîüÊàê -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-blue-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-file-text-o text-2xl text-blue-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Á≠îÈ¢òÂç°ÁîüÊàê</h3>
                            <p class="text-gray-600 text-sm mb-4">Ëá™ÂÆö‰πâÁîüÊàêÊ†áÂáÜÂåñÁ≠îÈ¢òÂç°ÂíåËçâÁ®øÁ∫∏ÔºåÊîØÊåÅPDFÂØºÂá∫ÊâìÂç∞</p>
                            <button onclick="switchTab('answer-sheet')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- ÂáΩÊï∞ÁªòÂà∂ -->
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-purple-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-line-chart text-2xl text-purple-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">ÂáΩÊï∞ÁªòÂà∂</h3>
                            <p class="text-gray-600 text-sm mb-4">ÊîØÊåÅ11ÁßçÂáΩÊï∞Á±ªÂûãÁªòÂà∂ÔºåÊñπÁ®ãÊ±ÇËß£Âπ∂Â±ïÁ§∫ËØ¶ÁªÜÊ≠•È™§</p>
                            <button onclick="switchTab('function')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- Âá†‰ΩïÁªòÂõæ -->
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-indigo-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-pencil-square-o text-2xl text-indigo-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Âá†‰ΩïÁªòÂõæ</h3>
                            <p class="text-gray-600 text-sm mb-4">ÊãñÊãΩÁªòÂà∂Âá†‰ΩïÂõæÂΩ¢ÔºåÊîØÊåÅÁÇπ„ÄÅÁ∫ø„ÄÅÂúÜ„ÄÅÂ§öËæπÂΩ¢Á≠âÂ§öÁßçÂΩ¢Áä∂</p>
                            <button onclick="switchTab('geometry')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- Áï™ËåÑÊó∂Èíü -->
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-red-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-clock-o text-2xl text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Áï™ËåÑÊó∂Èíü</h3>
                            <p class="text-gray-600 text-sm mb-4">ÁßëÂ≠¶ÁöÑÊó∂Èó¥ÁÆ°ÁêÜÂ∑•ÂÖ∑ÔºåÂ∏ÆÂä©Â≠¶Áîü‰∏ìÊ≥®Â≠¶‰π†ÔºåÊèêÈ´òÊïàÁéá</p>
                            <button onclick="switchTab('tomato')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Á¨¨‰∫åË°åÔºöÁÆ°ÁêÜÂ∑•ÂÖ∑ -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
                        <i class="fa fa-briefcase text-green-500"></i>
                        ÁÆ°ÁêÜÂ∑•ÂÖ∑
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- ËØæË°®Á®ãÂ∫è -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-green-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-calendar text-2xl text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">ËØæË°®Á®ãÂ∫è</h3>
                            <p class="text-gray-600 text-sm mb-4">Âë®ËØæË°®ÂíåÊúàËÆ°ÂàíÁÆ°ÁêÜÔºåÂèØËßÜÂåñËØæÁ®ãÂÆâÊéíÔºåÊîØÊåÅÂØºÂá∫</p>
                            <button onclick="switchTab('schedule')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- Â≠¶ÁîüÁÆ°ÁêÜ -->
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-orange-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-users text-2xl text-orange-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Â≠¶ÁîüÁÆ°ÁêÜ</h3>
                            <p class="text-gray-600 text-sm mb-4">ÁÆ°ÁêÜÂ≠¶Áîü‰ø°ÊÅØ„ÄÅËØæÊó∂ËøõÂ∫¶„ÄÅËñÑÂº±Áü•ËØÜÁÇπÔºåExcelÂØºÂÖ•ÂØºÂá∫</p>
                            <button onclick="switchTab('students')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- Êî∂ÂÖ•ËÆ∞ÂΩï -->
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-emerald-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-money text-2xl text-emerald-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Êî∂ÂÖ•ËÆ∞ÂΩï</h3>
                            <p class="text-gray-600 text-sm mb-4">Êó•ÂéÜËßÜÂõæËÆ∞ÂΩïÊØèÊó•Êî∂ÂÖ•ÔºåËá™Âä®ÁªüËÆ°ÊúàÂ∫¶ÊÄªÊî∂ÂÖ•</p>
                            <button onclick="switchTab('income')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>

                        <!-- ËØæÂêéÂèçÈ¶à -->
                        <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-2xl p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-cyan-200">
                            <div class="bg-white rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-4 shadow-md">
                                <i class="fa fa-commenting-o text-2xl text-cyan-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">ËØæÂêéÂèçÈ¶à</h3>
                            <p class="text-gray-600 text-sm mb-4">ËÆ∞ÂΩïÊØèËäÇËØæÁöÑÊïôÂ≠¶ÊÉÖÂÜµÔºåÁîüÊàê‰∏ì‰∏öÁöÑËØæÂêéÂèçÈ¶àÊñáÊ°£</p>
                            <button onclick="switchTab('feedback')" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ÂºÄÂßã‰ΩøÁî®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰ºòÂäøÂå∫Âüü -->
        <div class="bg-gray-50 py-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-semibold text-center text-gray-900 mb-16">
                    ‰∏∫‰ªÄ‰πàÈÄâÊã©Êàë‰ª¨ÁöÑÂ∑•ÂÖ∑
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-bolt text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">È´òÊïà‰æøÊç∑</h3>
                        <p class="text-gray-600">‰∏ÄÈîÆÁîüÊàêÊâÄÈúÄÂ∑•ÂÖ∑ÔºåÊó†ÈúÄÂ§çÊùÇËÆæÁΩÆÔºåËäÇÁúÅÊïôÂ∏àÂÆùË¥µÊó∂Èó¥</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-mobile text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">ÂìçÂ∫îÂºèËÆæËÆ°</h3>
                        <p class="text-gray-600">ÈÄÇÈÖçÂêÑÁßçËÆæÂ§áÂ±èÂπïÔºåÈöèÊó∂ÈöèÂú∞‰ΩøÁî®ÔºåÊïôÂ≠¶Êõ¥ÁÅµÊ¥ª</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6">
                            <i class="fa fa-lock text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">ÂÆâÂÖ®ÂèØÈù†</h3>
                        <p class="text-gray-600">Êú¨Âú∞ËøêË°åÔºåÊï∞ÊçÆ‰∏ç‰∏ä‰º†Ôºå‰øùÊä§ÊïôÂ∏àÂíåÂ≠¶ÁîüÁöÑÈöêÁßÅ‰ø°ÊÅØ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®Âå∫Âüü -->
        <div class="bg-gray-900 text-white py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div>
                        <h3 class="text-2xl font-semibold mb-6">Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑</h3>
                        <p class="text-gray-400 mb-6">‰∏∫Êï∞Â≠¶ÊïôÂ∏àÊèê‰æõ‰∏ì‰∏ö„ÄÅÈ´òÊïàÁöÑÊïôÂ≠¶ËæÖÂä©Â∑•ÂÖ∑ÔºåËÆ©ÊïôÂ≠¶Êõ¥ËΩªÊùæÔºåÂ≠¶ÁîüÊõ¥‰∏ìÊ≥®„ÄÇ</p>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-github text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-envelope text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                                <i class="fa fa-weixin text-xl"></i>
                            </a>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-6">Âø´ÈÄüËÆøÈóÆ</h3>
                        <ul class="space-y-3">
                            <li><button onclick="switchTab('answer-sheet')" class="text-gray-400 hover:text-white transition-colors duration-300">Á≠îÈ¢òÂç°ÁîüÊàê</button></li>
                            <li><button onclick="switchTab('tomato')" class="text-gray-400 hover:text-white transition-colors duration-300">Áï™ËåÑÊó∂Èíü</button></li>
                            <li><button onclick="switchTab('schedule')" class="text-gray-400 hover:text-white transition-colors duration-300">ËØæË°®Á®ãÂ∫è</button></li>
                            <li><button onclick="switchTab('function')" class="text-gray-400 hover:text-white transition-colors duration-300">ÂáΩÊï∞ÁªòÂà∂</button></li>
                            <li><button onclick="switchTab('feedback')" class="text-gray-400 hover:text-white transition-colors duration-300">ËØæÂêéÂèçÈ¶à</button></li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-800 mt-12 pt-8 text-center text-gray-500">
                    <p>¬© 2026 Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑. ‰øùÁïôÊâÄÊúâÊùÉÂà©.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Á≠îÈ¢òÂç°ÁîüÊàêÁ®ãÂ∫è -->
    <div class="tab-content" id="answer-sheet">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
            <div class="text-center mt-2 mb-4">
                <span class="text-sm text-gray-500">Âø´Êç∑ÈîÆ: Ctrl+1(‰∏ªÈ°µ) Ctrl+2(Á≠îÈ¢òÂç°) Ctrl+3(Áï™ËåÑÈíü) Ctrl+4(ËØæË°®) Ctrl+5(ÂáΩÊï∞) Esc(ËøîÂõû‰∏ªÈ°µ)</span>
            </div>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- Ê®°ÂùóÈÄâÈ°πÂç° -->
            <div class="flex border-b border-gray-200 mb-6" style="background: var(--card-bg); border-radius: 12px; border-bottom: none; padding: 5px; gap: 5px; box-shadow: var(--shadow);">
                <button id="as-tab-answer-sheet" class="schedule-view-tab active py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchAnswerSheetView('answer-sheet')">
                    üìù Á≠îÈ¢òÂç°ÁîüÊàê
                </button>
                <button id="as-tab-scratch-paper" class="schedule-view-tab py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchAnswerSheetView('scratch-paper')">
                    üìÑ ÊâìËçâÁ∫∏
                </button>
            </div>

            <!-- Á≠îÈ¢òÂç°ÁîüÊàêÊ®°Âùó -->
            <section id="as-module-answer-sheet" class="block">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- Â∑¶‰æßÁ≠îÈ¢òÂç°ËÆæÁΩÆ -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow no-print">
                        <h2>üìù Á≠îÈ¢òÂç°ËÆæÁΩÆ</h2>
                        <div class="as-section">
                            <div class="as-section-title">üìã Âü∫Êú¨‰ø°ÊÅØ</div>
                            <div class="as-form-group">
                                <label>ËÄÉËØïÂêçÁß∞</label>
                                <input type="text" id="examName" value="2025-2026Â≠¶Âπ¥Á¨¨‰∫åÂ≠¶ÊúüÊúü‰∏≠ËÄÉËØï">
                            </div>
                            <div class="as-form-group">
                                <label>ÁßëÁõÆ</label>
                                <input type="text" id="subject" value="Êï∞Â≠¶">
                            </div>
                            <div class="as-form-group">
                                <label>ËÄÉËØïÊó∂Èó¥</label>
                                <input type="text" id="examTime" value="120ÂàÜÈíü">
                            </div>
                            <div class="as-form-group">
                                <label>Êª°ÂàÜ</label>
                                <input type="number" id="fullScore" value="150" min="0">
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">üë§ Â≠¶Áîü‰ø°ÊÅØÊ†è</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showName" checked>
                                <label for="showName" style="margin:0;">ÂßìÂêç</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showClass" checked>
                                <label for="showClass" style="margin:0;">Áè≠Á∫ß</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showExamNo" checked>
                                <label for="showExamNo" style="margin:0;">ËÄÉÂè∑</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showSeatNo">
                                <label for="showSeatNo" style="margin:0;">Â∫ß‰ΩçÂè∑</label>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">üîò ÈÄâÊã©È¢ò</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableMCQ" checked>
                                <label for="enableMCQ" style="margin:0;">ÂêØÁî®ÈÄâÊã©È¢ò</label>
                            </div>
                            <div class="as-form-group">
                                <label>È¢òÊï∞</label>
                                <input type="number" id="mcqCount" value="12" min="0" max="50">
                            </div>
                            <div class="as-form-group">
                                <label>ÊØèÈ¢òÂàÜÂÄº</label>
                                <input type="number" id="mcqScore" value="5" min="0">
                            </div>
                            <div class="as-form-group">
                                <label>ÈÄâÈ°πÊï∞Èáè</label>
                                <select id="mcqOptions">
                                    <option value="4">4‰∏™ÈÄâÈ°πÔºàA/B/C/DÔºâ</option>
                                    <option value="5">5‰∏™ÈÄâÈ°πÔºàA/B/C/D/EÔºâ</option>
                                </select>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">‚úèÔ∏è Â°´Á©∫È¢ò</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableBlank" checked>
                                <label for="enableBlank" style="margin:0;">ÂêØÁî®Â°´Á©∫È¢ò</label>
                            </div>
                            <div class="as-form-group">
                                <label>È¢òÊï∞</label>
                                <input type="number" id="blankCount" value="6" min="0" max="30">
                            </div>
                            <div class="as-form-group">
                                <label>ÊØèÈ¢òÂàÜÂÄº</label>
                                <input type="number" id="blankScore" value="5" min="0">
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">üìê Ëß£Á≠îÈ¢ò</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="enableProblem" checked>
                                <label for="enableProblem" style="margin:0;">ÂêØÁî®Ëß£Á≠îÈ¢ò</label>
                            </div>
                            <div class="as-form-group">
                                <label>È¢òÊï∞</label>
                                <input type="number" id="problemCount" value="6" min="0" max="20">
                            </div>
                            <div class="as-form-group">
                                <label>ÊØèÈ¢òÁ≠îÈ¢òÂå∫ÂüüÈ´òÂ∫¶</label>
                                <select id="problemHeight">
                                    <option value="80">ËæÉÂ∞èÔºà80pxÔºâ</option>
                                    <option value="120" selected>ÈÄÇ‰∏≠Ôºà120pxÔºâ</option>
                                    <option value="180">ËæÉÂ§ßÔºà180pxÔºâ</option>
                                    <option value="250">Ë∂ÖÂ§ßÔºà250pxÔºâ</option>
                                </select>
                            </div>
                        </div>
                        <div class="as-section">
                            <div class="as-section-title">‚öôÔ∏è ÂÖ∂‰ªñËÆæÁΩÆ</div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showNotice" checked>
                                <label for="showNotice" style="margin:0;">ÊòæÁ§∫Ê≥®ÊÑè‰∫ãÈ°π</label>
                            </div>
                            <div class="as-form-group as-checkbox-group">
                                <input type="checkbox" id="showSealArea">
                                <label for="showSealArea" style="margin:0;">ÊòæÁ§∫ÂØÜÂ∞ÅÂå∫</label>
                            </div>
                        </div>
                        <div class="as-btn-group">
                            <button class="as-btn as-btn-primary" onclick="printAnswerSheet()">üñ®Ô∏è ÊâìÂç∞</button>
                            <button class="as-btn as-btn-success" onclick="generateAnswerSheet()">üîÑ Âà∑Êñ∞È¢ÑËßà</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #ff9500 0%, #ff3b30 100%); color: white;" onclick="exportAnswerSheetToPDF()">üìÑ ÂØºÂá∫ PDF</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #5856d6 0%, #af52de 100%); color: white;" onclick="exportAnswerSheetSettings()">üíæ ÂØºÂá∫ËÆæÁΩÆ</button>
                            <button class="as-btn" style="background: linear-gradient(135deg, #00c7be 0%, #34c759 100%); color: white;" onclick="document.getElementById('importSettingsFile').click()">üì• ÂØºÂÖ•ËÆæÁΩÆ</button>
                            <input type="file" id="importSettingsFile" accept=".json" style="display: none;" onchange="handleImportSettings(event)">
                        </div>
                    </div>
                    <!-- Âè≥‰æßÁ≠îÈ¢òÂç°È¢ÑËßà -->
                    <div class="right-panel">
                        <div class="a4-sheet" id="answerSheetContainer">
                            <div style="text-align:center; padding:100px 0; color:#999;">
                                ÁÇπÂáª„ÄåüîÑ Âà∑Êñ∞È¢ÑËßà„ÄçÊåâÈíÆÁîüÊàêÁ≠îÈ¢òÂç°
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÊâìËçâÁ∫∏Ê®°Âùó -->
            <section id="as-module-scratch-paper" class="hidden">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- Â∑¶‰æßÊâìËçâÁ∫∏ËÆæÁΩÆ -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow no-print">
                        <h2>üìÑ ÊâìËçâÁ∫∏ËÆæÁΩÆ</h2>
                        <div class="as-section">
                            <div class="as-section-title">üìù Âü∫Êú¨ËÆæÁΩÆ</div>
                            <div class="as-form-group">
                                <label>Ê®°ÂùóÊï∞ÈáèÔºàÊúÄÂ§ö20‰∏™Ôºâ</label>
                                <input type="number" id="scratchPaperModules" value="2" min="1" max="20">
                            </div>
                            <div class="as-form-group">
                                <label>Ê†áÈ¢ò</label>
                                <input type="text" id="scratchPaperTitle" value="ÊâìËçâÁ∫∏">
                            </div>
                        </div>
                        <div class="as-btn-group">
                            <button class="as-btn as-btn-primary" onclick="printScratchPaper()">üñ®Ô∏è ÊâìÂç∞</button>
                            <button class="as-btn as-btn-success" onclick="generateScratchPaper()">üîÑ Âà∑Êñ∞È¢ÑËßà</button>
                        </div>
                        <div class="as-btn-group" style="margin-top: 10px;">
                            <button class="as-btn" style="background: linear-gradient(135deg, #ff9500 0%, #ff3b30 100%); color: white;" onclick="exportScratchPaperToPDF()">üìÑ ÂØºÂá∫ PDF</button>
                        </div>
                    </div>
                    <!-- Âè≥‰æßÊâìËçâÁ∫∏È¢ÑËßà -->
                    <div class="right-panel">
                        <div class="a4-sheet" id="scratchPaperContainer">
                            <div style="text-align:center; padding:100px 0; color:#999;">
                                ÁÇπÂáª„ÄåüîÑ Âà∑Êñ∞È¢ÑËßà„ÄçÊåâÈíÆÁîüÊàêÊâìËçâÁ∫∏
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Áï™ËåÑÊó∂Èíü -->
    <div class="tab-content" id="tomato">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <div class="tomato-container">
            <div class="tomato-current-time" id="tomatoCurrentTime"></div>
            <div class="tomato-timer-display" id="tomatoTimerDisplay">25:00</div>
            <div class="tomato-mode-selector">
                <button class="tomato-mode-btn active" data-time="1500">Áï™ËåÑÈíü (25ÂàÜÈíü)</button>
                <button class="tomato-mode-btn" data-time="300">Áü≠‰ºëÊÅØ (5ÂàÜÈíü)</button>
                <button class="tomato-mode-btn" data-time="900">Èïø‰ºëÊÅØ (15ÂàÜÈíü)</button>
            </div>
            <div class="tomato-control-buttons">
                <button class="tomato-control-btn" id="tomatoStartBtn">ÂºÄÂßã</button>
                <button class="tomato-control-btn reset" id="tomatoResetBtn">ÈáçÁΩÆ</button>
            </div>
            <div class="tomato-stats">Â∑≤ÂÆåÊàêÁï™ËåÑÈíü: <span id="tomatoCount">0</span></div>
        </div>
    </div>

    <!-- ËØæË°®Á®ãÂ∫è -->
    <div class="tab-content" id="schedule">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <div class="schedule-container-main">
            <div class="schedule-header">
                <h1>üìÖ ËØæË°®Á®ãÂ∫è</h1>
            </div>
            
            <!-- ËØæË°®Á®ãÂ∫èÈÄâÈ°πÂç° -->
            <div class="flex border-b border-gray-200 mb-6" style="background: var(--card-bg); border-radius: 12px; border-bottom: none; padding: 5px; gap: 5px; box-shadow: var(--shadow); margin: 0 20px 20px;">
                <button id="schedule-tab-week" class="schedule-view-tab active py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchScheduleView('week')">
                    üìÜ Âë®ËØæË°®
                </button>
                <button id="schedule-tab-month" class="schedule-view-tab py-3 px-6 text-base cursor-pointer transition-all duration-200 rounded-lg" onclick="switchScheduleView('month')">
                    üóìÔ∏è ÊúàËÆ°Âàí
                </button>
            </div>
            
            <!-- Âë®ËØæË°®Ê®°Âùó -->
            <div id="schedule-module-week">
                <div class="schedule-date-controls">
                    <button onclick="changeWeek(-1)">&lt; ‰∏ä‰∏ÄÂë®</button>
                    <span class="schedule-date-display" id="weekDisplay"></span>
                    <button onclick="changeWeek(1)">‰∏ã‰∏ÄÂë® &gt;</button>
                    <button class="schedule-btn-secondary" onclick="goToThisWeek()">Êú¨Âë®</button>
                </div>
                <div class="schedule-controls-bar">
                    <button class="schedule-btn schedule-btn-success" onclick="addScheduleRow()">‚ûï Ê∑ªÂä†Ë°å</button>
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteScheduleRow()">üóëÔ∏è Âà†Èô§Ë°å</button>
                    <button class="schedule-btn schedule-btn-secondary" onclick="resetSchedule()">üîÑ ÈáçÁΩÆ</button>
                    <button class="schedule-btn" onclick="exportToPDF()">ÂØºÂá∫ PDF</button>
                    <button class="schedule-btn schedule-btn-success" onclick="exportToExcel()">ÂØºÂá∫ Excel</button>
                    <button class="schedule-btn schedule-btn-secondary" onclick="clearAllCourses()">Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
                </div>
                <div class="schedule-table-container" id="scheduleContainer">
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="schedule-time-column">Êó∂Èó¥</th>
                                <th id="header-0">Âë®‰∏Ä<div class="schedule-date-subtitle" id="date-0"></div></th>
                                <th id="header-1">Âë®‰∫å<div class="schedule-date-subtitle" id="date-1"></div></th>
                                <th id="header-2">Âë®‰∏â<div class="schedule-date-subtitle" id="date-2"></div></th>
                                <th id="header-3">Âë®Âõõ<div class="schedule-date-subtitle" id="date-3"></div></th>
                                <th id="header-4">Âë®‰∫î<div class="schedule-date-subtitle" id="date-4"></div></th>
                                <th id="header-5">Âë®ÂÖ≠<div class="schedule-date-subtitle" id="date-5"></div></th>
                                <th id="header-6">Âë®Êó•<div class="schedule-date-subtitle" id="date-6"></div></th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ÊúàËÆ°ÂàíÊ®°Âùó -->
            <div id="schedule-module-month" class="hidden">
                <div class="schedule-date-controls">
                    <button onclick="changeMonth(-1)">&lt; ‰∏äÊúà</button>
                    <span class="schedule-date-display" id="monthDisplay"></span>
                    <button onclick="changeMonth(1)">‰∏ãÊúà &gt;</button>
                    <button class="schedule-btn-secondary" onclick="goToThisMonth()">Êú¨Êúà</button>
                </div>
                <div class="schedule-controls-bar">
                    <button class="schedule-btn schedule-btn-success" onclick="openMonthPlanModal()">‚ûï Ê∑ªÂä†ËÆ°Âàí</button>
                    <button class="schedule-btn" onclick="exportMonthPlanToPDF()">üìÑ ÂØºÂá∫ PDF</button>
                    <button class="schedule-btn schedule-btn-success" onclick="exportMonthPlanToExcel()">üìä ÂØºÂá∫ Excel</button>
                </div>
                <div class="month-plan-layout" style="display: flex; gap: 20px; margin: 0 20px;">
                    <!-- Â∑¶‰æßÊó•ÂéÜ -->
                    <div class="month-calendar-container" id="monthCalendarContainer" style="flex: 1; margin: 0;">
                        <div class="month-calendar" id="monthCalendar">
                        </div>
                    </div>
                    <!-- Âè≥‰æßËÆ°ÂàíËØ¶ÊÉÖ -->
                    <div class="month-plan-detail-panel" id="monthPlanDetail" style="display: none; width: 350px; flex-shrink: 0;">
                        <div style="background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; height: 100%; box-sizing: border-box;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                                <h3 style="font-size: 18px; font-weight: 600; margin: 0;" id="selectedDateTitle"></h3>
                                <button class="schedule-btn schedule-btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="openMonthPlanModal(currentSelectedDate)">‚ûï Ê∑ªÂä†</button>
                            </div>
                            <div class="month-plan-list" id="monthPlanList" style="max-height: 500px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="schedule-modal" id="courseModal">
            <div class="schedule-modal-content">
                <h2 id="modalTitle">Ê∑ªÂä†ËØæÁ®ã</h2>
                <div class="schedule-form-group">
                    <label>ËØæÁ®ãÂêçÁß∞</label>
                    <input type="text" id="courseName" placeholder="ËØ∑ËæìÂÖ•ËØæÁ®ãÂêçÁß∞">
                </div>
                <div class="schedule-form-group">
                    <label>‰∏äËØæÂú∞ÁÇπ</label>
                    <input type="text" id="courseLocation" placeholder="ËØ∑ËæìÂÖ•‰∏äËØæÂú∞ÁÇπ">
                </div>
                <div class="schedule-form-group">
                    <label>ÊïôÂ∏à</label>
                    <input type="text" id="courseTeacher" placeholder="ËØ∑ËæìÂÖ•ÊïôÂ∏àÂßìÂêç">
                </div>
                <div class="schedule-form-group">
                    <label>ÈÄâÊã©È¢úËâ≤</label>
                    <div class="schedule-color-picker" id="colorPicker">
                    </div>
                </div>
                <div class="schedule-modal-buttons">
                    <button class="schedule-btn schedule-btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                    <button class="schedule-btn" onclick="saveCourse()">‰øùÂ≠ò</button>
                </div>
                <div class="schedule-modal-buttons" id="deleteButtonContainer" style="display: none;">
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteCourse()">Âà†Èô§ËØæÁ®ã</button>
                </div>
            </div>
        </div>
        
        <!-- ÊúàËÆ°ÂàíÊ®°ÊÄÅÊ°Ü -->
        <div class="schedule-modal" id="monthPlanModal">
            <div class="schedule-modal-content">
                <h2 id="monthPlanModalTitle">Ê∑ªÂä†ÊúàËÆ°Âàí</h2>
                <div class="schedule-form-group">
                    <label>ËÆ°ÂàíÊ†áÈ¢ò</label>
                    <input type="text" id="monthPlanTitle" placeholder="ËØ∑ËæìÂÖ•ËÆ°ÂàíÊ†áÈ¢ò">
                </div>
                <div class="schedule-form-group">
                    <label>ËÆ°ÂàíÂÜÖÂÆπ</label>
                    <textarea id="monthPlanContent" rows="4" placeholder="ËØ∑ËæìÂÖ•ËÆ°ÂàíÂÜÖÂÆπ" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; resize:vertical;"></textarea>
                </div>
                <div class="schedule-form-group">
                    <label>Êó•Êúü</label>
                    <input type="date" id="monthPlanDate">
                </div>
                <div class="schedule-form-group">
                    <label>ÈÄâÊã©È¢úËâ≤</label>
                    <div class="schedule-color-picker" id="monthPlanColorPicker">
                    </div>
                </div>
                <div class="schedule-modal-buttons">
                    <button class="schedule-btn schedule-btn-secondary" onclick="closeMonthPlanModal()">ÂèñÊ∂à</button>
                    <button class="schedule-btn" onclick="saveMonthPlan()">‰øùÂ≠ò</button>
                </div>
                <div class="schedule-modal-buttons" id="monthPlanDeleteContainer" style="display: none;">
                    <button class="schedule-btn schedule-btn-danger" onclick="deleteMonthPlan()">Âà†Èô§ËÆ°Âàí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êî∂ÂÖ•ËÆ∞ÂΩï -->
    <div class="tab-content" id="income">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- Êúà‰ªΩÂàáÊç¢ -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="changeIncomeMonth(-1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i class="fa fa-chevron-left text-gray-600"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800" id="income-month-title">2025Âπ¥01Êúà</h2>
                <button onclick="changeIncomeMonth(1)" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i class="fa fa-chevron-right text-gray-600"></i>
                </button>
            </div>

            <!-- ÁªüËÆ°Âç°Áâá - ËãπÊûúÈ£éÊ†º -->
            <div class="income-stats-card">
                <div class="income-stat-item">
                    <div class="income-stat-icon blue">
                        <i class="fa fa-clock-o"></i>
                    </div>
                    <div class="income-stat-content">
                        <div class="income-stat-label">ÊÄªËØæÊó∂</div>
                        <div class="income-stat-value" id="income-total-hours">0h</div>
                    </div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-icon green">
                        <i class="fa fa-graduation-cap"></i>
                    </div>
                    <div class="income-stat-content">
                        <div class="income-stat-label">ËØæÊó∂Êî∂ÂÖ•</div>
                        <div class="income-stat-value" id="income-total-amount">0ÂÖÉ</div>
                    </div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-icon orange">
                        <i class="fa fa-plus-circle"></i>
                    </div>
                    <div class="income-stat-content">
                        <div class="income-stat-label">Ë°•Ë¥¥+ÂÖ∂‰ªñ</div>
                        <div class="income-stat-value" id="income-total-bonus">0ÂÖÉ</div>
                    </div>
                </div>
                <div class="income-stat-item">
                    <div class="income-stat-icon teal">
                        <i class="fa fa-yen"></i>
                    </div>
                    <div class="income-stat-content">
                        <div class="income-stat-label">ÊÄªÊî∂ÂÖ•</div>
                        <div class="income-stat-value" id="income-grand-total">0ÂÖÉ</div>
                    </div>
                </div>
            </div>

            <!-- Êó•ÂéÜÁΩëÊ†º -->
            <div class="income-calendar-container">
                <!-- ÊòüÊúüÊ†áÈ¢ò -->
                <div class="income-weekdays">
                    <div class="income-weekday">‰∏Ä</div>
                    <div class="income-weekday">‰∫å</div>
                    <div class="income-weekday">‰∏â</div>
                    <div class="income-weekday">Âõõ</div>
                    <div class="income-weekday">‰∫î</div>
                    <div class="income-weekday income-weekend">ÂÖ≠</div>
                    <div class="income-weekday income-weekend">Êó•</div>
                </div>
                <!-- Êó•ÊúüÁΩëÊ†º -->
                <div class="income-calendar-grid" id="income-calendar-grid">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="flex gap-4 mt-6">
                <button onclick="exportIncomeToExcel()" class="flex-1 py-3 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa fa-file-excel-o"></i>ÂØºÂá∫Excel
                </button>
                <button onclick="showIncomeSettings()" class="flex-1 py-3 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa fa-cog"></i>ËÆæÁΩÆËØæÊó∂Ë¥π
                </button>
            </div>
        </main>

        <!-- Êî∂ÂÖ•ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
        <div class="income-modal" id="income-modal">
            <div class="income-modal-content">
                <div class="income-modal-header">
                    <h3 id="income-modal-title">ËÆ∞ÂΩïÊî∂ÂÖ•</h3>
                    <button onclick="closeIncomeModal()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body">
                    <div class="income-form-group">
                        <label>Êó•Êúü</label>
                        <input type="date" id="income-date" readonly>
                    </div>
                    <div class="income-form-group">
                        <label>Â∑•‰ΩúÊó∂ÈïøÔºàÂ∞èÊó∂Ôºâ</label>
                        <input type="number" id="income-hours" step="0.5" min="0" max="24" placeholder="‰æãÂ¶ÇÔºö2.5">
                    </div>
                    <div class="income-form-group">
                        <label>ËØæÊó∂Ë¥πÂçï‰ª∑ÔºàÂÖÉ/Â∞èÊó∂Ôºâ</label>
                        <input type="number" id="income-rate" step="1" min="0" placeholder="‰æãÂ¶ÇÔºö200">
                    </div>
                    <div class="income-form-group">
                        <label>Ë°•Ë¥¥/ÂÖ∂‰ªñÊî∂ÂÖ•ÔºàÂÖÉÔºâ</label>
                        <input type="number" id="income-bonus" step="1" min="0" placeholder="‰æãÂ¶ÇÔºö100">
                    </div>
                    <div class="income-form-group">
                        <label>Â§áÊ≥®</label>
                        <input type="text" id="income-note" placeholder="‰æãÂ¶ÇÔºöÂàù‰∏âÊï∞Â≠¶‰∏ÄÂØπ‰∏Ä">
                    </div>
                    <div class="income-form-summary">
                        <div class="income-form-summary-item">
                            <span>ËØæÊó∂Êî∂ÂÖ•Ôºö</span>
                            <span id="income-calc-amount">0ÂÖÉ</span>
                        </div>
                        <div class="income-form-summary-item income-form-total">
                            <span>ÂΩìÊó•ÊÄªÊî∂ÂÖ•Ôºö</span>
                            <span id="income-calc-total">0ÂÖÉ</span>
                        </div>
                    </div>
                </div>
                <div class="income-modal-footer">
                    <button onclick="deleteIncomeRecord()" class="income-btn-delete" id="income-btn-delete" style="display:none;">
                        <i class="fa fa-trash"></i>Âà†Èô§
                    </button>
                    <div class="income-modal-actions">
                        <button onclick="closeIncomeModal()" class="income-btn-cancel">ÂèñÊ∂à</button>
                        <button onclick="saveIncomeRecord()" class="income-btn-save">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
        <div class="income-modal" id="income-settings-modal">
            <div class="income-modal-content">
                <div class="income-modal-header">
                    <h3>ËÆæÁΩÆÈªòËÆ§ËØæÊó∂Ë¥π</h3>
                    <button onclick="closeIncomeSettings()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body">
                    <div class="income-form-group">
                        <label>ÈªòËÆ§ËØæÊó∂Ë¥πÂçï‰ª∑ÔºàÂÖÉ/Â∞èÊó∂Ôºâ</label>
                        <input type="number" id="income-default-rate" step="1" min="0" placeholder="‰æãÂ¶ÇÔºö200">
                    </div>
                    <p class="text-sm text-gray-500 mt-2">ËÆæÁΩÆÂêéÔºåÊñ∞Âª∫ËÆ∞ÂΩïÊó∂Â∞ÜËá™Âä®Â°´ÂÖÖÊ≠§Âçï‰ª∑</p>
                </div>
                <div class="income-modal-footer">
                    <button onclick="closeIncomeSettings()" class="income-btn-cancel">ÂèñÊ∂à</button>
                    <button onclick="saveIncomeSettings()" class="income-btn-save">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Â≠¶ÁîüÁÆ°ÁêÜ -->
    <div class="tab-content" id="students">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- ÁªüËÆ°Âç°Áâá - ËãπÊûúÈ£éÊ†º -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center">
                            <i class="fa fa-users text-blue-500 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-gray-900" id="student-total-count">0</div>
                            <div class="text-xs text-gray-500">Â≠¶ÁîüÊÄªÊï∞</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-green-50 flex items-center justify-center">
                            <i class="fa fa-user-check text-green-500 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-gray-900" id="student-active-count">0</div>
                            <div class="text-xs text-gray-500">Âú®ËØªÂ≠¶Áîü</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center">
                            <i class="fa fa-clock-o text-orange-500 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-gray-900" id="student-total-hours">0</div>
                            <div class="text-xs text-gray-500">Á¥ØËÆ°ËØæÊó∂</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center">
                            <i class="fa fa-yen text-purple-500 text-lg"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-semibold text-gray-900" id="student-total-income">0</div>
                            <div class="text-xs text-gray-500">Á¥ØËÆ°Êî∂ÂÖ•</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊ†è - ËãπÊûúÈ£éÊ†º -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button onclick="openStudentModal()" class="apple-btn apple-btn-primary">
                    <i class="fa fa-plus"></i>Ê∑ªÂä†Â≠¶Áîü
                </button>
                <button onclick="exportStudentsData()" class="apple-btn apple-btn-secondary">
                    <i class="fa fa-download"></i>ÂØºÂá∫
                </button>
                <button onclick="importStudentsData()" class="apple-btn apple-btn-secondary">
                    <i class="fa fa-upload"></i>ÂØºÂÖ•
                </button>
                <input type="file" id="student-import-file" accept=".xlsx,.xls" style="display:none" onchange="handleStudentImport(event)">
            </div>

            <!-- Â≠¶ÁîüÂàóË°® -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">Â≠¶ÁîüÂàóË°®</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">Â≠¶Áîü‰ø°ÊÅØ</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-600">Âπ¥Á∫ß/Â≠¶Ê†°</th>
                                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-600">ËØæÊó∂ÊÉÖÂÜµ</th>
                                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-600">ËØæÊó∂Ë¥π</th>
                                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-600">Áä∂ÊÄÅ</th>
                                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-600">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body" class="divide-y divide-gray-100">
                            <!-- Âä®ÊÄÅÁîüÊàê -->
                        </tbody>
                    </table>
                </div>
                <div id="student-empty-state" class="hidden py-12 text-center text-gray-500">
                    <i class="fa fa-users text-4xl mb-4 text-gray-300"></i>
                    <p>ÊöÇÊó†Â≠¶ÁîüÔºåÁÇπÂáª"Ê∑ªÂä†Â≠¶Áîü"ÂºÄÂßãÁÆ°ÁêÜ</p>
                </div>
            </div>
        </main>

        <!-- Â≠¶Áîü‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
        <div class="income-modal" id="student-modal">
            <div class="income-modal-content" style="max-width: 500px;">
                <div class="income-modal-header">
                    <h3 id="student-modal-title">Ê∑ªÂä†Â≠¶Áîü</h3>
                    <button onclick="closeStudentModal()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body">
                    <input type="hidden" id="student-id">
                    <div class="income-form-group">
                        <label>Â≠¶ÁîüÂßìÂêç <span class="text-red-500">*</span></label>
                        <input type="text" id="student-name" placeholder="ËØ∑ËæìÂÖ•Â≠¶ÁîüÂßìÂêç">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="income-form-group">
                            <label>Âπ¥Á∫ß</label>
                            <select id="student-grade" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg">
                                <option value="">ËØ∑ÈÄâÊã©</option>
                                <option value="Âàù‰∏Ä">Âàù‰∏Ä</option>
                                <option value="Âàù‰∫å">Âàù‰∫å</option>
                                <option value="Âàù‰∏â">Âàù‰∏â</option>
                                <option value="È´ò‰∏Ä">È´ò‰∏Ä</option>
                                <option value="È´ò‰∫å">È´ò‰∫å</option>
                                <option value="È´ò‰∏â">È´ò‰∏â</option>
                                <option value="Â∞èÂ≠¶">Â∞èÂ≠¶</option>
                                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                        <div class="income-form-group">
                            <label>Â≠¶Ê†°</label>
                            <input type="text" id="student-school" placeholder="Â≠¶Ê†°ÂêçÁß∞">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="income-form-group">
                            <label>ÊÄªËØæÊó∂</label>
                            <input type="number" id="student-total-hours-input" step="1" min="0" placeholder="0">
                        </div>
                        <div class="income-form-group">
                            <label>Â∑≤‰∏äËØæÊó∂</label>
                            <input type="number" id="student-used-hours" step="0.5" min="0" placeholder="0">
                        </div>
                    </div>
                    <div class="income-form-group">
                        <label>ËØæÊó∂Ë¥πÂçï‰ª∑ÔºàÂÖÉ/Â∞èÊó∂Ôºâ</label>
                        <input type="number" id="student-hourly-rate" step="10" min="0" placeholder="200">
                    </div>
                    <div class="income-form-group">
                        <label>ËÅîÁ≥ªÁîµËØù</label>
                        <input type="tel" id="student-phone" placeholder="ÂÆ∂ÈïøÊàñÂ≠¶ÁîüÁîµËØù">
                    </div>
                    <div class="income-form-group">
                        <label>ËñÑÂº±Áü•ËØÜÁÇπ</label>
                        <input type="text" id="student-weak-points" placeholder="‰æãÂ¶ÇÔºö‰∫åÊ¨°ÂáΩÊï∞„ÄÅÂá†‰ΩïËØÅÊòé">
                    </div>
                    <div class="income-form-group">
                        <label>Â§áÊ≥®</label>
                        <textarea id="student-notes" rows="3" placeholder="ÂÖ∂‰ªñÈúÄË¶ÅËÆ∞ÂΩïÁöÑ‰ø°ÊÅØ"></textarea>
                    </div>
                    <div class="income-form-group">
                        <label>Áä∂ÊÄÅ</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="student-status" value="active" checked>
                                <span>Âú®ËØª</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="student-status" value="paused">
                                <span>ÊöÇÂÅú</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="student-status" value="graduated">
                                <span>ÁªìËØæ</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="income-modal-footer">
                    <button onclick="deleteStudent()" class="income-btn-delete" id="student-btn-delete" style="display:none;">
                        <i class="fa fa-trash"></i>Âà†Èô§
                    </button>
                    <div class="income-modal-actions">
                        <button onclick="closeStudentModal()" class="income-btn-cancel">ÂèñÊ∂à</button>
                        <button onclick="saveStudent()" class="income-btn-save">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â≠¶ÁîüËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
        <div class="income-modal" id="student-detail-modal">
            <div class="income-modal-content" style="max-width: 600px;">
                <div class="income-modal-header">
                    <h3>Â≠¶ÁîüËØ¶ÊÉÖ</h3>
                    <button onclick="closeStudentDetailModal()" class="income-modal-close">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="income-modal-body" id="student-detail-content">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="income-modal-footer">
                    <button onclick="editCurrentStudent()" class="income-btn-save">
                        <i class="fa fa-edit"></i>ÁºñËæë‰ø°ÊÅØ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ËØæÂêéÂèçÈ¶à -->
    <div class="tab-content" id="feedback">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <div class="max-w-4xl mx-auto">
                <!-- È°µÈù¢Ê†áÈ¢ò -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">ËØæÂêéÂèçÈ¶à</h1>
                    <p class="text-gray-600">ËÆ∞ÂΩïÊØèËäÇËØæÁöÑÊïôÂ≠¶ÊÉÖÂÜµÔºåÁîüÊàê‰∏ì‰∏öÁöÑËØæÂêéÂèçÈ¶à</p>
                </div>

                <!-- ÂèçÈ¶àË°®Âçï -->
                <div class="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                        <i class="fa fa-edit text-blue-500"></i>
                        Â°´ÂÜôÂèçÈ¶à
                    </h2>
                    
                    <form id="feedbackForm" class="space-y-6">
                        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Â≠¶ÁîüÂßìÂêç</label>
                                <input type="text" id="feedbackStudentName" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500" placeholder="ËØ∑ËæìÂÖ•Â≠¶ÁîüÂßìÂêç">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ËØæÁ®ãÊó•Êúü</label>
                                <input type="date" id="feedbackDate" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÁßëÁõÆ</label>
                                <select id="feedbackSubject" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="">ËØ∑ÈÄâÊã©ÁßëÁõÆ</option>
                                    <option value="Êï∞Â≠¶">Êï∞Â≠¶</option>
                                    <option value="ËØ≠Êñá">ËØ≠Êñá</option>
                                    <option value="Ëã±ËØ≠">Ëã±ËØ≠</option>
                                    <option value="Áâ©ÁêÜ">Áâ©ÁêÜ</option>
                                    <option value="ÂåñÂ≠¶">ÂåñÂ≠¶</option>
                                    <option value="ÁîüÁâ©">ÁîüÁâ©</option>
                                    <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ËØæÊó∂</label>
                                <input type="number" id="feedbackDuration" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500" placeholder="ËØæÊó∂ÔºàÂ∞èÊó∂Ôºâ" step="0.5" min="0.5">
                            </div>
                        </div>

                        <!-- ÊïôÂ≠¶ÂÜÖÂÆπ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Êú¨Ê¨°ÊïôÂ≠¶ÂÜÖÂÆπ</label>
                            <textarea id="feedbackContent" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑ÊèèËø∞Êú¨Ê¨°ËØæÊïôÊéàÁöÑ‰∏ªË¶ÅÂÜÖÂÆπ..."></textarea>
                        </div>

                        <!-- Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ</label>
                            <textarea id="feedbackUnderstanding" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑ÊèèËø∞Â≠¶ÁîüÂØπÁü•ËØÜÁÇπÁöÑÊéåÊè°ÊÉÖÂÜµ..."></textarea>
                        </div>

                        <!-- Â≠òÂú®ÈóÆÈ¢ò -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Â≠òÂú®ÈóÆÈ¢ò</label>
                            <textarea id="feedbackIssues" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑ÊèèËø∞Â≠¶ÁîüÂú®Â≠¶‰π†‰∏≠Â≠òÂú®ÁöÑÈóÆÈ¢òÔºàÂèØÈÄâÔºâ..."></textarea>
                        </div>

                        <!-- ËØæÂêé‰Ωú‰∏ö -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËØæÂêé‰Ωú‰∏ö</label>
                            <textarea id="feedbackHomework" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑Â∏ÉÁΩÆËØæÂêé‰Ωú‰∏öÔºàÂèØÈÄâÔºâ..."></textarea>
                        </div>

                        <!-- ‰∏ãËäÇËØæËÆ°Âàí -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ãËäÇËØæËÆ°Âàí</label>
                            <textarea id="feedbackNextPlan" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑ÊèèËø∞‰∏ãËäÇËØæÁöÑÊïôÂ≠¶ËÆ°ÂàíÔºàÂèØÈÄâÔºâ..."></textarea>
                        </div>

                        <!-- ËÄÅÂ∏àËØÑËØ≠ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËÄÅÂ∏àËØÑËØ≠</label>
                            <textarea id="feedbackComment" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 resize-none" placeholder="ËØ∑ÁªôÂá∫ÁªºÂêàËØÑËØ≠..."></textarea>
                        </div>

                        <!-- ÊåâÈíÆ -->
                        <div class="flex gap-4 pt-4">
                            <button type="button" onclick="saveFeedback()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors">
                                <i class="fa fa-save mr-2"></i>‰øùÂ≠òÂèçÈ¶à
                            </button>
                            <button type="button" onclick="previewFeedback()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                                <i class="fa fa-eye mr-2"></i>È¢ÑËßà
                            </button>
                            <button type="button" onclick="copyFeedback()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 transition-colors">
                                <i class="fa fa-copy mr-2"></i>Â§çÂà∂ÊñáÊú¨
                            </button>
                        </div>

                        <!-- ÂØºÂá∫ÊåâÈíÆ -->
                        <div class="flex gap-4 pt-2">
                            <button type="button" onclick="exportFeedbackToWord()" class="flex-1 bg-indigo-500 text-white py-3 rounded-lg font-medium hover:bg-indigo-600 transition-colors">
                                <i class="fa fa-file-word-o mr-2"></i>ÂØºÂá∫Word
                            </button>
                            <button type="button" onclick="exportFeedbackToExcel()" class="flex-1 bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600 transition-colors">
                                <i class="fa fa-file-excel-o mr-2"></i>ÂØºÂá∫Excel
                            </button>
                            <button type="button" onclick="exportAllFeedbackToExcel()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                                <i class="fa fa-download mr-2"></i>ÂØºÂá∫ÂÖ®ÈÉ®
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ÂéÜÂè≤ÂèçÈ¶àÂàóË°® -->
                <div class="bg-white rounded-2xl p-6 md:p-8 shadow-sm border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                        <i class="fa fa-history text-blue-500"></i>
                        ÂéÜÂè≤ÂèçÈ¶à
                    </h2>
                    <div id="feedbackHistoryList" class="space-y-4">
                        <!-- Âä®ÊÄÅÁîüÊàê -->
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa fa-inbox text-4xl mb-2"></i>
                            <p>ÊöÇÊó†ÂèçÈ¶àËÆ∞ÂΩï</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ÂèçÈ¶àÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div id="feedbackPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">ËØæÂêéÂèçÈ¶àÈ¢ÑËßà</h3>
                <button onclick="closeFeedbackPreview()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="feedbackPreviewContent" class="prose max-w-none">
                <!-- È¢ÑËßàÂÜÖÂÆπ -->
            </div>
            <div class="mt-6 flex gap-4">
                <button onclick="copyFeedbackFromPreview()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 transition-colors">
                    <i class="fa fa-copy mr-2"></i>Â§çÂà∂ÂèçÈ¶à
                </button>
                <button onclick="closeFeedbackPreview()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                    ÂÖ≥Èó≠
                </button>
            </div>
        </div>
    </div>

    <!-- ÂáΩÊï∞ÁªòÂà∂Á®ãÂ∫è -->
    <div class="tab-content" id="function">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <!-- Ê®°ÂùóÈÄâÈ°πÂç° -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="tab-graph" class="tab-active py-3 px-4 md:px-6 text-base md:text-lg cursor-pointer transition-all duration-200">ÂáΩÊï∞ÂõæÂÉèÁªòÂà∂</button>
                <button id="tab-equation" class="py-3 px-4 md:px-6 text-base md:text-lg text-light hover:text-primary cursor-pointer transition-all duration-200">ÊñπÁ®ãÔºàÁªÑÔºâÊ±ÇËß£</button>
            </div>

            <!-- ÂáΩÊï∞ÂõæÂÉèÁªòÂà∂Ê®°Âùó -->
            <section id="module-graph" class="block">
                <div class="force-horizontal gap-6 md:gap-8">
                    <!-- Â∑¶‰æßÂèÇÊï∞ËÆæÁΩÆÂå∫Âüü -->
                    <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                        <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fa fa-line-chart text-primary"></i>ÂáΩÊï∞ÂèÇÊï∞ËÆæÁΩÆ
                        </h2>
                        
                        <!-- ÂõæÂÉèÁªòÂà∂ËåÉÂõ¥ËÆæÁΩÆ -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-md">
                            <h3 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                <i class="fa fa-expand text-primary"></i> ÂõæÂÉèÁªòÂà∂ËåÉÂõ¥Ôºà‰ªÖÈôêÊú¨Ê¨°ÁªòÂà∂Ôºâ
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">XËµ∑ÂßãÂÄº</label>
                                    <input type="number" id="x-start" value="-10" step="1" class="w-full input-apple">
                                    <input type="range" id="x-start-slider" min="-20" max="10" value="-10" step="1" class="w-full mt-2">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">XÁªìÊùüÂÄº</label>
                                    <input type="number" id="x-end" value="10" step="1" class="w-full input-apple">
                                    <input type="range" id="x-end-slider" min="-10" max="20" value="10" step="1" class="w-full mt-2">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">‰ªÖÊéßÂà∂Êú¨Ê¨°ÂáΩÊï∞ÂõæÂÉèÁöÑÁªòÂà∂ËåÉÂõ¥Ôºå‰∏çÂΩ±ÂìçÂùêÊ†áËΩ¥ËåÉÂõ¥</p>
                        </div>
                        
                        <!-- ÂáΩÊï∞Á±ªÂûãÈÄâÊã© -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©ÂáΩÊï∞Á±ªÂûã</label>
                            <select id="function-type" class="w-full input-apple">
                                <option value="direct">Ê≠£ÊØî‰æãÂáΩÊï∞ (y = kx)</option>
                                <option value="linear">‰∏ÄÊ¨°ÂáΩÊï∞ (y = kx + b)</option>
                                <option value="quadratic">‰∫åÊ¨°ÂáΩÊï∞ (y = ax¬≤ + bx + c)</option>
                                <option value="hyperbola">ÂèçÊØî‰æãÂáΩÊï∞ÔºàÂèåÊõ≤Á∫øÔºâ(y = k/x)</option>
                                <option value="power">ÂπÇÂáΩÊï∞ (y = x‚Åø)</option>
                                <option value="exponential">ÊåáÊï∞ÂáΩÊï∞ (y = aÀ£)</option>
                                <option value="logarithmic">ÂØπÊï∞ÂáΩÊï∞ (y = log‚Çêx)</option>
                                <option value="sine">Ê≠£Âº¶ÂáΩÊï∞ (y = A sin(œâx + œÜ) + d)</option>
                                <option value="cosine">‰ΩôÂº¶ÂáΩÊï∞ (y = A cos(œâx + œÜ) + d)</option>
                                <option value="ellipse">Ê§≠ÂúÜ (x¬≤/a¬≤ + y¬≤/b¬≤ = 1)</option>
                                <option value="conic-hyperbola">ÂúÜÈî•Êõ≤Á∫øÂèåÊõ≤Á∫ø (x¬≤/a¬≤ - y¬≤/b¬≤ = 1)</option>
                            </select>
                        </div>

                        <!-- Á≥ªÊï∞ËæìÂÖ•Ê°Ü - Âä®ÊÄÅÊòæÁ§∫ -->
                        <div id="coefficient-inputs" class="space-y-3 mb-5">
                            <!-- Ê≠£ÊØî‰æãÂáΩÊï∞ -->
                            <div id="coeff-direct" class="block space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">kÔºàÊØî‰æãÁ≥ªÊï∞Ôºåk‚â†0Ôºâ</label>
                                    <input type="number" id="k-direct" value="1" step="0.5" class="w-full input-apple">
                                    <input type="range" id="k-direct-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = kx</div>
                            </div>
                            <!-- ‰∏ÄÊ¨°ÂáΩÊï∞ -->
                            <div id="coeff-linear" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">kÔºàÊñúÁéáÔºåk‚â†0Ôºâ</label>
                                        <input type="number" id="k" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="k-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bÔºàÊà™Ë∑ùÔºâ</label>
                                        <input type="number" id="b" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="b-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = kx + b</div>
                            </div>
                            <!-- ‰∫åÊ¨°ÂáΩÊï∞ -->
                            <div id="coeff-quadratic" class="hidden space-y-3">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">a (a‚â†0)</label>
                                        <input type="number" id="a" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="a-slider" min="-5" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="bq" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="bq-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">c</label>
                                        <input type="number" id="c" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="c-slider" min="-10" max="10" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = ax¬≤ + bx + c</div>
                            </div>
                            <!-- ÂèçÊØî‰æãÂáΩÊï∞ -->
                            <div id="coeff-hyperbola" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">kÔºàk‚â†0Ôºâ</label>
                                    <input type="number" id="kh" value="1" step="0.5" class="w-full input-apple">
                                    <input type="range" id="kh-slider" min="-10" max="10" value="1" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = k/xÔºàÂèåÊõ≤Á∫øÔºåËá™Âä®ÁªòÂà∂ÂÆåÊï¥Â∑¶Âè≥ÂàÜÊîØÔºâ</div>
                            </div>
                            <!-- ÂπÇÂáΩÊï∞ -->
                            <div id="coeff-power" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">nÔºàÊåáÊï∞ÔºåÂÆûÊï∞Ôºâ</label>
                                    <input type="number" id="n" value="2" step="0.5" class="w-full input-apple">
                                    <input type="range" id="n-slider" min="-3" max="5" value="2" step="0.5" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = x‚ÅøÔºàÂàùÈ´ò‰∏≠Â∏∏Áî®n=1,2,3,1/2,-1Á≠âÔºâ</div>
                            </div>
                            <!-- ÊåáÊï∞ÂáΩÊï∞ -->
                            <div id="coeff-exponential" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">aÔºàÂ∫ïÊï∞Ôºåa>0‰∏îa‚â†1Ôºâ</label>
                                    <input type="number" id="a-exp" value="2" step="0.1" min="0.1" max="10" class="w-full input-apple">
                                    <input type="range" id="a-exp-slider" min="0.1" max="10" value="2" step="0.1" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = aÀ£Ôºàa>0Ôºåa‚â†1ÔºåÂÆö‰πâÂüüRÔºåÂÄºÂüü(0,+‚àû)Ôºâ</div>
                            </div>
                            <!-- ÂØπÊï∞ÂáΩÊï∞ -->
                            <div id="coeff-logarithmic" class="hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">aÔºàÂ∫ïÊï∞Ôºåa>0‰∏îa‚â†1Ôºâ</label>
                                    <input type="number" id="a-log" value="10" step="0.1" min="0.1" max="10" class="w-full input-apple">
                                    <input type="range" id="a-log-slider" min="0.1" max="10" value="10" step="0.1" class="w-full mt-2">
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = log‚ÇêxÔºàa>0Ôºåa‚â†1ÔºåÂÆö‰πâÂüü(0,+‚àû)ÔºåÂÄºÂüüRÔºâ</div>
                            </div>
                            <!-- Ê§≠ÂúÜ -->
                            <div id="coeff-ellipse" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aÔºàÈïøÂçäËΩ¥Ôºåa>0Ôºâ</label>
                                        <input type="number" id="a-ellipse" value="3" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="a-ellipse-slider" min="0.1" max="10" value="3" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bÔºàÁü≠ÂçäËΩ¥Ôºåb>0Ôºâ</label>
                                        <input type="number" id="b-ellipse" value="2" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="b-ellipse-slider" min="0.1" max="10" value="2" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöx¬≤/a¬≤ + y¬≤/b¬≤ = 1Ôºà‰∏≠ÂøÉÂú®ÂéüÁÇπÁöÑÊ§≠ÂúÜÔºâ</div>
                            </div>
                            <!-- ÂúÜÈî•Êõ≤Á∫øÂèåÊõ≤Á∫ø -->
                            <div id="coeff-conic-hyperbola" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aÔºàÂÆûÂçäËΩ¥Ôºåa>0Ôºâ</label>
                                        <input type="number" id="a-hyperbola" value="2" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="a-hyperbola-slider" min="0.1" max="10" value="2" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">bÔºàËôöÂçäËΩ¥Ôºåb>0Ôºâ</label>
                                        <input type="number" id="b-hyperbola" value="1" step="0.5" min="0.1" class="w-full input-apple">
                                        <input type="range" id="b-hyperbola-slider" min="0.1" max="10" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöx¬≤/a¬≤ - y¬≤/b¬≤ = 1Ôºà‰∏≠ÂøÉÂú®ÂéüÁÇπÁöÑÂèåÊõ≤Á∫øÔºâ</div>
                            </div>
                            <!-- Ê≠£Âº¶ÂáΩÊï∞ - Â¢ûÂº∫Áâà -->
                            <div id="coeff-sine" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">AÔºàÊåØÂπÖÔºâ</label>
                                        <input type="number" id="A-sin" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="A-sin-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">œâÔºàËßíÈ¢ëÁéáÔºâ</label>
                                        <input type="number" id="w-sin" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="w-sin-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">œÜÔºàÁõ∏‰ΩçÔºåÂºßÂ∫¶Ôºâ</label>
                                        <input type="number" id="phi-sin" value="0" step="0.1" class="w-full input-apple">
                                        <input type="range" id="phi-sin-slider" min="-6.28" max="6.28" value="0" step="0.1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">dÔºàÂûÇÁõ¥‰ΩçÁßªÔºâ</label>
                                        <input type="number" id="d-sin" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="d-sin-slider" min="-5" max="5" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = A sin(œâx + œÜ) + dÔºàÂë®ÊúüT=2œÄ/|œâ|Ôºâ</div>
                            </div>
                            <!-- ‰ΩôÂº¶ÂáΩÊï∞ - Â¢ûÂº∫Áâà -->
                            <div id="coeff-cosine" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">AÔºàÊåØÂπÖÔºâ</label>
                                        <input type="number" id="A-cos" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="A-cos-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">œâÔºàËßíÈ¢ëÁéáÔºâ</label>
                                        <input type="number" id="w-cos" value="1" step="0.5" class="w-full input-apple">
                                        <input type="range" id="w-cos-slider" min="0.1" max="5" value="1" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">œÜÔºàÁõ∏‰ΩçÔºåÂºßÂ∫¶Ôºâ</label>
                                        <input type="number" id="phi-cos" value="0" step="0.1" class="w-full input-apple">
                                        <input type="range" id="phi-cos-slider" min="-6.28" max="6.28" value="0" step="0.1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">dÔºàÂûÇÁõ¥‰ΩçÁßªÔºâ</label>
                                        <input type="number" id="d-cos" value="0" step="0.5" class="w-full input-apple">
                                        <input type="range" id="d-cos-slider" min="-5" max="5" value="0" step="0.5" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÂáΩÊï∞ÂΩ¢ÂºèÔºöy = A cos(œâx + œÜ) + dÔºàÂë®ÊúüT=2œÄ/|œâ|Ôºâ</div>
                            </div>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                        <div class="flex gap-2 md:gap-3 mb-3">
                            <button id="draw-graph" class="flex-1 bg-primary text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                                <i class="fa fa-paint-brush"></i> Ê∑ªÂä†ÂõæÂÉè
                            </button>
                            <button id="reset-graph" class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                                <i class="fa fa-refresh"></i> Ê∏ÖÁ©∫ÊâÄÊúâ
                            </button>
                        </div>
                        
                        <button id="export-pdf" class="w-full mb-3 bg-warning text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1">
                            <i class="fa fa-file-pdf-o"></i> ÂØºÂá∫PDF
                        </button>
                        
                        <!-- ÂáΩÊï∞Ê†áÁ≠æÊ†è -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h3 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                <i class="fa fa-tags text-primary"></i> Â∑≤ÁªòÂà∂ÂáΩÊï∞
                            </h3>
                            <div id="function-tags" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">
                                <span class="text-xs text-gray-500">ÊöÇÊó†ÂáΩÊï∞</span>
                            </div>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3"><i class="fa fa-info-circle text-primary"></i> ÁîªÂ∏ÉÊîØÊåÅÔºöÊªëËΩÆÁº©Êîæ | ÂÆûÊó∂ÂùêÊ†á | Â§öÂõæÂà†Èô§</p>
                    </div>

                    <!-- Âè≥‰æßÁªòÂõæÂå∫Âüü -->
                    <div class="right-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                        <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                            <i class="fa fa-square-o text-primary"></i>ÂáΩÊï∞ÂõæÂÉèÁîªÂ∏É
                        </h2>
                        
                        <!-- ÂÆûÊó∂ÂùêÊ†áÊèêÁ§∫Ê°Ü -->
                        <div id="coord-tooltip" class="coord-tooltip hidden" style="top: 0; left: 0;">(x, y) = (0.0, 0.0)</div>
                        
                        <!-- ÁîªÂ∏ÉÂÆπÂô® -->
                        <div class="relative w-full chart-height overflow-hidden rounded-md border border-gray-200" id="chart-container">
                            <canvas id="function-chart" class="w-full h-full"></canvas>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2 text-center">ÊèêÁ§∫ÔºöÂèåÊõ≤Á∫øËá™Âä®ÁªòÂà∂ÂÆåÊï¥ÂàÜÊîØÔºõ‰∏âËßíÂáΩÊï∞ÊòæÁ§∫2‰∏™Âë®ÊúüÔºõÂõæÂÉèÈ¢úËâ≤‰∏çÈáçÂ§ç</p>
                    </div>
                </div>
            </section>

            <!-- 2. ÊñπÁ®ãÔºàÁªÑÔºâÊ±ÇËß£Ê®°Âùó -->
            <section id="module-equation" class="hidden">
                <div class="bg-white rounded-xl p-4 md:p-6 card-shadow">
                    <!-- ÊñπÁ®ãÁ±ªÂûãÂ≠êÈÄâÈ°πÂç° -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="tab-single" class="tab-active py-3 px-4 md:px-6 text-sm md:text-base cursor-pointer transition-all duration-200">‰∏ÄÂÖÉÊñπÁ®ãÔºà‰∏ÄÊ¨°/‰∫åÊ¨°Ôºâ</button>
                        <button id="tab-system" class="py-3 px-4 md:px-6 text-sm md:text-base text-light hover:text-primary cursor-pointer transition-all duration-200">‰∫åÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁªÑ</button>
                    </div>

                    <div class="force-horizontal gap-6 md:gap-8">
                        <!-- Â∑¶‰æßËæìÂÖ•Âå∫Âüü -->
                        <div class="left-panel">
                            <!-- ‰∏ÄÂÖÉÊñπÁ®ãËæìÂÖ• -->
                            <div id="single-equation" class="block">
                                <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                    <i class="fa fa-pencil text-primary"></i>‰∏ÄÂÖÉÊñπÁ®ãÂèÇÊï∞
                                </h2>
                                <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©ÊñπÁ®ãÁ±ªÂûã</label>
                            <select id="single-type" class="w-full input-apple">
                                    <option value="one">‰∏ÄÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ã (ax + b = 0)</option>
                                    <option value="two">‰∏ÄÂÖÉ‰∫åÊ¨°ÊñπÁ®ã (ax¬≤ + bx + c = 0)</option>
                                </select>
                                </div>
                                <!-- ‰∏ÄÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁ≥ªÊï∞ -->
                            <div id="single-one-coeff" class="block space-y-3 mb-5">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aÔºàa‚â†0Ôºâ</label>
                                        <input type="number" id="sa1" value="2" step="1" class="w-full input-apple">
                                        <input type="range" id="sa1-slider" min="-10" max="10" value="2" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="sb1" value="4" step="1" class="w-full input-apple">
                                        <input type="range" id="sb1-slider" min="-20" max="20" value="4" step="1" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÊñπÁ®ãÂΩ¢ÂºèÔºöax + b = 0</div>
                            </div>
                            <!-- ‰∏ÄÂÖÉ‰∫åÊ¨°ÊñπÁ®ãÁ≥ªÊï∞ -->
                            <div id="single-two-coeff" class="hidden space-y-3 mb-5">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">aÔºàa‚â†0Ôºâ</label>
                                        <input type="number" id="sa2" value="1" step="1" class="w-full input-apple">
                                        <input type="range" id="sa2-slider" min="-5" max="5" value="1" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">b</label>
                                        <input type="number" id="sb2" value="-3" step="1" class="w-full input-apple">
                                        <input type="range" id="sb2-slider" min="-10" max="10" value="-3" step="1" class="w-full mt-2">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">c</label>
                                        <input type="number" id="sc2" value="2" step="1" class="w-full input-apple">
                                        <input type="range" id="sc2-slider" min="-10" max="10" value="2" step="1" class="w-full mt-2">
                                    </div>
                                </div>
                                <div class="text-center text-sm text-gray-500">ÊñπÁ®ãÂΩ¢ÂºèÔºöax¬≤ + bx + c = 0</div>
                            </div>
                            </div>

                            <!-- ‰∫åÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁªÑËæìÂÖ• -->
                            <div id="system-equation" class="hidden">
                                <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                    <i class="fa fa-pencil-square-o text-primary"></i>‰∫åÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁªÑÂèÇÊï∞
                                </h2>
                                <div class="space-y-3 mb-5">
                                    <div class="p-3 border border-gray-200 rounded-xl">
                                        <p class="text-sm font-medium mb-2">ÊñπÁ®ã‚ë†Ôºöa‚ÇÅx + b‚ÇÅy = c‚ÇÅ</p>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <input type="number" id="a1" value="1" step="1" placeholder="a‚ÇÅ" class="w-full input-apple">
                                                <input type="range" id="a1-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="b1" value="1" step="1" placeholder="b‚ÇÅ" class="w-full input-apple">
                                                <input type="range" id="b1-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="c1" value="3" step="1" placeholder="c‚ÇÅ" class="w-full input-apple">
                                                <input type="range" id="c1-slider" min="-20" max="20" value="3" step="1" class="w-full mt-2">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 border border-gray-200 rounded-xl">
                                        <p class="text-sm font-medium mb-2">ÊñπÁ®ã‚ë°Ôºöa‚ÇÇx + b‚ÇÇy = c‚ÇÇ</p>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <input type="number" id="a2" value="1" step="1" placeholder="a‚ÇÇ" class="w-full input-apple">
                                                <input type="range" id="a2-slider" min="-10" max="10" value="1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="b2" value="-1" step="1" placeholder="b‚ÇÇ" class="w-full input-apple">
                                                <input type="range" id="b2-slider" min="-10" max="10" value="-1" step="1" class="w-full mt-2">
                                            </div>
                                            <div>
                                                <input type="number" id="c2" value="1" step="1" placeholder="c‚ÇÇ" class="w-full input-apple">
                                                <input type="range" id="c2-slider" min="-20" max="20" value="1" step="1" class="w-full mt-2">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500"><i class="fa fa-info-circle text-primary"></i> Ëß£È¢òÊ≠•È™§ÈááÁî®‰∏≠Â≠¶ËØæÊú¨„ÄåÂä†ÂáèÊ∂àÂÖÉÊ≥ï„Äç</p>
                            </div>

                            <!-- Ê±ÇËß£ÊåâÈíÆ -->
                            <button id="solve-equation" class="w-full mt-4 bg-primary text-white py-2 px-3 rounded-lg btn-apple btn-hover flex items-center justify-center gap-1 text-base">
                                <i class="fa fa-calculator"></i> Ê±ÇËß£Âπ∂ÊòæÁ§∫ËøáÁ®ã
                            </button>
                        </div>

                        <!-- Âè≥‰æßÁªìÊûúÂå∫Âüü -->
                        <div class="right-panel bg-neutral rounded-xl p-5 md:p-6 border border-gray-200">
                            <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                                <i class="fa fa-file-text-o text-primary"></i>Ëß£È¢òËøáÁ®ã & Ê≥®ÊÑè‰∫ãÈ°π
                            </h2>
                            <div id="solution-result" class="space-y-4 h-full">
                                <div class="text-center text-gray-500 py-8 md:py-10">
                                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                                    <p>ËØ∑ÈÄâÊã©ÊñπÁ®ãÁ±ªÂûãÂπ∂ËæìÂÖ•Á≥ªÊï∞ÔºåÁÇπÂáªÊ±ÇËß£ÊåâÈíÆÊü•ÁúãÁªìÊûú</p>
                                    <p class="text-xs mt-2 text-gray-400">Ëß£È¢òÊ≠•È™§‰∏•Ê†ºÈÅµÂæ™‰∏≠Â≠¶Êï∞Â≠¶‰π¶ÂÜôËßÑËåÉ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Âá†‰ΩïÁªòÂõæ -->
    <div class="tab-content" id="geometry">
        <div class="max-w-7xl mx-auto px-4 py-4 mb-4">
            <button onclick="switchToTab('home')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                <i class="fa fa-arrow-left"></i>
                ËøîÂõû‰∏ªÈ°µ
            </button>
        </div>
        <main class="container mx-auto px-4 md:px-6 py-6 md:py-8">
            <div class="force-horizontal gap-6 md:gap-8">
                <!-- Â∑¶‰æßÂ∑•ÂÖ∑Ê†è -->
                <div class="left-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                    <h2 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2">
                        <i class="fa fa-pencil-square-o text-primary"></i>ÁªòÂõæÂ∑•ÂÖ∑
                    </h2>
                    
                    <!-- ÂõæÂΩ¢Á±ªÂûãÈÄâÊã© -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©ÂõæÂΩ¢Á±ªÂûã</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="geometry-tool-btn active p-2 rounded-lg border-2 border-primary bg-primary/10 text-primary text-sm" data-tool="select">
                                <i class="fa fa-mouse-pointer block mb-1"></i>ÈÄâÊã©
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="point">
                                <i class="fa fa-dot-circle-o block mb-1"></i>ÁÇπ
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="line">
                                <i class="fa fa-minus block mb-1"></i>Áõ¥Á∫ø
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="segment">
                                <i class="fa fa-arrows-h block mb-1"></i>Á∫øÊÆµ
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="circle">
                                <i class="fa fa-circle-o block mb-1"></i>ÂúÜ
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="rectangle">
                                <i class="fa fa-square-o block mb-1"></i>Áü©ÂΩ¢
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="triangle">
                                <i class="fa fa-play fa-rotate-270 block mb-1"></i>‰∏âËßíÂΩ¢
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="polygon">
                                <i class="fa fa-star-o block mb-1"></i>Â§öËæπÂΩ¢
                            </button>
                            <button class="geometry-tool-btn p-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm hover:border-primary hover:text-primary" data-tool="regular-polygon">
                                <i class="fa fa-gear block mb-1"></i>Ê≠£Â§öËæπÂΩ¢
                            </button>
                        </div>
                    </div>

                    <!-- Ê≠£Â§öËæπÂΩ¢ËÆæÁΩÆ -->
                    <div id="regular-polygon-settings" class="mb-4 p-3 bg-gray-50 rounded-md hidden">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Ê≠£Â§öËæπÂΩ¢ËÆæÁΩÆ</h3>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">ËæπÊï∞</label>
                            <input type="number" id="polygon-sides" min="3" max="20" value="5" class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                    </div>

                    <!-- Â±ûÊÄßËÆæÁΩÆ -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-md">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">ÂõæÂΩ¢Â±ûÊÄß</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Á∫øÊù°È¢úËâ≤</label>
                                <div class="flex gap-2 flex-wrap">
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#000000" style="background: #000000;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#ff0000" style="background: #ff0000;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#00ff00" style="background: #00ff00;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#0000ff" style="background: #0000ff;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-primary" data-color="#0071e3" style="background: #0071e3;"></button>
                                    <button class="geometry-color-btn w-6 h-6 rounded-full border-2 border-gray-300" data-color="#ff9500" style="background: #ff9500;"></button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Á∫øÊù°Á≤óÁªÜ</label>
                                <input type="range" id="geometry-line-width" min="1" max="10" value="2" class="w-full">
                                <span id="geometry-line-width-value" class="text-xs text-gray-500">2px</span>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Â°´ÂÖÖÈ¢úËâ≤ÔºàÂèØÈÄâÔºâ</label>
                                <div class="flex gap-2 flex-wrap">
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-primary bg-transparent" data-fill="transparent"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#ff000033" style="background: #ff000033;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#00ff0033" style="background: #00ff0033;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#0000ff33" style="background: #0000ff33;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#0071e333" style="background: #0071e333;"></button>
                                    <button class="geometry-fill-btn w-6 h-6 rounded-full border-2 border-gray-300" data-fill="#ff950033" style="background: #ff950033;"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈíÆ -->
                    <div class="space-y-2">
                        <button id="geometry-clear" class="w-full py-2 px-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm">
                            <i class="fa fa-trash-o mr-1"></i>Ê∏ÖÁ©∫ÁîªÂ∏É
                        </button>
                        <button id="geometry-undo" class="w-full py-2 px-3 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm">
                            <i class="fa fa-undo mr-1"></i>Êí§ÈîÄ
                        </button>
                        <button id="geometry-export" class="w-full py-2 px-3 rounded-lg bg-primary text-white hover:bg-primary/90 text-sm">
                            <i class="fa fa-download mr-1"></i>ÂØºÂá∫ÂõæÁâá
                        </button>
                    </div>

                    <!-- ‰ΩøÁî®ËØ¥Êòé -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-md text-xs text-blue-700">
                        <p class="font-medium mb-1"><i class="fa fa-info-circle mr-1"></i>‰ΩøÁî®ËØ¥ÊòéÔºö</p>
                        <ul class="space-y-1 ml-4 list-disc">
                            <li><strong>ÈÄâÊã©Â∑•ÂÖ∑</strong>ÔºöÁÇπÂáªÈÄâ‰∏≠ÂõæÂΩ¢ÔºåÊãñÊãΩÁßªÂä®‰ΩçÁΩÆ</li>
                            <li><strong>ÈÄâ‰∏≠Âêé</strong>ÔºöÊãñÊãΩÊéßÂà∂ÁÇπË∞ÉÊï¥Â§ßÂ∞èÔºåÊãñÊãΩÊóãËΩ¨ÊâãÊüÑÊóãËΩ¨</li>
                            <li><strong>DeleteÈîÆ</strong>ÔºöÂà†Èô§ÈÄâ‰∏≠ÁöÑÂõæÂΩ¢</li>
                            <li><strong>ÁÇπ</strong>ÔºöÁÇπÂáªÊîæÁΩÆ</li>
                            <li><strong>Á∫ø/Á∫øÊÆµ</strong>ÔºöÊãñÊãΩÁªòÂà∂</li>
                            <li><strong>ÂúÜ</strong>Ôºö‰ªéÂúÜÂøÉÊãñÊãΩÂà∞ËæπÁºò</li>
                            <li><strong>Áü©ÂΩ¢/‰∏âËßíÂΩ¢</strong>ÔºöÊãñÊãΩÁªòÂà∂</li>
                            <li><strong>Â§öËæπÂΩ¢</strong>ÔºöÁÇπÂáªÊ∑ªÂä†È°∂ÁÇπÔºåÂèåÂáªÂÆåÊàê</li>
                            <li><strong>Ê≠£Â§öËæπÂΩ¢</strong>ÔºöËÆæÁΩÆËæπÊï∞ÂêéÔºåÊãñÊãΩÁªòÂà∂</li>
                            <li><strong>Âè≥ÈîÆ</strong>ÔºöÂèñÊ∂àÂΩìÂâçÁªòÂà∂</li>
                        </ul>
                    </div>
                </div>

                <!-- Âè≥‰æßÁîªÂ∏ÉÂå∫Âüü -->
                <div class="right-panel bg-white rounded-xl p-5 md:p-6 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg md:text-xl font-semibold flex items-center gap-2">
                            <i class="fa fa-paint-brush text-primary"></i>ÁîªÂ∏É
                        </h2>
                        <div class="text-sm text-gray-500">
                            <span id="geometry-coords">ÂùêÊ†á: (0, 0)</span>
                        </div>
                    </div>
                    <div class="relative bg-white border-2 border-gray-200 rounded-lg overflow-hidden" style="height: 600px;">
                        <canvas id="geometry-canvas" class="w-full h-full cursor-crosshair"></canvas>
                        <div id="geometry-grid-toggle" class="absolute top-2 right-2 p-2 bg-white/80 rounded-lg cursor-pointer hover:bg-white">
                            <i class="fa fa-th text-gray-600"></i>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== ÈÖçÁΩÆÂíåÂ∏∏Èáè ==========
        const CONFIG = {
            DEBOUNCE_WAIT: 300,
            STORAGE_KEYS: {
                ANSWER_SHEET: 'answerSheetSettings',
                TOMATO: 'tomatoStats',
                SCHEDULE: 'scheduleData',
                THEME: 'themePreference'
            },
            COLORS: {
                PRIMARY: '#0071e3',
                SUCCESS: '#34c759',
                WARNING: '#FF9500',
                ERROR: '#ff3b30',
                GRAY_200: '#e5e7eb',
                GRAY_700: '#374151'
            }
        };

        // ========== Â∑•ÂÖ∑ÂáΩÊï∞Â∫ì ==========
        
        function debounce(func, wait = CONFIG.DEBOUNCE_WAIT) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit = 100) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        function $(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element with id "${id}" not found`);
            }
            return el;
        }

        function createElement(tag, options = {}) {
            const el = document.createElement(tag);
            if (options.className) el.className = options.className;
            if (options.innerHTML) el.innerHTML = options.innerHTML;
            if (options.style) Object.assign(el.style, options.style);
            if (options.dataset) {
                Object.entries(options.dataset).forEach(([key, value]) => {
                    el.dataset[key] = value;
                });
            }
            return el;
        }

        function formatNumber(num, decimals = 2) {
            return Number(num).toFixed(decimals);
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = createElement('div', {
                style: {
                    position: 'fixed',
                    top: '80px',
                    right: '20px',
                    padding: '16px 24px',
                    borderRadius: '12px',
                    boxShadow: '0 10px 30px rgba(0,0,0,0.15)',
                    zIndex: '9999',
                    animation: 'fadeIn 0.3s ease-out',
                    background: type === 'success' ? CONFIG.COLORS.SUCCESS : 
                               type === 'error' ? CONFIG.COLORS.ERROR : 
                               type === 'warning' ? CONFIG.COLORS.WARNING : 
                               CONFIG.COLORS.PRIMARY,
                    color: 'white',
                    fontWeight: '500',
                    maxWidth: '400px',
                    wordWrap: 'break-word'
                }
            });
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.warn('‰øùÂ≠òÂà∞localStorageÂ§±Ë¥•:', error);
                showNotification('Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•', 'error');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.warn('‰ªélocalStorageËØªÂèñÂ§±Ë¥•:', error);
                return defaultValue;
            }
        }

        function clearStorage(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.warn('Ê∏ÖÈô§localStorageÂ§±Ë¥•:', error);
                return false;
            }
        }

        // ========== Â§©Ê∞îÊ®°Âùó ==========
        // ‰ΩøÁî® Open-Meteo APIÔºàÂÖçË¥πÔºåÊó†ÈúÄAPI KeyÔºâ
        const WEATHER_API_URL = 'https://api.open-meteo.com/v1/forecast';
        const GEOCODING_API_URL = 'https://geocoding-api.open-meteo.com/v1/search';

        // Â§©Ê∞îÂõæÊ†áÊò†Â∞Ñ
        const weatherIcons = {
            0: '‚òÄÔ∏è', // Êô¥Â§©
            1: 'üå§Ô∏è', //  mainly clear
            2: '‚õÖ', // partly cloudy
            3: '‚òÅÔ∏è', // overcast
            45: 'üå´Ô∏è', // fog
            48: 'üå´Ô∏è', // depositing rime fog
            51: 'üåßÔ∏è', // light drizzle
            53: 'üåßÔ∏è', // moderate drizzle
            55: 'üåßÔ∏è', // dense drizzle
            61: 'üåßÔ∏è', // slight rain
            63: 'üåßÔ∏è', // moderate rain
            65: 'üåßÔ∏è', // heavy rain
            71: 'üå®Ô∏è', // slight snow
            73: 'üå®Ô∏è', // moderate snow
            75: 'üå®Ô∏è', // heavy snow
            77: 'üå®Ô∏è', // snow grains
            80: 'üå¶Ô∏è', // slight rain showers
            81: 'üå¶Ô∏è', // moderate rain showers
            82: 'üå¶Ô∏è', // violent rain showers
            85: 'üå®Ô∏è', // slight snow showers
            86: 'üå®Ô∏è', // heavy snow showers
            95: '‚õàÔ∏è', // thunderstorm
            96: '‚õàÔ∏è', // thunderstorm with slight hail
            99: '‚õàÔ∏è', // thunderstorm with heavy hail
        };

        // Â§©Ê∞îÊèèËø∞Êò†Â∞Ñ
        const weatherDescriptions = {
            0: 'Êô¥Êúó',
            1: ' mainly clear',
            2: 'Â§ö‰∫ë',
            3: 'Èò¥Â§©',
            45: 'Èõæ',
            48: 'ÈõæÂáá',
            51: 'ÊØõÊØõÈõ®',
            53: '‰∏≠Èõ®',
            55: 'Â§ßÈõ®',
            61: 'Â∞èÈõ®',
            63: '‰∏≠Èõ®',
            65: 'Â§ßÈõ®',
            71: 'Â∞èÈõ™',
            73: '‰∏≠Èõ™',
            75: 'Â§ßÈõ™',
            77: 'Èõ™Á≤í',
            80: 'ÈòµÈõ®',
            81: '‰∏≠ÈòµÈõ®',
            82: 'Âº∫ÈòµÈõ®',
            85: 'ÈòµÈõ™',
            86: 'Âº∫ÈòµÈõ™',
            95: 'Èõ∑Èõ®',
            96: 'Èõ∑Èõ®‰º¥ÂÜ∞Èõπ',
            99: 'Âº∫Èõ∑Èõ®‰º¥ÂÜ∞Èõπ',
        };

        let currentWeatherData = null;

        async function initWeather() {
            const widget = document.getElementById('weatherWidget');
            const content = document.getElementById('weatherContent');
            const error = document.getElementById('weatherError');
            const cityEl = document.getElementById('weatherCity');

            if (!widget) return;

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            if (content) content.classList.remove('hidden');
            if (error) error.classList.add('hidden');
            if (cityEl) cityEl.textContent = 'ÂÆö‰Ωç‰∏≠...';

            try {
                // Â∞ùËØïËé∑ÂèñÁî®Êà∑‰ΩçÁΩÆ
                let lat, lon, cityName;

                // ÂÖàÂ∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑Âèñ‰πãÂâçÁöÑ‰ΩçÁΩÆ
                const savedLocation = localStorage.getItem('weatherLocation');
                if (savedLocation) {
                    const location = JSON.parse(savedLocation);
                    // Ê£ÄÊü•‰ΩçÁΩÆÊòØÂê¶ËøáÊúüÔºà24Â∞èÊó∂Ôºâ
                    if (Date.now() - location.timestamp < 24 * 60 * 60 * 1000) {
                        lat = location.lat;
                        lon = location.lon;
                        cityName = location.city;
                    }
                }

                // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁºìÂ≠òÔºåÂ∞ùËØïËé∑ÂèñÊñ∞‰ΩçÁΩÆ
                if (!lat || !lon) {
                    // È¶ñÂÖàÂ∞ùËØïÊµèËßàÂô®Âú∞ÁêÜÂÆö‰Ωç
                    if (navigator.geolocation) {
                        try {
                            const position = await getCurrentPosition();
                            lat = position.coords.latitude;
                            lon = position.coords.longitude;

                            // ÈÄöËøáÈÄÜÂú∞ÁêÜÁºñÁ†ÅËé∑ÂèñÂüéÂ∏ÇÂêç
                            cityName = await getCityNameFromCoords(lat, lon);

                            // ‰øùÂ≠ò‰ΩçÁΩÆ‰ø°ÊÅØ
                            localStorage.setItem('weatherLocation', JSON.stringify({
                                lat, lon, city: cityName,
                                timestamp: Date.now()
                            }));
                        } catch (geoError) {
                            console.log('ÊµèËßàÂô®ÂÆö‰ΩçÂ§±Ë¥•ÔºåÂ∞ùËØïIPÂÆö‰Ωç:', geoError.message);
                        }
                    }

                    // Â¶ÇÊûúÊµèËßàÂô®ÂÆö‰ΩçÂ§±Ë¥•ÔºåÂ∞ùËØïIPÂÆö‰Ωç
                    if (!lat || !lon) {
                        try {
                            const ipResponse = await fetch('https://ipapi.co/json/');
                            const ipData = await ipResponse.json();
                            lat = ipData.latitude;
                            lon = ipData.longitude;
                            cityName = ipData.city;

                            // ‰øùÂ≠ò‰ΩçÁΩÆ‰ø°ÊÅØ
                            localStorage.setItem('weatherLocation', JSON.stringify({
                                lat, lon, city: cityName,
                                timestamp: Date.now()
                            }));
                        } catch (ipError) {
                            console.log('IPÂÆö‰ΩçÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºàÂåó‰∫¨Ôºâ');
                            // ‰ΩøÁî®Âåó‰∫¨‰Ωú‰∏∫ÈªòËÆ§‰ΩçÁΩÆ
                            lat = 39.9042;
                            lon = 116.4074;
                            cityName = 'Âåó‰∫¨';
                        }
                    }
                }

                // Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
                await fetchWeatherData(lat, lon, cityName);

            } catch (error) {
                console.error('Â§©Ê∞îÂàùÂßãÂåñÂ§±Ë¥•:', error);
                showWeatherError();
            }
        }

        // Ëé∑ÂèñÊµèËßàÂô®ÂΩìÂâç‰ΩçÁΩÆ
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰Ωç'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position),
                    (error) => {
                        let errorMessage = 'ÂÆö‰ΩçÂ§±Ë¥•';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Áî®Êà∑ÊãíÁªù‰∫ÜÂÆö‰ΩçËØ∑Ê±Ç';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‰ΩçÁΩÆ‰ø°ÊÅØ‰∏çÂèØÁî®';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'ÂÆö‰ΩçËØ∑Ê±ÇË∂ÖÊó∂';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: false, // ‰∏çÈúÄË¶ÅÈ´òÁ≤æÂ∫¶ÔºåËäÇÁúÅÁîµÈáè
                        timeout: 10000, // 10ÁßíË∂ÖÊó∂
                        maximumAge: 300000 // 5ÂàÜÈíüÁºìÂ≠ò
                    }
                );
            });
        }

        // ÈÄöËøáÂùêÊ†áËé∑ÂèñÂüéÂ∏ÇÂêçÔºà‰ΩøÁî® BigDataCloud ÂÖçË¥πÂèçÂêëÂú∞ÁêÜÁºñÁ†Å APIÔºåÊîØÊåÅ‰∏≠ÊñáÔºâ
        async function getCityNameFromCoords(lat, lon) {
            try {
                // ‰ΩøÁî® BigDataCloud ÂÖçË¥π APIÔºàÊó†ÈúÄ API KeyÔºåÊîØÊåÅ‰∏≠ÊñáÂú∞ÂùÄÔºâ
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                const data = await response.json();

                if (data) {
                    // ‰ºòÂÖàËøîÂõûÂéøÂå∫ÂêçÁß∞ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËøîÂõûÂüéÂ∏ÇÂêçÁß∞
                    const district = data.locality || data.city || data.principalSubdivision;
                    if (district) {
                        // Ê∏ÖÁêÜÂêçÁß∞ÔºåÁßªÈô§"Â∏ÇËæñÂå∫"Á≠âÂêéÁºÄ
                        return district.replace(/Â∏ÇËæñÂå∫$/, '').replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
                    }
                }

                // Â¶ÇÊûú BigDataCloud Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî® Nominatim (OpenStreetMap)
                return await getCityNameFromNominatim(lat, lon);
            } catch (error) {
                console.log('BigDataCloud Ëé∑ÂèñÂüéÂ∏ÇÂêçÂ§±Ë¥•:', error);
                return await getCityNameFromNominatim(lat, lon);
            }
        }

        // Â§áÁî®Ôºö‰ΩøÁî® Nominatim (OpenStreetMap) ÂèçÂêëÂú∞ÁêÜÁºñÁ†Å
        async function getCityNameFromNominatim(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=zh-CN`);
                const data = await response.json();

                if (data && data.address) {
                    const addr = data.address;
                    // ‰ºòÂÖàËøîÂõûÂéøÂå∫ÂêçÁß∞
                    const district = addr.district || addr.county || addr.city || addr.town || addr.village;
                    if (district) {
                        return district.replace(/Â∏ÇËæñÂå∫$/, '').replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
                    }
                }

                return 'Êú¨Âú∞';
            } catch (error) {
                console.log('Nominatim Ëé∑ÂèñÂüéÂ∏ÇÂêçÂ§±Ë¥•:', error);
                return 'Êú¨Âú∞';
            }
        }

        async function fetchWeatherData(lat, lon, cityName) {
            try {
                // Open-Meteo API ËØ∑Ê±Ç
                const url = `${WEATHER_API_URL}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Â§©Ê∞îÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');

                const data = await response.json();
                currentWeatherData = data;

                // Êõ¥Êñ∞UI
                updateWeatherUI(data, cityName);

            } catch (error) {
                console.error('Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆÂ§±Ë¥•:', error);
                showWeatherError();
            }
        }

        function updateWeatherUI(data, cityName) {
            const cityEl = document.getElementById('weatherCity');
            const iconEl = document.getElementById('weatherIcon');
            const tempEl = document.getElementById('weatherTemp');
            const descEl = document.getElementById('weatherDesc');
            const humidityEl = document.getElementById('weatherHumidity');
            const windEl = document.getElementById('weatherWind');

            if (!data || !data.current) {
                showWeatherError();
                return;
            }

            const current = data.current;
            const weatherCode = current.weather_code;

            // Êõ¥Êñ∞ÂüéÂ∏ÇÂêçÁß∞
            if (cityEl) cityEl.textContent = cityName || 'Êú¨Âú∞';

            // Êõ¥Êñ∞Â§©Ê∞îÂõæÊ†á
            if (iconEl) iconEl.textContent = weatherIcons[weatherCode] || 'üå°Ô∏è';

            // Êõ¥Êñ∞Ê∏©Â∫¶
            if (tempEl) tempEl.textContent = `${Math.round(current.temperature_2m)}¬∞`;

            // Êõ¥Êñ∞Â§©Ê∞îÊèèËø∞
            if (descEl) descEl.textContent = weatherDescriptions[weatherCode] || 'Êú™Áü•';

            // Êõ¥Êñ∞ÊπøÂ∫¶
            if (humidityEl) humidityEl.textContent = `${current.relative_humidity_2m}%`;

            // Êõ¥Êñ∞È£éÈÄüÔºàËΩ¨Êç¢‰∏∫È£éÂäõÁ≠âÁ∫ßÔºåÁÆÄÂåñÂ§ÑÁêÜÔºâ
            const windSpeed = current.wind_speed_10m;
            const windLevel = Math.min(Math.ceil(windSpeed / 2), 12);
            if (windEl) windEl.textContent = `${windLevel}Á∫ß`;
        }

        function showWeatherError() {
            const content = document.getElementById('weatherContent');
            const error = document.getElementById('weatherError');

            if (content) content.classList.add('hidden');
            if (error) error.classList.remove('hidden');
        }

        async function refreshWeather() {
            // Ê∏ÖÈô§‰øùÂ≠òÁöÑ‰ΩçÁΩÆÔºåÈáçÊñ∞Ëé∑Âèñ
            localStorage.removeItem('weatherLocation');
            await initWeather();
        }

        // ËØ∑Ê±ÇÂÆö‰ΩçÊùÉÈôê
        async function requestLocationPermission() {
            const prompt = document.getElementById('weatherLocationPrompt');
            const content = document.getElementById('weatherContent');

            // ÈöêËóèÊèêÁ§∫
            if (prompt) prompt.classList.add('hidden');
            if (content) content.classList.remove('hidden');

            // Ê∏ÖÈô§‰πãÂâçÁöÑ‰ΩçÁΩÆÁºìÂ≠ò
            localStorage.removeItem('weatherLocation');

            // Â∞ùËØïËé∑ÂèñÊµèËßàÂô®ÂÆö‰Ωç
            if (navigator.geolocation) {
                try {
                    const position = await getCurrentPosition();
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Ëé∑ÂèñÂüéÂ∏ÇÂêç
                    const cityName = await getCityNameFromCoords(lat, lon);

                    // ‰øùÂ≠ò‰ΩçÁΩÆ
                    localStorage.setItem('weatherLocation', JSON.stringify({
                        lat, lon, city: cityName,
                        timestamp: Date.now()
                    }));

                    // Ëé∑ÂèñÂ§©Ê∞î
                    await fetchWeatherData(lat, lon, cityName);
                    showNotification('ÂÆö‰ΩçÊàêÂäü', 'success');

                } catch (error) {
                    console.log('ÂÆö‰ΩçÂ§±Ë¥•:', error.message);
                    // ÊòæÁ§∫ÂÆö‰ΩçÊèêÁ§∫
                    if (prompt) {
                        prompt.classList.remove('hidden');
                        if (content) content.classList.add('hidden');
                    }
                    showNotification('ÂÆö‰ΩçÂ§±Ë¥•: ' + error.message, 'warning');
                }
            } else {
                showNotification('ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰Ωç', 'warning');
                useDefaultLocation();
            }
        }

        // ‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºàÂåó‰∫¨Ôºâ
        async function useDefaultLocation() {
            const prompt = document.getElementById('weatherLocationPrompt');
            const content = document.getElementById('weatherContent');

            if (prompt) prompt.classList.add('hidden');
            if (content) content.classList.remove('hidden');

            const lat = 39.9042;
            const lon = 116.4074;
            const cityName = 'Âåó‰∫¨';

            // ‰øùÂ≠òÈªòËÆ§‰ΩçÁΩÆ
            localStorage.setItem('weatherLocation', JSON.stringify({
                lat, lon, city: cityName,
                timestamp: Date.now()
            }));

            await fetchWeatherData(lat, lon, cityName);
            showNotification('Â∑≤‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆÔºàÂåó‰∫¨Ôºâ', 'info');
        }

        // ÊØèÂ∞èÊó∂Ëá™Âä®Âà∑Êñ∞Â§©Ê∞î
        function startWeatherAutoRefresh() {
            setInterval(() => {
                initWeather();
            }, 3600000); // ÊØèÂ∞èÊó∂Âà∑Êñ∞‰∏ÄÊ¨°
        }

        // ========== ‰∏ªÈ¢òÁ≥ªÁªü ==========
        function initTheme() {
            const savedTheme = loadFromStorage(CONFIG.STORAGE_KEYS.THEME, 'light');
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            saveToStorage(CONFIG.STORAGE_KEYS.THEME, theme);
            updateThemeButton(theme);
        }

        function updateThemeButton(theme) {
            const btn = document.querySelector('.theme-toggle-btn');
            if (btn) {
                btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            showNotification(`Â∑≤ÂàáÊç¢Âà∞${newTheme === 'dark' ? 'Ê∑±Ëâ≤' : 'ÊµÖËâ≤'}Ê®°Âºè`, 'info');
        }

        // ========== ÂØºËà™ÂíåÊ†áÁ≠æÂàáÊç¢ ==========
        
        function switchToTab(tabId) {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            const targetTab = document.querySelector(`[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (!targetTab || !targetContent) {
                console.error(`Tab "${tabId}" not found`);
                showNotification('È°µÈù¢ÂàáÊç¢Â§±Ë¥•', 'error');
                return;
            }
            
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            contents.forEach(c => c.classList.remove('active'));
            
            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            targetContent.classList.add('active');
            
            // ÂàáÊç¢Âà∞Âá†‰ΩïÁªòÂõæÊ†áÁ≠æÊó∂ÈáçÊñ∞ÂàùÂßãÂåñÁîªÂ∏É
            if (tabId === 'geometry') {
                setTimeout(() => {
                    resizeGeometryCanvas();
                    redrawGeometryCanvas();
                }, 50);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchTab(tabId) {
            switchToTab(tabId);
        }

        function scrollToFeatures() {
            const features = document.getElementById('features');
            if (features) {
                features.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Â§çÂà∂Â∞èÁ∫¢‰π¶Ë¥¶Âè∑
        function copyXiaohongshuId() {
            const xiaohongshuId = document.getElementById('xiaohongshu-id').textContent;
            navigator.clipboard.writeText(xiaohongshuId).then(() => {
                showNotification('Â∞èÁ∫¢‰π¶Ë¥¶Âè∑Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(() => {
                // ÈôçÁ∫ßÊñπÊ°à
                const textarea = document.createElement('textarea');
                textarea.value = xiaohongshuId;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Â∞èÁ∫¢‰π¶Ë¥¶Âè∑Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            });
        }

        // ========== ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ ==========
        
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                const tabs = ['home', 'answer-sheet', 'tomato', 'schedule', 'function'];
                if (tabs[tabIndex]) {
                    switchToTab(tabs[tabIndex]);
                }
            }
            
            if (e.key === 'Escape') {
                const modal = document.getElementById('courseModal');
                if (modal && modal.classList.contains('show')) {
                    closeModal();
                } else {
                    switchToTab('home');
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
            
            // DeleteÈîÆÂà†Èô§ÈÄâ‰∏≠ÁöÑÂá†‰ΩïÂõæÂΩ¢
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®Âá†‰ΩïÁªòÂõæÈ°µÈù¢‰∏îÊúâÈÄâ‰∏≠ÁöÑÂõæÂΩ¢
                const geometryTab = document.getElementById('geometry');
                if (geometryTab && !geometryTab.classList.contains('hidden') && 
                    geometrySelectedShape !== null && geometrySelectedShape !== undefined) {
                    e.preventDefault();
                    deleteSelectedGeometryShape();
                }
            }
        });

        // ========== Á≠îÈ¢òÂç°ÁîüÊàêÁ®ãÂ∫è ==========
        
        function saveAnswerSheetSettings() {
            const settings = {
                examName: $('examName')?.value || '',
                subject: $('subject')?.value || '',
                examTime: $('examTime')?.value || '',
                fullScore: $('fullScore')?.value || 100,
                showName: $('showName')?.checked,
                showClass: $('showClass')?.checked,
                showExamNo: $('showExamNo')?.checked,
                showSeatNo: $('showSeatNo')?.checked,
                enableMCQ: $('enableMCQ')?.checked,
                mcqCount: $('mcqCount')?.value || 12,
                mcqScore: $('mcqScore')?.value || 5,
                mcqOptions: $('mcqOptions')?.value || 4,
                enableBlank: $('enableBlank')?.checked,
                blankCount: $('blankCount')?.value || 6,
                blankScore: $('blankScore')?.value || 5,
                enableProblem: $('enableProblem')?.checked,
                problemCount: $('problemCount')?.value || 6,
                problemHeight: $('problemHeight')?.value || 180,
                showNotice: $('showNotice')?.checked,
                showSealArea: $('showSealArea')?.checked,
                enableScratchPaper: $('enableScratchPaper')?.checked,
                scratchPaperModules: $('scratchPaperModules')?.value || 2,
                scratchPaperTitle: $('scratchPaperTitle')?.value || 'ÊâìËçâÁ∫∏'
            };
            saveToStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET, settings);
        }

        function loadAnswerSheetSettings() {
            const settings = loadFromStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET);
            if (!settings) return;
            
            Object.keys(settings).forEach(key => {
                const el = document.getElementById(key);
                if (!el) return;
                
                if (el.type === 'checkbox') {
                    el.checked = settings[key];
                } else {
                    el.value = settings[key];
                }
            });
        }

        const debouncedAnswerSheetUpdate = debounce(() => {
            generateAnswerSheet();
            saveAnswerSheetSettings();
        }, CONFIG.DEBOUNCE_WAIT);

        function exportAnswerSheetSettings() {
            const settings = loadFromStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET);
            if (!settings) {
                showNotification('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑËÆæÁΩÆ', 'warning');
                return;
            }
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Á≠îÈ¢òÂç°ËÆæÁΩÆ_' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Á≠îÈ¢òÂç°ËÆæÁΩÆÂ∑≤ÂØºÂá∫', 'success');
        }

        function importAnswerSheetSettings(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    saveToStorage(CONFIG.STORAGE_KEYS.ANSWER_SHEET, settings);
                    loadAnswerSheetSettings();
                    generateAnswerSheet();
                    showNotification('Á≠îÈ¢òÂç°ËÆæÁΩÆÂ∑≤ÂØºÂÖ•', 'success');
                } catch (error) {
                    showNotification('ÂØºÂÖ•Â§±Ë¥•ÔºöÊó†ÊïàÁöÑÊñá‰ª∂Ê†ºÂºè', 'error');
                }
            };
            reader.readAsText(file);
        }

        function handleImportSettings(event) {
            const file = event.target.files[0];
            if (file) {
                importAnswerSheetSettings(file);
                event.target.value = '';
            }
        }

        window.onload = function() {
            try {
                initTheme();
                loadAnswerSheetSettings();
                
                const allInputs = document.querySelectorAll('#answer-sheet input, #answer-sheet select');
                allInputs.forEach(input => {
                    input.addEventListener('input', debouncedAnswerSheetUpdate);
                    input.addEventListener('change', debouncedAnswerSheetUpdate);
                });
                
                generateAnswerSheet();
                initTomato();
                initSchedule();
                initFunctionDrawing();
                initGeometryDrawing();
                initIncomeModule();
                initStudentsModule();

                console.log('‚úÖ Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑Âä†ËΩΩÂÆåÊàê');
                showNotification('Â∑•ÂÖ∑Â∑≤Âä†ËΩΩÂÆåÊàê', 'success');
            } catch (error) {
                console.error('‚ùå ÂàùÂßãÂåñÈîôËØØ:', error);
                showNotification('È°µÈù¢Âä†ËΩΩÊó∂Âá∫Áé∞ÈîôËØØ', 'error');
            }
        };

        function generateAnswerSheet() {
            try {
                const container = document.getElementById('answerSheetContainer');
                let html = '<div class="answer-sheet">';

                const examName = document.getElementById('examName').value.trim() || 'ÂçïÂÖÉÊµãËØï';
                const subject = document.getElementById('subject').value.trim() || 'Êï∞Â≠¶';
                const examTime = document.getElementById('examTime').value.trim() || '90ÂàÜÈíü';
                const fullScore = parseInt(document.getElementById('fullScore').value) || 100;

                const showName = document.getElementById('showName').checked;
                const showClass = document.getElementById('showClass').checked;
                const showExamNo = document.getElementById('showExamNo').checked;
                const showSeatNo = document.getElementById('showSeatNo').checked;

                const enableMCQ = document.getElementById('enableMCQ').checked;
                const mcqCount = parseInt(document.getElementById('mcqCount').value) || 0;
                const mcqScore = parseInt(document.getElementById('mcqScore').value) || 0;
                const mcqOptions = parseInt(document.getElementById('mcqOptions').value) || 4;
                const mcqTotalScore = enableMCQ ? (mcqCount * mcqScore) : 0;

                const enableBlank = document.getElementById('enableBlank').checked;
                const blankCount = parseInt(document.getElementById('blankCount').value) || 0;
                const blankScore = parseInt(document.getElementById('blankScore').value) || 0;
                const blankTotalScore = enableBlank ? (blankCount * blankScore) : 0;

                const enableProblem = document.getElementById('enableProblem').checked;
                const problemCount = parseInt(document.getElementById('problemCount').value) || 0;
                const problemHeight = document.getElementById('problemHeight').value || 180;
                const problemTotalScore = fullScore - mcqTotalScore - blankTotalScore;

                const showNotice = document.getElementById('showNotice').checked;
                const showSealArea = document.getElementById('showSealArea').checked;
                const optionLabels = ['A', 'B', 'C', 'D', 'E'];
                let questionNumber = 1;

                if (showSealArea) {
                    html += '<div class="seal-area">ÂØÜÂ∞ÅÂå∫</div>';
                }

                html += `
                    <div class="sheet-header">
                        <div class="sheet-title">${examName} - ${subject}Á≠îÈ¢òÂç°</div>
                        <div style="font-size:14px; margin-top:5px;">ÔºàËÄÉËØïÊó∂Èó¥Ôºö${examTime}  Êª°ÂàÜÔºö${fullScore}ÂàÜÔºâ</div>
                `;

                html += '<div class="student-info">';
                if (showName) {
                    html += '<div class="info-item">ÂßìÂêçÔºö<span class="info-underline"></span></div>';
                }
                if (showClass) {
                    html += '<div class="info-item">Áè≠Á∫ßÔºö<span class="info-underline"></span></div>';
                }
                if (showExamNo) {
                    html += '<div class="info-item">ËÄÉÂè∑Ôºö<span class="info-underline"></span></div>';
                }
                if (showSeatNo) {
                    html += '<div class="info-item">Â∫ß‰ΩçÂè∑Ôºö<span class="info-underline"></span></div>';
                }
                html += '</div>';
                html += '</div>';

                if (showNotice) {
                    html += `
                        <div class="notice-section">
                            <div class="notice-title">‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°πÔºö</div>
                            <div class="notice-content">
                                1. Á≠îÈ¢òÂâçÔºåËØ∑Â∞ÜÂßìÂêç„ÄÅÁè≠Á∫ß„ÄÅËÄÉÂè∑Á≠â‰ø°ÊÅØÂ°´ÂÜôÊ∏ÖÊ•ö„ÄÇ<br/>
                                2. ÈÄâÊã©È¢òÁ≠îÊ°àËØ∑Áî®2BÈìÖÁ¨îÂ°´Ê∂ÇÔºå‰øÆÊîπÊó∂Áî®Ê©°ÁöÆÊì¶Âπ≤ÂáÄ„ÄÇ<br/>
                                3. Â°´Á©∫È¢òÂíåËß£Á≠îÈ¢òËØ∑Áî®ÈªëËâ≤Á≠æÂ≠óÁ¨î‰ΩúÁ≠îÔºåÁ≠îÊ°àÂøÖÈ°ªÂÜôÂú®Á≠îÈ¢òÂå∫ÂüüÂÜÖ„ÄÇ<br/>
                                4. ‰øùÊåÅÂç∑Èù¢Êï¥Ê¥ÅÔºå‰∏çË¶ÅÊäòÂè†„ÄÅÁ†¥ÊçüÁ≠îÈ¢òÂç°„ÄÇ
                            </div>
                        </div>
                    `;
                }

                if (enableMCQ && mcqCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">‰∏Ä„ÄÅÈÄâÊã©È¢òÔºàÊú¨Â§ßÈ¢òÂÖ±${mcqCount}Â∞èÈ¢òÔºåÊØèÂ∞èÈ¢ò${mcqScore}ÂàÜÔºåÂÖ±${mcqTotalScore}ÂàÜÔºâ</div>
                            <div class="mcq-grid">
                    `;
                    for (let i = 1; i <= mcqCount; i++) {
                        html += `
                            <div class="mcq-item">
                                <div class="mcq-num">${questionNumber}.</div>
                                <div class="mcq-options">
                        `;
                        for (let j = 0; j < mcqOptions; j++) {
                            html += `<span class="mcq-option">${optionLabels[j]}</span>`;
                        }
                        html += `</div></div>`;
                        questionNumber++;
                    }
                    html += `</div></div>`;
                }

                if (enableBlank && blankCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">‰∫å„ÄÅÂ°´Á©∫È¢òÔºàÊú¨Â§ßÈ¢òÂÖ±${blankCount}Â∞èÈ¢òÔºåÊØèÂ∞èÈ¢ò${blankScore}ÂàÜÔºåÂÖ±${blankTotalScore}ÂàÜÔºâ</div>
                            <div class="blank-section">
                    `;
                    for (let i = 1; i <= blankCount; i++) {
                        html += `
                            <div class="blank-item">
                                <span class="blank-num">${questionNumber}.</span>
                                <div class="blank-line"></div>
                            </div>
                        `;
                        questionNumber++;
                    }
                    html += `</div></div>`;
                }

                if (enableProblem && problemCount > 0) {
                    html += `
                        <div class="section-block">
                            <div class="section-title-main">‰∏â„ÄÅËß£Á≠îÈ¢òÔºàÊú¨Â§ßÈ¢òÂÖ±${problemCount}Â∞èÈ¢òÔºåÂÖ±${problemTotalScore}ÂàÜÔºâ</div>
                    `;
                    for (let i = 1; i <= problemCount; i++) {
                        html += `
                            <div class="problem-item">
                                <div class="problem-header">
                                    <span class="problem-num">${questionNumber}.</span>
                                    <span class="problem-score">ÔºàÊú¨È¢ò ÂàÜÔºâ</span>
                                </div>
                                <div class="problem-answer-area" style="min-height: ${problemHeight}px;">
                                    <div class="problem-score-box">ÂæóÂàÜÔºö</div>
                                </div>
                            </div>
                        `;
                        questionNumber++;
                    }
                    html += `</div>`;
                }

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                const container = document.getElementById('answerSheetContainer');
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 0; color:#dc3545;">
                        <h3>ÁîüÊàêÂá∫Èîô‰∫Ü</h3>
                        <p>ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</p>
                        <p>ËØ∑Ê£ÄÊü•ËÆæÁΩÆÈ°πÊòØÂê¶Â°´ÂÜôÊ≠£Á°ÆÔºåÁÇπÂáª„ÄåÂà∑Êñ∞È¢ÑËßà„ÄçÈáçËØï</p>
                    </div>
                `;
                console.error('Á≠îÈ¢òÂç°ÁîüÊàêÈîôËØØÔºö', error);
            }
        }

        function switchAnswerSheetView(view) {
            const views = ['answer-sheet', 'scratch-paper'];
            views.forEach(v => {
                const tab = document.getElementById(`as-tab-${v}`);
                const module = document.getElementById(`as-module-${v}`);
                if (tab) {
                    tab.classList.toggle('active', v === view);
                }
                if (module) {
                    module.classList.toggle('hidden', v !== view);
                    module.classList.toggle('block', v === view);
                }
            });
        }

        function generateScratchPaper() {
            try {
                const container = document.getElementById('scratchPaperContainer');
                let moduleCount = parseInt(document.getElementById('scratchPaperModules').value) || 2;
                
                if (moduleCount < 1) moduleCount = 1;
                if (moduleCount > 20) moduleCount = 20;
                
                const title = document.getElementById('scratchPaperTitle').value.trim() || 'ÊâìËçâÁ∫∏';
                
                let gridColumns, gridRows;
                if (moduleCount === 1) {
                    gridColumns = 1;
                    gridRows = 1;
                } else if (moduleCount === 2) {
                    gridColumns = 1;
                    gridRows = 2;
                } else if (moduleCount <= 4) {
                    gridColumns = 2;
                    gridRows = 2;
                } else if (moduleCount <= 6) {
                    gridColumns = 2;
                    gridRows = 3;
                } else if (moduleCount <= 9) {
                    gridColumns = 3;
                    gridRows = 3;
                } else if (moduleCount <= 12) {
                    gridColumns = 3;
                    gridRows = 4;
                } else if (moduleCount <= 16) {
                    gridColumns = 4;
                    gridRows = 4;
                } else {
                    gridColumns = 4;
                    gridRows = 5;
                }
                
                // ËÆ°ÁÆóÊØè‰∏™Ê®°ÂùóÁöÑÈ´òÂ∫¶ÔºåÁ°Æ‰øùÂç†Êª°Êï¥Âº†Á∫∏
                const headerHeight = 35; // Ê†áÈ¢òÂå∫ÂüüÈ´òÂ∫¶(px)
                const availableHeight = 960; // A4Á∫∏ÂèØÁî®È´òÂ∫¶Á∫¶960px (297mm - ËæπË∑ù)
                const moduleHeight = Math.floor((availableHeight - headerHeight) / gridRows);
                
                let html = '<div class="answer-sheet" style="font-family: \"SimSun\", \"Microsoft YaHei\", sans-serif; color: #000; height: 100%; display: flex; flex-direction: column; overflow: hidden;">';
                
                html += `
                    <div class="scratch-paper-header" style="text-align: center; padding: 5px 0; border-bottom: 1px solid #000; margin-bottom: 5px; flex-shrink: 0; height: ${headerHeight}px; box-sizing: border-box;">
                        <div class="scratch-paper-title" style="font-size: 14px; font-weight: bold; font-family: \"SimHei\", sans-serif; line-height: 1.2;">${escapeHTML(title)}</div>
                    </div>
                `;
                
                html += `<div class="scratch-paper-modules" style="display: grid; gap: 0; width: 100%; flex: 1; grid-template-columns: repeat(${gridColumns}, 1fr); grid-auto-rows: ${moduleHeight}px;">`;
                
                for (let i = 1; i <= moduleCount; i++) {
                    html += `
                        <div class="scratch-paper-module" style="border: 1px dashed #999; padding: 3px; box-sizing: border-box; display: flex; flex-direction: column; height: ${moduleHeight}px;">
                            <div class="scratch-paper-module-label" style="font-size: 9px; color: #999; text-align: center; margin-bottom: 2px; font-family: \"SimSun\", sans-serif; flex-shrink: 0;">Ê®°Âùó ${i}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
                
                container.style.padding = '3mm';
                container.style.height = '297mm';
                container.style.boxSizing = 'border-box';
                container.innerHTML = html;
                showNotification('ÊâìËçâÁ∫∏Â∑≤ÁîüÊàê', 'success');
                
            } catch (error) {
                const container = document.getElementById('scratchPaperContainer');
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 0; color:#dc3545;">
                        <h3>ÁîüÊàêÊâìËçâÁ∫∏Âá∫Èîô‰∫Ü</h3>
                        <p>ÈîôËØØ‰ø°ÊÅØÔºö${error.message}</p>
                        <p>ËØ∑Ê£ÄÊü•ËÆæÁΩÆÈ°πÊòØÂê¶Â°´ÂÜôÊ≠£Á°ÆÔºåÁÇπÂáª„ÄåÁîüÊàêÊâìËçâÁ∫∏„ÄçÈáçËØï</p>
                    </div>
                `;
                console.error('ÊâìËçâÁ∫∏ÁîüÊàêÈîôËØØÔºö', error);
            }
        }

        function printAnswerSheet() {
            const content = document.getElementById('answerSheetContainer');
            if (!content.innerHTML.includes('ÁÇπÂáª')) {
                window.print();
            } else {
                showNotification('ËØ∑ÂÖàÁîüÊàêÁ≠îÈ¢òÂç°ÂÜçÊâìÂç∞', 'warning');
            }
        }

        function printScratchPaper() {
            const content = document.getElementById('scratchPaperContainer');
            if (!content.innerHTML.includes('ÁÇπÂáª')) {
                window.print();
            } else {
                showNotification('ËØ∑ÂÖàÁîüÊàêÊâìËçâÁ∫∏ÂÜçÊâìÂç∞', 'warning');
            }
        }

        function exportAnswerSheetToPDF() {
            const content = document.getElementById('answerSheetContainer');
            if (content.innerHTML.includes('ÁÇπÂáª')) {
                showNotification('ËØ∑ÂÖàÁîüÊàêÁ≠îÈ¢òÂç°ÂÜçÂØºÂá∫', 'warning');
                return;
            }
            
            const originalMargin = content.style.margin;
            const originalTransform = content.style.transform;
            content.style.margin = '0';
            content.style.transform = 'none';
            
            const opt = {
                margin: 0,
                filename: `Á≠îÈ¢òÂç°_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(content).save().then(() => {
                content.style.margin = originalMargin;
                content.style.transform = originalTransform;
                showNotification('Á≠îÈ¢òÂç°Â∑≤ÂØºÂá∫PDF', 'success');
            });
        }

        function exportScratchPaperToPDF() {
            const content = document.getElementById('scratchPaperContainer');
            if (content.innerHTML.includes('ÁÇπÂáª')) {
                showNotification('ËØ∑ÂÖàÁîüÊàêÊâìËçâÁ∫∏ÂÜçÂØºÂá∫', 'warning');
                return;
            }
            
            const originalMargin = content.style.margin;
            const originalTransform = content.style.transform;
            content.style.margin = '0';
            content.style.transform = 'none';
            
            const opt = {
                margin: 0,
                filename: `ÊâìËçâÁ∫∏_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(content).save().then(() => {
                content.style.margin = originalMargin;
                content.style.transform = originalTransform;
                showNotification('ÊâìËçâÁ∫∏Â∑≤ÂØºÂá∫PDF', 'success');
            });
        }

        // ========== Áï™ËåÑÊó∂Èíü ==========
        let tomatoCountdownTime = 1500;
        let tomatoTimerInterval = null;
        let tomatoIsRunning = false;
        let tomatoCount = 0;
        let tomatoLastTickTime = null;
        let tomatoIsInitialized = false;

        function saveTomatoStats() {
            saveToStorage(CONFIG.STORAGE_KEYS.TOMATO, { count: tomatoCount });
        }

        function loadTomatoStats() {
            const stats = loadFromStorage(CONFIG.STORAGE_KEYS.TOMATO);
            if (stats) {
                tomatoCount = stats.count || 0;
            }
        }

        function saveTomatoStats() {
            saveToStorage(CONFIG.STORAGE_KEYS.TOMATO, { count: tomatoCount });
        }

        function loadTomatoStats() {
            const stats = loadFromStorage(CONFIG.STORAGE_KEYS.TOMATO);
            if (stats) {
                tomatoCount = stats.count || 0;
            }
        }

        function formatTomatoTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateTomatoTimerDisplay() {
            const tomatoTimerDisplayEl = document.getElementById('tomatoTimerDisplay');
            if (tomatoTimerDisplayEl) {
                tomatoTimerDisplayEl.textContent = formatTomatoTime(tomatoCountdownTime);
            }
        }

        // ‰ΩøÁî® requestAnimationFrame ÂÆûÁé∞Êõ¥Á≤æÁ°ÆÁöÑËÆ°Êó∂
        function tomatoTick() {
            if (!tomatoIsRunning) return;
            
            const now = Date.now();
            if (!tomatoLastTickTime) {
                tomatoLastTickTime = now;
            }
            
            const elapsed = Math.floor((now - tomatoLastTickTime) / 1000);
            
            if (elapsed >= 1) {
                tomatoCountdownTime -= elapsed;
                tomatoLastTickTime = now;
                updateTomatoTimerDisplay();
                
                if (tomatoCountdownTime <= 0) {
                    tomatoCountdownTime = 0;
                    updateTomatoTimerDisplay();
                    completeTomatoSession();
                    return;
                }
            }
            
            tomatoTimerInterval = requestAnimationFrame(tomatoTick);
        }

        function completeTomatoSession() {
            clearInterval(tomatoTimerInterval);
            cancelAnimationFrame(tomatoTimerInterval);
            tomatoIsRunning = false;
            tomatoLastTickTime = null;
            const tomatoStartBtn = document.getElementById('tomatoStartBtn');
            if (tomatoStartBtn) tomatoStartBtn.textContent = 'ÂºÄÂßã';
            
            const activeMode = document.querySelector('.tomato-mode-btn.active');
            if (activeMode && activeMode.dataset.time === '1500') {
                tomatoCount++;
                const tomatoCountEl = document.getElementById('tomatoCount');
                if (tomatoCountEl) {
                    tomatoCountEl.textContent = tomatoCount;
                }
                saveTomatoStats();
                showNotification('ÊÅ≠ÂñúÂÆåÊàê‰∏Ä‰∏™Áï™ËåÑÈíü!', 'success');
            }
            
            // Êí≠ÊîæÊèêÁ§∫Èü≥
            try {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
                audio.play().catch(() => {});
            } catch (e) {
                console.warn('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•');
            }
            
            // ÈáçÁΩÆÊó∂Èó¥
            setTimeout(() => {
                if (activeMode) {
                    tomatoCountdownTime = parseInt(activeMode.dataset.time) || 1500;
                }
                updateTomatoTimerDisplay();
            }, 2000);
        }

        function initTomato() {
            if (tomatoIsInitialized) return;
            
            loadTomatoStats();
            
            const tomatoCurrentTimeEl = document.getElementById('tomatoCurrentTime');
            const tomatoTimerDisplayEl = document.getElementById('tomatoTimerDisplay');
            const tomatoModeBtns = document.querySelectorAll('.tomato-mode-btn');
            const tomatoStartBtn = document.getElementById('tomatoStartBtn');
            const tomatoResetBtn = document.getElementById('tomatoResetBtn');
            const tomatoCountEl = document.getElementById('tomatoCount');
            
            console.log('Áï™ËåÑÊó∂ÈíüÂàùÂßãÂåñ:', {
                tomatoStartBtn: !!tomatoStartBtn,
                tomatoResetBtn: !!tomatoResetBtn,
                tomatoTimerDisplayEl: !!tomatoTimerDisplayEl,
                modeBtnsCount: tomatoModeBtns.length
            });
            
            if (tomatoCountEl) {
                tomatoCountEl.textContent = tomatoCount;
            }

            function updateTomatoCurrentTime() {
                if (!tomatoCurrentTimeEl) return;
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                tomatoCurrentTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
            }

            tomatoModeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (tomatoIsRunning) {
                        clearInterval(tomatoTimerInterval);
                        cancelAnimationFrame(tomatoTimerInterval);
                        tomatoIsRunning = false;
                        tomatoLastTickTime = null;
                        const startBtn = document.getElementById('tomatoStartBtn');
                        if (startBtn) startBtn.textContent = 'ÂºÄÂßã';
                    }
                    tomatoModeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    tomatoCountdownTime = parseInt(btn.dataset.time) || 1500;
                    updateTomatoTimerDisplay();
                });
            });

            if (tomatoStartBtn) {
                console.log('ÁªëÂÆöÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂');
                tomatoStartBtn.addEventListener('click', function() {
                    console.log('ÂºÄÂßãÊåâÈíÆË¢´ÁÇπÂáª, ÂΩìÂâçÁä∂ÊÄÅ:', tomatoIsRunning);
                    if (tomatoIsRunning) {
                        clearInterval(tomatoTimerInterval);
                        cancelAnimationFrame(tomatoTimerInterval);
                        tomatoIsRunning = false;
                        tomatoLastTickTime = null;
                        this.textContent = 'ÂºÄÂßã';
                    } else {
                        tomatoIsRunning = true;
                        this.textContent = 'ÊöÇÂÅú';
                        tomatoLastTickTime = Date.now();
                        tomatoTick();
                    }
                });
            } else {
                console.warn('Êú™ÊâæÂà∞ÂºÄÂßãÊåâÈíÆ');
            }

            if (tomatoResetBtn) {
                tomatoResetBtn.addEventListener('click', () => {
                    clearInterval(tomatoTimerInterval);
                    cancelAnimationFrame(tomatoTimerInterval);
                    tomatoIsRunning = false;
                    tomatoLastTickTime = null;
                    const startBtn = document.getElementById('tomatoStartBtn');
                    if (startBtn) startBtn.textContent = 'ÂºÄÂßã';
                    const activeMode = document.querySelector('.tomato-mode-btn.active');
                    if (activeMode) {
                        tomatoCountdownTime = parseInt(activeMode.dataset.time) || 1500;
                    }
                    updateTomatoTimerDisplay();
                });
            }

            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂Â§ÑÁêÜ
            document.addEventListener('visibilitychange', () => {
                if (tomatoIsRunning) {
                    if (document.hidden) {
                        // È°µÈù¢ÈöêËóèÊó∂ËÆ∞ÂΩïÊó∂Èó¥
                        tomatoLastTickTime = Date.now();
                    } else {
                        // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çËÆ°Êó∂
                        const now = Date.now();
                        const elapsed = Math.floor((now - tomatoLastTickTime) / 1000);
                        if (elapsed > 0) {
                            tomatoCountdownTime = Math.max(0, tomatoCountdownTime - elapsed);
                            updateTomatoTimerDisplay();
                            if (tomatoCountdownTime <= 0) {
                                completeTomatoSession();
                            }
                        }
                        tomatoLastTickTime = now;
                    }
                }
            });

            setInterval(updateTomatoCurrentTime, 1000);
            updateTomatoCurrentTime();
            updateTomatoTimerDisplay();
            
            tomatoIsInitialized = true;
            console.log('Áï™ËåÑÊó∂ÈíüÂàùÂßãÂåñÂÆåÊàê');
        }

        // ========== ËØæË°®Á®ãÂ∫è ==========
        const scheduleColors = [
            '#007aff', '#ff2d55', '#5856d6', '#34c759',
            '#ff9500', '#00c7be', '#af52de', '#ff3b30'
        ];
        let scheduleData = {};
        let scheduleTimeSlots = [
            '08:00-08:45', '08:55-09:40', '10:00-10:45', '10:55-11:40',
            '14:00-14:45', '14:55-15:40', '16:00-16:45', '16:55-17:40',
            '19:00-19:45', '19:55-20:40'
        ];
        let scheduleCurrentCell = null;
        let scheduleCurrentCourseId = null;
        let scheduleSelectedColor = scheduleColors[0];
        let scheduleCurrentWeekOffset = 0;
        let scheduleWeekStartDate = null;
        const scheduleDays = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'];



        function calculateWeekDates() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            scheduleWeekStartDate = new Date(today);
            scheduleWeekStartDate.setDate(today.getDate() + mondayOffset + (scheduleCurrentWeekOffset * 7));
            updateWeekDisplay();
        }

        function updateWeekDisplay() {
            const endDate = new Date(scheduleWeekStartDate);
            endDate.setDate(scheduleWeekStartDate.getDate() + 6);
            const startStr = formatScheduleDate(scheduleWeekStartDate);
            const endStr = formatScheduleDate(endDate);
            document.getElementById('weekDisplay').textContent = `${startStr} Ëá≥ ${endStr}`;
            for (let i = 0; i < 7; i++) {
                const date = new Date(scheduleWeekStartDate);
                date.setDate(scheduleWeekStartDate.getDate() + i);
                document.getElementById(`date-${i}`).textContent = formatShortScheduleDate(date);
            }
        }

        function formatScheduleDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}Âπ¥${month}Êúà${day}Êó•`;
        }

        function formatShortScheduleDate(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        function changeWeek(offset) {
            scheduleCurrentWeekOffset += offset;
            calculateWeekDates();
            renderScheduleTable();
        }

        function goToThisWeek() {
            scheduleCurrentWeekOffset = 0;
            calculateWeekDates();
            renderScheduleTable();
        }

        function getScheduleWeekKey() {
            const year = scheduleWeekStartDate.getFullYear();
            const month = String(scheduleWeekStartDate.getMonth() + 1).padStart(2, '0');
            const day = String(scheduleWeekStartDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getCurrentWeekSchedule() {
            const weekKey = getScheduleWeekKey();
            if (!scheduleData[weekKey]) {
                scheduleData[weekKey] = {};
            }
            return scheduleData[weekKey];
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const currentSchedule = getCurrentWeekSchedule();
            scheduleTimeSlots.forEach((time, timeIndex) => {
                const tr = document.createElement('tr');
                const timeTd = document.createElement('td');
                timeTd.className = 'schedule-time-column';
                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.className = 'schedule-time-input';
                timeInput.value = time;
                timeInput.dataset.index = timeIndex;
                timeInput.onchange = (e) => updateScheduleTimeSlot(timeIndex, e.target.value);
                timeTd.appendChild(timeInput);
                tr.appendChild(timeTd);
                scheduleDays.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.dataset.day = dayIndex;
                    td.dataset.time = timeIndex;
                    td.onclick = () => openScheduleModal(dayIndex, timeIndex);
                    const courseId = `${dayIndex}-${timeIndex}`;
                    if (currentSchedule[courseId]) {
                        const course = currentSchedule[courseId];
                        const courseCard = document.createElement('div');
                        courseCard.className = 'schedule-course-card';
                        courseCard.style.backgroundColor = course.color;
                        courseCard.onclick = (e) => {
                            e.stopPropagation();
                            openScheduleModal(dayIndex, timeIndex, courseId);
                        };
                        courseCard.innerHTML = `
                            <div class="schedule-course-name">${course.name}</div>
                            <div class="schedule-course-location">${course.location}</div>
                        `;
                        td.appendChild(courseCard);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function updateScheduleTimeSlot(index, value) {
            scheduleTimeSlots[index] = value;
            saveScheduleData();
        }

        function renderScheduleColorPicker() {
            const colorPicker = document.getElementById('colorPicker');
            if (!colorPicker) return;
            colorPicker.innerHTML = '';
            scheduleColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'schedule-color-option' + (index === 0 ? ' selected' : '');
                colorOption.style.backgroundColor = color;
                colorOption.onclick = () => selectScheduleColor(color, colorOption);
                colorPicker.appendChild(colorOption);
            });
        }

        function selectScheduleColor(color, element) {
            scheduleSelectedColor = color;
            document.querySelectorAll('.schedule-color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function openScheduleModal(dayIndex, timeIndex, courseId = null) {
            scheduleCurrentCell = { day: dayIndex, time: timeIndex };
            scheduleCurrentCourseId = courseId;
            const currentSchedule = getCurrentWeekSchedule();
            const modalTitle = document.getElementById('modalTitle');
            const deleteButtonContainer = document.getElementById('deleteButtonContainer');
            if (courseId && currentSchedule[courseId]) {
                const course = currentSchedule[courseId];
                modalTitle.textContent = 'ÁºñËæëËØæÁ®ã';
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseLocation').value = course.location;
                document.getElementById('courseTeacher').value = course.teacher;
                scheduleSelectedColor = course.color;
                deleteButtonContainer.style.display = 'flex';
                document.querySelectorAll('.schedule-color-option').forEach(el => {
                    el.classList.toggle('selected', el.style.backgroundColor === course.color);
                });
            } else {
                modalTitle.textContent = 'Ê∑ªÂä†ËØæÁ®ã';
                document.getElementById('courseName').value = '';
                document.getElementById('courseLocation').value = '';
                document.getElementById('courseTeacher').value = '';
                scheduleSelectedColor = scheduleColors[0];
                deleteButtonContainer.style.display = 'none';
                document.querySelectorAll('.schedule-color-option').forEach((el, index) => {
                    el.classList.toggle('selected', index === 0);
                });
            }
            document.getElementById('courseModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('courseModal').classList.remove('show');
            scheduleCurrentCell = null;
            scheduleCurrentCourseId = null;
        }

        function saveCourse() {
            const name = document.getElementById('courseName').value.trim();
            const location = document.getElementById('courseLocation').value.trim();
            const teacher = document.getElementById('courseTeacher').value.trim();
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ËØæÁ®ãÂêçÁß∞');
                return;
            }
            const weekKey = getScheduleWeekKey();
            const courseId = `${scheduleCurrentCell.day}-${scheduleCurrentCell.time}`;
            if (!scheduleData[weekKey]) {
                scheduleData[weekKey] = {};
            }
            scheduleData[weekKey][courseId] = {
                name,
                location,
                teacher,
                color: scheduleSelectedColor,
                day: scheduleCurrentCell.day,
                time: scheduleCurrentCell.time
            };
            saveScheduleData();
            renderScheduleTable();
            closeModal();
        }

        function deleteCourse() {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈó®ËØæÁ®ãÂêóÔºü')) {
                const weekKey = getScheduleWeekKey();
                delete scheduleData[weekKey][scheduleCurrentCourseId];
                saveScheduleData();
                renderScheduleTable();
                closeModal();
            }
        }

        function saveScheduleData() {
            const data = {
                schedule: scheduleData,
                timeSlots: scheduleTimeSlots
            };
            localStorage.setItem('scheduleData', JSON.stringify(data));
        }

        function loadScheduleData() {
            const saved = localStorage.getItem('scheduleData');
            if (saved) {
                const data = JSON.parse(saved);
                scheduleData = data.schedule || {};
                scheduleTimeSlots = data.timeSlots || scheduleTimeSlots;
            }
        }

        function clearAllCourses() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Êú¨Âë®ÊâÄÊúâËØæÁ®ãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                const weekKey = getScheduleWeekKey();
                scheduleData[weekKey] = {};
                saveScheduleData();
                renderScheduleTable();
            }
        }

        function addScheduleRow() {
            const newTime = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊó∂Èó¥ÊÆµÔºà‰æãÂ¶ÇÔºö21:00-21:45ÔºâÔºö');
            if (newTime && newTime.trim()) {
                scheduleTimeSlots.push(newTime.trim());
                renderScheduleTable();
                showNotification('Â∑≤Ê∑ªÂä†Êñ∞Ë°å', 'success');
            }
        }

        function deleteScheduleRow() {
            if (scheduleTimeSlots.length === 0) {
                showNotification('Ê≤°ÊúâÂèØÂà†Èô§ÁöÑË°å', 'warning');
                return;
            }
            
            const index = prompt(`ËØ∑ËæìÂÖ•Ë¶ÅÂà†Èô§ÁöÑË°åÂè∑Ôºà1-${scheduleTimeSlots.length}ÔºâÔºö`);
            const rowIndex = parseInt(index) - 1;
            
            if (isNaN(rowIndex) || rowIndex < 0 || rowIndex >= scheduleTimeSlots.length) {
                showNotification('Êó†ÊïàÁöÑË°åÂè∑', 'warning');
                return;
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Á¨¨ ${index} Ë°åÔºà${scheduleTimeSlots[rowIndex]}ÔºâÂêóÔºüËØ•Ë°åÁöÑËØæÁ®ãÊï∞ÊçÆ‰πü‰ºöË¢´Âà†Èô§„ÄÇ`)) {
                // Âà†Èô§ËØ•Êó∂Èó¥ÊÆµÁöÑËØæÁ®ãÊï∞ÊçÆ
                const weekKey = getScheduleWeekKey();
                if (scheduleData[weekKey]) {
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const courseId = `${dayIndex}-${rowIndex}`;
                        delete scheduleData[weekKey][courseId];
                    }
                    // ÈáçÊñ∞Ë∞ÉÊï¥ÂÖ∂‰ªñË°åÁöÑÁ¥¢Âºï
                    const newData = {};
                    Object.keys(scheduleData[weekKey]).forEach(key => {
                        const [day, timeIdx] = key.split('-').map(Number);
                        if (timeIdx > rowIndex) {
                            newData[`${day}-${timeIdx - 1}`] = scheduleData[weekKey][key];
                        } else if (timeIdx < rowIndex) {
                            newData[key] = scheduleData[weekKey][key];
                        }
                    });
                    scheduleData[weekKey] = newData;
                    saveScheduleData();
                }
                
                scheduleTimeSlots.splice(rowIndex, 1);
                renderScheduleTable();
                showNotification('Â∑≤Âà†Èô§ËØ•Ë°å', 'success');
            }
        }

        function resetSchedule() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆËØæÁ®ãË°®ÂêóÔºüËøôÂ∞ÜÊÅ¢Â§çÈªòËÆ§ÁöÑÊó∂Èó¥ÊÆµËÆæÁΩÆÔºå‰ΩÜ‰ºö‰øùÁïôËØæÁ®ãÊï∞ÊçÆ„ÄÇ')) {
                scheduleTimeSlots = [
                    '08:00-08:45', '08:55-09:40', '10:00-10:45', '10:55-11:40',
                    '14:00-14:45', '14:55-15:40', '16:00-16:45', '16:55-17:40',
                    '19:00-19:45', '19:55-20:40'
                ];
                renderScheduleTable();
                showNotification('ËØæÁ®ãË°®Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº', 'success');
            }
        }

        function exportToPDF() {
            const element = document.getElementById('scheduleContainer');
            
            // ‰∏¥Êó∂‰øÆÊîπÊ†∑Âºè‰ª•‰ºòÂåñPDFËæìÂá∫
            const originalPadding = element.style.padding;
            const originalMargin = element.style.margin;
            element.style.padding = '5px';
            element.style.margin = '0';
            
            const opt = {
                margin: [5, 5, 5, 5],
                filename: `ËØæË°®_${getScheduleWeekKey()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'landscape'
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break-before',
                    after: '.page-break-after',
                    avoid: 'tr'
                }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // ÊÅ¢Â§çÂéüÂßãÊ†∑Âºè
                element.style.padding = originalPadding;
                element.style.margin = originalMargin;
                showNotification('ËØæË°®Â∑≤ÂØºÂá∫PDF', 'success');
            });
        }

        function exportToExcel() {
            const currentSchedule = getCurrentWeekSchedule();
            const weekKey = getScheduleWeekKey();
            const data = [];
            const headers = ['Êó∂Èó¥'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(scheduleWeekStartDate);
                date.setDate(scheduleWeekStartDate.getDate() + i);
                headers.push(`${scheduleDays[i]} ${formatShortScheduleDate(date)}`);
            }
            data.push(headers);
            scheduleTimeSlots.forEach((time, timeIndex) => {
                const row = [time];
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const courseId = `${dayIndex}-${timeIndex}`;
                    if (currentSchedule[courseId]) {
                        const course = currentSchedule[courseId];
                        row.push(`${course.name} | ${course.location} | ${course.teacher}`);
                    } else {
                        row.push('');
                    }
                }
                data.push(row);
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ËØæË°®');
            XLSX.writeFile(wb, `ËØæË°®_${weekKey}.xlsx`);
        }

        // ========== ÊúàËÆ°Âàí ==========
        let monthPlans = {};
        let currentMonthDate = new Date();
        let currentSelectedDate = null;
        let editingMonthPlanId = null;
        let monthPlanSelectedColor = scheduleColors[0];
        const MONTH_PLAN_STORAGE = 'monthPlansData';

        function initSchedule() {
            loadScheduleData();
            loadMonthPlans();
            calculateWeekDates();
            renderScheduleTable();
            renderScheduleColorPicker();
            renderMonthCalendar();
            updateMonthDisplay();
        }

        function switchScheduleView(view) {
            const views = ['week', 'month'];
            views.forEach(v => {
                const tab = document.getElementById(`schedule-tab-${v}`);
                const module = document.getElementById(`schedule-module-${v}`);
                if (tab) {
                    tab.classList.toggle('active', v === view);
                }
                if (module) {
                    module.classList.toggle('hidden', v !== view);
                }
            });
            
            if (view === 'month') {
                renderMonthCalendar();
            }
        }

        function getDayKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDayDisplay(date) {
            const days = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            const d = new Date(date);
            return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó• ${days[d.getDay()]}`;
        }

        function formatMonthDisplay(date) {
            const d = new Date(date);
            return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà`;
        }

        function changeMonth(offset) {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + offset);
            updateMonthDisplay();
            renderMonthCalendar();
        }

        function goToThisMonth() {
            currentMonthDate = new Date();
            updateMonthDisplay();
            renderMonthCalendar();
        }

        function updateMonthDisplay() {
            const display = document.getElementById('monthDisplay');
            if (display) {
                display.textContent = formatMonthDisplay(currentMonthDate);
            }
        }

        function loadMonthPlans() {
            const saved = loadFromStorage(MONTH_PLAN_STORAGE, {});
            monthPlans = saved;
        }

        function saveMonthPlans() {
            saveToStorage(MONTH_PLAN_STORAGE, monthPlans);
        }

        function getMonthPlansForDate(dateKey) {
            return monthPlans[dateKey] || [];
        }

        function renderMonthCalendar() {
            const container = document.getElementById('monthCalendar');
            if (!container) return;

            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const todayKey = getDayKey(today);
            const weekDays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];

            let html = '';
            
            weekDays.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });

            const prevMonth = new Date(year, month, 0);
            const prevDays = prevMonth.getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDays - i;
                const date = new Date(year, month - 1, day);
                const dateKey = getDayKey(date);
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, true);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = getDayKey(date);
                const isToday = dateKey === todayKey;
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, false, isToday);
            }

            const totalCells = startDay + daysInMonth;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dateKey = getDayKey(date);
                const plans = getMonthPlansForDate(dateKey);
                html += renderCalendarDay(day, dateKey, plans, true);
            }

            container.innerHTML = html;
        }

        function renderCalendarDay(day, dateKey, plans, isOtherMonth, isToday = false) {
            const dots = plans.slice(0, 3).map(p => 
                `<div class="calendar-dot" style="background-color: ${p.color};"></div>`
            ).join('');
            
            let classes = 'calendar-day';
            if (isOtherMonth) classes += ' other-month';
            if (isToday) classes += ' today';
            
            return `
                <div class="${classes}" onclick="selectCalendarDay('${dateKey}')">
                    <div class="calendar-day-number">${day}</div>
                    ${dots ? `<div class="calendar-dots">${dots}</div>` : ''}
                </div>
            `;
        }

        function selectCalendarDay(dateKey) {
            currentSelectedDate = dateKey;
            const [year, month, day] = dateKey.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            const days = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            document.getElementById('selectedDateTitle').textContent = `${year}Âπ¥${month}Êúà${day}Êó• ${days[d.getDay()]}`;
            
            document.getElementById('monthPlanDetail').style.display = 'block';
            renderMonthPlanList(dateKey);
            
            // ÁßªÈô§ÂÖ∂‰ªñÊó•ÊúüÁöÑÈÄâ‰∏≠Ê†∑Âºè
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('selected');
                el.style.borderColor = 'transparent';
            });
            
            // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Ê†∑Âºè
            const calendarDays = document.querySelectorAll('.calendar-day');
            calendarDays.forEach(el => {
                if (el.getAttribute('onclick') && el.getAttribute('onclick').includes(dateKey)) {
                    el.classList.add('selected');
                    el.style.borderColor = 'var(--primary-color)';
                }
            });
        }

        function renderMonthPlanList(dateKey) {
            const container = document.getElementById('monthPlanList');
            const plans = getMonthPlansForDate(dateKey);
            
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <i class="fa fa-calendar-check-o text-4xl mb-4"></i>
                        <p>ÊöÇÊó†ËÆ°ÂàíÔºåÁÇπÂáª„ÄåÊ∑ªÂä†ËÆ°Âàí„ÄçÂºÄÂßãÂÆâÊéí</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => `
                <div class="day-plan-item" data-id="${plan.id}" style="border-left-color: ${plan.color};">
                    <div class="day-plan-content" style="flex: 1;">
                        <div class="day-plan-title" style="color: ${plan.color};">${escapeHTML(plan.title)}</div>
                        ${plan.content ? `<div class="day-plan-desc">${escapeHTML(plan.content)}</div>` : ''}
                    </div>
                    <div class="day-plan-actions">
                        <button class="day-plan-action-btn edit" onclick="editMonthPlan('${dateKey}', '${plan.id}')" title="ÁºñËæë">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="day-plan-action-btn delete" onclick="deleteMonthPlanById('${plan.id}')" title="Âà†Èô§">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openMonthPlanModal(dateKey = null) {
            editingMonthPlanId = null;
            document.getElementById('monthPlanModalTitle').textContent = 'Ê∑ªÂä†ÊúàËÆ°Âàí';
            document.getElementById('monthPlanTitle').value = '';
            document.getElementById('monthPlanContent').value = '';
            document.getElementById('monthPlanDate').value = dateKey || getDayKey(new Date());
            document.getElementById('monthPlanDeleteContainer').style.display = 'none';
            monthPlanSelectedColor = scheduleColors[0];
            renderMonthPlanColorPicker();
            document.getElementById('monthPlanModal').classList.add('show');
        }

        function closeMonthPlanModal() {
            document.getElementById('monthPlanModal').classList.remove('show');
            editingMonthPlanId = null;
        }

        function editMonthPlan(dateKey, id) {
            const plans = monthPlans[dateKey] || [];
            const plan = plans.find(p => p.id === id);
            
            if (!plan) return;
            
            editingMonthPlanId = id;
            document.getElementById('monthPlanModalTitle').textContent = 'ÁºñËæëÊúàËÆ°Âàí';
            document.getElementById('monthPlanTitle').value = plan.title;
            document.getElementById('monthPlanContent').value = plan.content || '';
            document.getElementById('monthPlanDate').value = dateKey;
            document.getElementById('monthPlanDeleteContainer').style.display = 'flex';
            monthPlanSelectedColor = plan.color;
            renderMonthPlanColorPicker();
            document.getElementById('monthPlanModal').classList.add('show');
        }

        function saveMonthPlan() {
            const title = document.getElementById('monthPlanTitle').value.trim();
            const content = document.getElementById('monthPlanContent').value.trim();
            const dateKey = document.getElementById('monthPlanDate').value;
            
            if (!title) {
                showNotification('ËØ∑ËæìÂÖ•ËÆ°ÂàíÊ†áÈ¢ò', 'warning');
                return;
            }
            
            if (!monthPlans[dateKey]) {
                monthPlans[dateKey] = [];
            }
            
            if (editingMonthPlanId) {
                const index = monthPlans[dateKey].findIndex(p => p.id === editingMonthPlanId);
                if (index !== -1) {
                    monthPlans[dateKey][index] = {
                        ...monthPlans[dateKey][index],
                        title,
                        content,
                        color: monthPlanSelectedColor
                    };
                }
                showNotification('ËÆ°ÂàíÂ∑≤Êõ¥Êñ∞', 'success');
            } else {
                monthPlans[dateKey].push({
                    id: Date.now().toString(),
                    title,
                    content,
                    color: monthPlanSelectedColor,
                    createdAt: new Date().toISOString()
                });
                showNotification('ËÆ°ÂàíÂ∑≤Ê∑ªÂä†', 'success');
            }
            
            saveMonthPlans();
            renderMonthCalendar();
            if (currentSelectedDate) {
                renderMonthPlanList(currentSelectedDate);
            }
            closeMonthPlanModal();
        }

        function deleteMonthPlan() {
            if (!editingMonthPlanId) return;
            
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÆ°ÂàíÂêóÔºü')) {
                deleteMonthPlanById(editingMonthPlanId);
                closeMonthPlanModal();
            }
        }

        function deleteMonthPlanById(id) {
            Object.keys(monthPlans).forEach(dateKey => {
                monthPlans[dateKey] = monthPlans[dateKey].filter(p => p.id !== id);
                if (monthPlans[dateKey].length === 0) {
                    delete monthPlans[dateKey];
                }
            });
            saveMonthPlans();
            renderMonthCalendar();
            if (currentSelectedDate) {
                renderMonthPlanList(currentSelectedDate);
            }
            showNotification('ËÆ°ÂàíÂ∑≤Âà†Èô§', 'success');
        }

        function renderMonthPlanColorPicker() {
            const colorPicker = document.getElementById('monthPlanColorPicker');
            if (!colorPicker) return;
            
            colorPicker.innerHTML = '';
            scheduleColors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'schedule-color-option' + (color === monthPlanSelectedColor ? ' selected' : '');
                colorOption.style.backgroundColor = color;
                colorOption.onclick = () => {
                    monthPlanSelectedColor = color;
                    renderMonthPlanColorPicker();
                };
                colorPicker.appendChild(colorOption);
            });
        }

        function exportMonthPlanToPDF() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const allPlans = [];
            Object.keys(monthPlans).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    monthPlans[dateKey].forEach(plan => {
                        allPlans.push({
                            date: dateKey,
                            ...plan
                        });
                    });
                }
            });
            
            if (allPlans.length === 0) {
                showNotification('Êú¨ÊúàÊöÇÊó†ËÆ°ÂàíÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            const container = document.createElement('div');
            container.style.cssText = 'padding: 40px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: white;';
            
            allPlans.sort((a, b) => a.date.localeCompare(b.date));
            
            const groupedPlans = {};
            allPlans.forEach(plan => {
                if (!groupedPlans[plan.date]) {
                    groupedPlans[plan.date] = [];
                }
                groupedPlans[plan.date].push(plan);
            });
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0071e3; padding-bottom: 20px;">
                    <h1 style="color: #1d1d1f; margin: 0; font-size: 28px;">ÊúàËÆ°Âàí</h1>
                    <p style="color: #86868b; margin: 10px 0 0; font-size: 18px;">${formatMonthDisplay(currentMonthDate)}</p>
                </div>
                <div style="margin-top: 20px;">
                    ${Object.keys(groupedPlans).sort().map(dateKey => {
                        const [y, m, d] = dateKey.split('-').map(Number);
                        const date = new Date(y, m - 1, d);
                        const days = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
                        return `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #0071e3; font-size: 18px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e5e5e7;">
                                    üìÖ ${m}Êúà${d}Êó• ${days[date.getDay()]}
                                </h3>
                                ${groupedPlans[dateKey].map((plan, index) => `
                                    <div style="margin-bottom: 12px; padding: 12px; border-left: 4px solid ${plan.color}; background: #f5f5f7; border-radius: 8px; margin-left: 10px;">
                                        <div style="font-weight: 600; font-size: 15px; color: ${plan.color}; margin-bottom: 6px;">
                                            ${index + 1}. ${escapeHTML(plan.title)}
                                        </div>
                                        ${plan.content ? `<div style="color: #555; font-size: 14px; line-height: 1.5;">${escapeHTML(plan.content)}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e5e7; text-align: center; color: #86868b; font-size: 12px;">
                    Áã¨Á´ãÊï∞Â≠¶ËÄÅÂ∏àËæÖÂä©Â∑•ÂÖ∑ - ÊúàËÆ°ÂàíÂØºÂá∫
                </div>
            `;
            
            const opt = {
                margin: 10,
                filename: `ÊúàËÆ°Âàí_${monthKey}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            document.body.appendChild(container);
            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
                showNotification('ÊúàËÆ°ÂàíÂ∑≤ÂØºÂá∫PDF', 'success');
            });
        }

        function exportMonthPlanToExcel() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth();
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const allPlans = [];
            Object.keys(monthPlans).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    monthPlans[dateKey].forEach(plan => {
                        allPlans.push({
                            date: dateKey,
                            ...plan
                        });
                    });
                }
            });
            
            if (allPlans.length === 0) {
                showNotification('Êú¨ÊúàÊöÇÊó†ËÆ°ÂàíÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            // ÊåâÊó•ÊúüÊéíÂ∫è
            allPlans.sort((a, b) => a.date.localeCompare(b.date));
            
            // ÂáÜÂ§áExcelÊï∞ÊçÆ
            const data = [];
            const headers = ['Êó•Êúü', 'ÊòüÊúü', 'ËÆ°ÂàíÊ†áÈ¢ò', 'ËÆ°ÂàíÂÜÖÂÆπ', 'ÂàõÂª∫Êó∂Èó¥'];
            data.push(headers);
            
            const days = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            
            allPlans.forEach(plan => {
                const [y, m, d] = plan.date.split('-').map(Number);
                const date = new Date(y, m - 1, d);
                const dayOfWeek = days[date.getDay()];
                const createdAt = plan.createdAt ? new Date(plan.createdAt).toLocaleString('zh-CN') : '';
                
                data.push([
                    plan.date,
                    dayOfWeek,
                    plan.title,
                    plan.content || '',
                    createdAt
                ]);
            });
            
            // ÂàõÂª∫ExcelÂ∑•‰ΩúË°®
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // ËÆæÁΩÆÂàóÂÆΩ
            ws['!cols'] = [
                { wch: 12 },  // Êó•Êúü
                { wch: 8 },   // ÊòüÊúü
                { wch: 30 },  // ËÆ°ÂàíÊ†áÈ¢ò
                { wch: 50 },  // ËÆ°ÂàíÂÜÖÂÆπ
                { wch: 20 }   // ÂàõÂª∫Êó∂Èó¥
            ];
            
            // ÂàõÂª∫Â∑•‰ΩúÁ∞øÂπ∂ÂØºÂá∫
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ÊúàËÆ°Âàí');
            XLSX.writeFile(wb, `ÊúàËÆ°Âàí_${monthKey}.xlsx`);
            
            showNotification('ÊúàËÆ°ÂàíÂ∑≤ÂØºÂá∫Excel', 'success');
        }

        // ========== Âá†‰ΩïÁªòÂõæÁ®ãÂ∫è ==========
        let geometryCanvas = null;
        let geometryCtx = null;
        let geometryShapes = [];
        let geometryHistory = [];
        let geometryCurrentTool = 'select';
        let geometryCurrentColor = '#0071e3';
        let geometryCurrentFill = 'transparent';
        let geometryCurrentLineWidth = 2;
        let geometryIsDrawing = false;
        let geometryStartPoint = null;
        let geometryTempShape = null;
        let geometryShowGrid = true;
        let geometrySelectedShape = null;
        let geometryIsResizing = false;
        let geometryIsRotating = false;
        let geometryResizeHandle = null;
        let geometryRotationCenter = null;
        let geometryInitialAngle = 0;
        let geometryInitialShapeState = null;

        function initGeometryDrawing() {
            geometryCanvas = document.getElementById('geometry-canvas');
            if (!geometryCanvas) return;
            
            geometryCtx = geometryCanvas.getContext('2d');
            
            // Âª∂ËøüÂàùÂßãÂåñÔºåÁ°Æ‰øùÂÆπÂô®Â∑≤Ê∏≤Êüì
            setTimeout(() => {
                resizeGeometryCanvas();
                redrawGeometryCanvas();
            }, 100);
            
            // ÁªëÂÆöÂ∑•ÂÖ∑ÊåâÈíÆ
            document.querySelectorAll('.geometry-tool-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryTool(btn.dataset.tool));
            });
            
            // ÁªëÂÆöÈ¢úËâ≤ÊåâÈíÆ
            document.querySelectorAll('.geometry-color-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryColor(btn.dataset.color));
            });
            
            // ÁªëÂÆöÂ°´ÂÖÖÊåâÈíÆ
            document.querySelectorAll('.geometry-fill-btn').forEach(btn => {
                btn.addEventListener('click', () => selectGeometryFill(btn.dataset.fill));
            });
            
            // ÁªëÂÆöÁ∫øÊù°Á≤óÁªÜ
            const lineWidthSlider = document.getElementById('geometry-line-width');
            if (lineWidthSlider) {
                lineWidthSlider.addEventListener('input', (e) => {
                    geometryCurrentLineWidth = parseInt(e.target.value);
                    document.getElementById('geometry-line-width-value').textContent = e.target.value + 'px';
                });
            }
            
            // ÁªëÂÆöÁîªÂ∏É‰∫ã‰ª∂
            geometryCanvas.addEventListener('mousedown', handleGeometryMouseDown);
            geometryCanvas.addEventListener('mousemove', handleGeometryMouseMove);
            geometryCanvas.addEventListener('mouseup', handleGeometryMouseUp);
            geometryCanvas.addEventListener('mouseleave', handleGeometryMouseUp);
            geometryCanvas.addEventListener('dblclick', handleGeometryDoubleClick);
            geometryCanvas.addEventListener('contextmenu', handleGeometryRightClick);
            
            // ÁªëÂÆöÊìç‰ΩúÊåâÈíÆ
            document.getElementById('geometry-clear')?.addEventListener('click', clearGeometryCanvas);
            document.getElementById('geometry-undo')?.addEventListener('click', undoGeometry);
            document.getElementById('geometry-export')?.addEventListener('click', exportGeometryImage);
            document.getElementById('geometry-grid-toggle')?.addEventListener('click', toggleGeometryGrid);
            
            // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈáçÊñ∞Ë∞ÉÊï¥ÁîªÂ∏É
            window.addEventListener('resize', () => {
                resizeGeometryCanvas();
                redrawGeometryCanvas();
            });
        }

        function resizeGeometryCanvas() {
            if (!geometryCanvas) return;
            const rect = geometryCanvas.parentElement.getBoundingClientRect();
            geometryCanvas.width = rect.width;
            geometryCanvas.height = rect.height;
        }

        function selectGeometryTool(tool) {
            geometryCurrentTool = tool;
            document.querySelectorAll('.geometry-tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
            geometryCanvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';
            
            // ÊòæÁ§∫/ÈöêËóèÊ≠£Â§öËæπÂΩ¢ËÆæÁΩÆÈù¢Êùø
            const polygonSettings = document.getElementById('regular-polygon-settings');
            if (polygonSettings) {
                polygonSettings.classList.toggle('hidden', tool !== 'regular-polygon');
            }
            
            // Ê∏ÖÈô§‰∏¥Êó∂ÂõæÂΩ¢
            geometryTempShape = null;
            redrawGeometryCanvas();
        }

        function selectGeometryColor(color) {
            geometryCurrentColor = color;
            document.querySelectorAll('.geometry-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.color === color);
            });
        }

        function selectGeometryFill(fill) {
            geometryCurrentFill = fill;
            document.querySelectorAll('.geometry-fill-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.fill === fill);
            });
        }

        function getGeometryMousePos(e) {
            const rect = geometryCanvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function handleGeometryMouseDown(e) {
            const pos = getGeometryMousePos(e);
            geometryStartPoint = pos;
            
            if (geometryCurrentTool === 'select') {
                // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜË∞ÉÊï¥Â§ßÂ∞èÊéßÂà∂ÁÇπ
                if (geometrySelectedShape !== null) {
                    const resizeHandle = getResizeHandleAtPosition(pos, geometryShapes[geometrySelectedShape]);
                    if (resizeHandle) {
                        geometryIsResizing = true;
                        geometryResizeHandle = resizeHandle;
                        geometryInitialShapeState = JSON.parse(JSON.stringify(geometryShapes[geometrySelectedShape]));
                        return;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÊóãËΩ¨ÊâãÊüÑ
                    if (isRotationHandleAtPosition(pos, geometryShapes[geometrySelectedShape])) {
                        geometryIsRotating = true;
                        geometryRotationCenter = getShapeCenter(geometryShapes[geometrySelectedShape]);
                        geometryInitialAngle = Math.atan2(pos.y - geometryRotationCenter.y, pos.x - geometryRotationCenter.x);
                        geometryInitialShapeState = JSON.parse(JSON.stringify(geometryShapes[geometrySelectedShape]));
                        return;
                    }
                }
                
                // ÈÄâÊã©Â∑•ÂÖ∑ÔºöÂ∞ùËØïÈÄâ‰∏≠ÂõæÂΩ¢
                const clickedShapeIndex = findShapeAtPosition(pos);
                if (clickedShapeIndex !== -1) {
                    geometrySelectedShape = clickedShapeIndex;
                    geometryIsDrawing = true; // Áî®‰∫éÊãñÊãΩ
                    redrawGeometryCanvas();
                } else {
                    geometrySelectedShape = null;
                    redrawGeometryCanvas();
                }
                return;
            } else if (geometryCurrentTool === 'point') {
                addGeometryShape({
                    type: 'point',
                    x: pos.x,
                    y: pos.y,
                    color: geometryCurrentColor,
                    lineWidth: geometryCurrentLineWidth
                });
                geometryIsDrawing = false;
            } else if (geometryCurrentTool === 'polygon') {
                // Â§öËæπÂΩ¢ÁâπÊÆäÂ§ÑÁêÜÔºöÁÇπÂáªÊ∑ªÂä†È°∂ÁÇπ
                if (!geometryTempShape) {
                    geometryTempShape = {
                        type: 'polygon',
                        points: [pos],
                        color: geometryCurrentColor,
                        fill: geometryCurrentFill,
                        lineWidth: geometryCurrentLineWidth
                    };
                } else {
                    geometryTempShape.points.push(pos);
                    redrawGeometryCanvas();
                }
            } else if (geometryCurrentTool === 'regular-polygon') {
                // Ê≠£Â§öËæπÂΩ¢ÔºöÂºÄÂßãÁªòÂà∂
                geometryIsDrawing = true;
                const sidesInput = document.getElementById('polygon-sides');
                const sides = sidesInput ? parseInt(sidesInput.value) || 5 : 5;
                geometryTempShape = {
                    type: 'regular-polygon',
                    centerX: pos.x,
                    centerY: pos.y,
                    radius: 0,
                    sides: sides,
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth,
                    rotation: 0
                };
            } else {
                // ÂÖ∂‰ªñÂ∑•ÂÖ∑Ôºöline, segment, circle, rectangle, triangle
                geometryIsDrawing = true;
            }
        }

        // Êü•ÊâæÁÇπÂáª‰ΩçÁΩÆ‰∏äÁöÑÂõæÂΩ¢
        function findShapeAtPosition(pos) {
            const hitRadius = 10; // ÁÇπÂáªÊ£ÄÊµãÂçäÂæÑ
            
            // ‰ªéÂêéÂêëÂâçÊü•ÊâæÔºàÂÖàÁªòÂà∂Âú®‰∏äÂ±ÇÔºâ
            for (let i = geometryShapes.length - 1; i >= 0; i--) {
                const shape = geometryShapes[i];
                if (isPointOnShape(pos, shape, hitRadius)) {
                    return i;
                }
            }
            return -1;
        }

        // Ëé∑ÂèñÂõæÂΩ¢ÁöÑ‰∏≠ÂøÉÁÇπ
        function getShapeCenter(shape) {
            switch (shape.type) {
                case 'point':
                    return { x: shape.x, y: shape.y };
                case 'line':
                case 'segment':
                    return { x: (shape.x1 + shape.x2) / 2, y: (shape.y1 + shape.y2) / 2 };
                case 'circle':
                    return { x: shape.x, y: shape.y };
                case 'rectangle':
                    return { x: shape.x + shape.width / 2, y: shape.y + shape.height / 2 };
                case 'triangle':
                    return { x: (shape.x1 + shape.x2 + shape.x3) / 3, y: (shape.y1 + shape.y2 + shape.y3) / 3 };
                case 'polygon':
                    let sumX = 0, sumY = 0;
                    shape.points.forEach(p => { sumX += p.x; sumY += p.y; });
                    return { x: sumX / shape.points.length, y: sumY / shape.points.length };
                case 'regular-polygon':
                    return { x: shape.centerX, y: shape.centerY };
                default:
                    return { x: 0, y: 0 };
            }
        }

        // Ëé∑ÂèñË∞ÉÊï¥Â§ßÂ∞èÊéßÂà∂ÁÇπ‰ΩçÁΩÆ
        function getResizeHandles(shape) {
            const handles = [];
            switch (shape.type) {
                case 'point':
                    handles.push({ x: shape.x, y: shape.y, type: 'move' });
                    break;
                case 'line':
                case 'segment':
                    handles.push({ x: shape.x1, y: shape.y1, type: 'endpoint1' });
                    handles.push({ x: shape.x2, y: shape.y2, type: 'endpoint2' });
                    break;
                case 'circle':
                    handles.push({ x: shape.x, y: shape.y, type: 'center' });
                    handles.push({ x: shape.x + shape.radius, y: shape.y, type: 'radius' });
                    break;
                case 'rectangle':
                    handles.push({ x: shape.x, y: shape.y, type: 'topleft' });
                    handles.push({ x: shape.x + shape.width / 2, y: shape.y, type: 'top' });
                    handles.push({ x: shape.x + shape.width, y: shape.y, type: 'topright' });
                    handles.push({ x: shape.x, y: shape.y + shape.height / 2, type: 'left' });
                    handles.push({ x: shape.x + shape.width, y: shape.y + shape.height / 2, type: 'right' });
                    handles.push({ x: shape.x, y: shape.y + shape.height, type: 'bottomleft' });
                    handles.push({ x: shape.x + shape.width / 2, y: shape.y + shape.height, type: 'bottom' });
                    handles.push({ x: shape.x + shape.width, y: shape.y + shape.height, type: 'bottomright' });
                    break;
                case 'triangle':
                    handles.push({ x: shape.x1, y: shape.y1, type: 'vertex1' });
                    handles.push({ x: shape.x2, y: shape.y2, type: 'vertex2' });
                    handles.push({ x: shape.x3, y: shape.y3, type: 'vertex3' });
                    break;
                case 'polygon':
                    shape.points.forEach((p, i) => {
                        handles.push({ x: p.x, y: p.y, type: 'vertex' + i });
                    });
                    break;
                case 'regular-polygon':
                    handles.push({ x: shape.centerX, y: shape.centerY, type: 'center' });
                    // Â§ñÊé•ÂúÜ‰∏äÁöÑÁÇπ
                    const angle = shape.rotation || 0;
                    handles.push({
                        x: shape.centerX + shape.radius * Math.cos(angle),
                        y: shape.centerY + shape.radius * Math.sin(angle),
                        type: 'radius'
                    });
                    break;
            }
            return handles;
        }

        // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜË∞ÉÊï¥Â§ßÂ∞èÊéßÂà∂ÁÇπ
        function getResizeHandleAtPosition(pos, shape) {
            const handles = getResizeHandles(shape);
            const hitRadius = 8;
            for (const handle of handles) {
                const dist = Math.sqrt(Math.pow(pos.x - handle.x, 2) + Math.pow(pos.y - handle.y, 2));
                if (dist <= hitRadius) {
                    return handle.type;
                }
            }
            return null;
        }

        // Ëé∑ÂèñÊóãËΩ¨ÊâãÊüÑ‰ΩçÁΩÆ
        function getRotationHandlePosition(shape) {
            const center = getShapeCenter(shape);
            let radius = 30;
            
            // Ê†πÊçÆÂõæÂΩ¢Â§ßÂ∞èË∞ÉÊï¥ÊóãËΩ¨ÊâãÊüÑË∑ùÁ¶ª
            switch (shape.type) {
                case 'circle':
                    radius = shape.radius + 30;
                    break;
                case 'rectangle':
                    radius = Math.max(shape.width, shape.height) / 2 + 30;
                    break;
                case 'triangle':
                case 'polygon':
                case 'regular-polygon':
                    // ËÆ°ÁÆóÊúÄÂ§ßË∑ùÁ¶ª
                    const bounds = getShapeBounds(shape);
                    radius = Math.max(bounds.width, bounds.height) / 2 + 30;
                    break;
            }
            
            const rotation = shape.rotation || 0;
            return {
                x: center.x + radius * Math.cos(rotation - Math.PI / 2),
                y: center.y + radius * Math.sin(rotation - Math.PI / 2)
            };
        }

        // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÊóãËΩ¨ÊâãÊüÑ
        function isRotationHandleAtPosition(pos, shape) {
            const handlePos = getRotationHandlePosition(shape);
            const dist = Math.sqrt(Math.pow(pos.x - handlePos.x, 2) + Math.pow(pos.y - handlePos.y, 2));
            return dist <= 10;
        }

        // Ëé∑ÂèñÂõæÂΩ¢ËæπÁïåÊ°Ü
        function getShapeBounds(shape) {
            let minX, minY, maxX, maxY;
            
            switch (shape.type) {
                case 'point':
                    return { x: shape.x, y: shape.y, width: 0, height: 0 };
                case 'line':
                case 'segment':
                    minX = Math.min(shape.x1, shape.x2);
                    maxX = Math.max(shape.x1, shape.x2);
                    minY = Math.min(shape.y1, shape.y2);
                    maxY = Math.max(shape.y1, shape.y2);
                    break;
                case 'circle':
                    return { x: shape.x - shape.radius, y: shape.y - shape.radius, width: shape.radius * 2, height: shape.radius * 2 };
                case 'rectangle':
                    return { x: shape.x, y: shape.y, width: shape.width, height: shape.height };
                case 'triangle':
                    minX = Math.min(shape.x1, shape.x2, shape.x3);
                    maxX = Math.max(shape.x1, shape.x2, shape.x3);
                    minY = Math.min(shape.y1, shape.y2, shape.y3);
                    maxY = Math.max(shape.y1, shape.y2, shape.y3);
                    break;
                case 'polygon':
                    const xs = shape.points.map(p => p.x);
                    const ys = shape.points.map(p => p.y);
                    minX = Math.min(...xs);
                    maxX = Math.max(...xs);
                    minY = Math.min(...ys);
                    maxY = Math.max(...ys);
                    break;
                case 'regular-polygon':
                    return { x: shape.centerX - shape.radius, y: shape.centerY - shape.radius, width: shape.radius * 2, height: shape.radius * 2 };
                default:
                    return { x: 0, y: 0, width: 0, height: 0 };
            }
            
            return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };
        }

        // Âà§Êñ≠ÁÇπÊòØÂê¶Âú®ÂõæÂΩ¢‰∏ä
        function isPointOnShape(pos, shape, hitRadius) {
            switch (shape.type) {
                case 'point':
                    return Math.sqrt(Math.pow(pos.x - shape.x, 2) + Math.pow(pos.y - shape.y, 2)) <= hitRadius + shape.lineWidth;
                
                case 'line':
                case 'segment':
                    return distanceToLine(pos, shape.x1, shape.y1, shape.x2, shape.y2) <= hitRadius;
                
                case 'circle':
                    const distToCenter = Math.sqrt(Math.pow(pos.x - shape.x, 2) + Math.pow(pos.y - shape.y, 2));
                    return Math.abs(distToCenter - shape.radius) <= hitRadius || distToCenter <= hitRadius;
                
                case 'rectangle':
                    return pos.x >= shape.x - hitRadius && 
                           pos.x <= shape.x + shape.width + hitRadius &&
                           pos.y >= shape.y - hitRadius && 
                           pos.y <= shape.y + shape.height + hitRadius;
                
                case 'triangle':
                    return isPointInTriangle(pos, shape);
                
                case 'polygon':
                    return isPointInPolygon(pos, shape.points);
                
                case 'regular-polygon':
                    return isPointInRegularPolygon(pos, shape);
                
                default:
                    return false;
            }
        }

        // Ê£ÄÊµãÁÇπÊòØÂê¶Âú®Ê≠£Â§öËæπÂΩ¢ÂÜÖ
        function isPointInRegularPolygon(pos, shape) {
            const { centerX, centerY, radius, sides, rotation = 0 } = shape;
            
            // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶Âú®ÂúÜÂΩ¢ËåÉÂõ¥ÂÜÖÔºàÂø´ÈÄüÊéíÈô§Ôºâ
            const distToCenter = Math.sqrt(Math.pow(pos.x - centerX, 2) + Math.pow(pos.y - centerY, 2));
            if (distToCenter > radius) return false;
            
            // ‰ΩøÁî®Â∞ÑÁ∫øÊ≥ïÊ£ÄÊµãÁÇπÊòØÂê¶Âú®Â§öËæπÂΩ¢ÂÜÖ
            const points = [];
            for (let i = 0; i < sides; i++) {
                const angle = rotation + (i * 2 * Math.PI / sides);
                points.push({
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                });
            }
            
            return isPointInPolygon(pos, points);
        }

        // ËÆ°ÁÆóÁÇπÂà∞Á∫øÊÆµÁöÑË∑ùÁ¶ª
        function distanceToLine(pos, x1, y1, x2, y2) {
            const A = pos.x - x1;
            const B = pos.y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = pos.x - xx;
            const dy = pos.y - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Âà§Êñ≠ÁÇπÊòØÂê¶Âú®‰∏âËßíÂΩ¢ÂÜÖ
        function isPointInTriangle(pos, triangle) {
            const { x1, y1, x2, y2, x3, y3 } = triangle;
            const d1 = sign(pos, { x: x1, y: y1 }, { x: x2, y: y2 });
            const d2 = sign(pos, { x: x2, y: y2 }, { x: x3, y: y3 });
            const d3 = sign(pos, { x: x3, y: y3 }, { x: x1, y: y1 });
            
            const hasNeg = (d1 < 0) || (d2 < 0) || (d3 < 0);
            const hasPos = (d1 > 0) || (d2 > 0) || (d3 > 0);
            
            return !(hasNeg && hasPos);
        }

        function sign(p1, p2, p3) {
            return (p1.x - p3.x) * (p2.y - p3.y) - (p2.x - p3.x) * (p1.y - p3.y);
        }

        // Âà§Êñ≠ÁÇπÊòØÂê¶Âú®Â§öËæπÂΩ¢ÂÜÖ
        function isPointInPolygon(pos, points) {
            let inside = false;
            for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i].x, yi = points[i].y;
                const xj = points[j].x, yj = points[j].y;
                
                const intersect = ((yi > pos.y) !== (yj > pos.y)) &&
                    (pos.x < (xj - xi) * (pos.y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // ÁßªÂä®ÂõæÂΩ¢
        function moveShape(shape, dx, dy) {
            switch (shape.type) {
                case 'point':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'line':
                case 'segment':
                    shape.x1 += dx;
                    shape.y1 += dy;
                    shape.x2 += dx;
                    shape.y2 += dy;
                    break;
                case 'circle':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'rectangle':
                    shape.x += dx;
                    shape.y += dy;
                    break;
                case 'triangle':
                    shape.x1 += dx;
                    shape.y1 += dy;
                    shape.x2 += dx;
                    shape.y2 += dy;
                    shape.x3 += dx;
                    shape.y3 += dy;
                    break;
                case 'polygon':
                    shape.points.forEach(p => {
                        p.x += dx;
                        p.y += dy;
                    });
                    break;
                case 'regular-polygon':
                    shape.centerX += dx;
                    shape.centerY += dy;
                    break;
            }
        }

        function handleGeometryMouseMove(e) {
            const pos = getGeometryMousePos(e);
            
            // Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
            document.getElementById('geometry-coords').textContent = `ÂùêÊ†á: (${Math.round(pos.x)}, ${Math.round(pos.y)})`;
            
            // Â§ÑÁêÜË∞ÉÊï¥Â§ßÂ∞è
            if (geometryIsResizing && geometrySelectedShape !== null) {
                const shape = geometryShapes[geometrySelectedShape];
                resizeShape(shape, geometryResizeHandle, pos, geometryInitialShapeState);
                redrawGeometryCanvas();
                return;
            }
            
            // Â§ÑÁêÜÊóãËΩ¨
            if (geometryIsRotating && geometrySelectedShape !== null) {
                const shape = geometryShapes[geometrySelectedShape];
                const currentAngle = Math.atan2(pos.y - geometryRotationCenter.y, pos.x - geometryRotationCenter.x);
                const deltaAngle = currentAngle - geometryInitialAngle;
                rotateShape(shape, deltaAngle, geometryRotationCenter, geometryInitialShapeState);
                redrawGeometryCanvas();
                return;
            }
            
            if (!geometryIsDrawing) return;
            
            if (geometryCurrentTool === 'select' && geometrySelectedShape !== null) {
                // ÊãñÊãΩÁßªÂä®ÈÄâ‰∏≠ÁöÑÂõæÂΩ¢
                const dx = pos.x - geometryStartPoint.x;
                const dy = pos.y - geometryStartPoint.y;
                
                moveShape(geometryShapes[geometrySelectedShape], dx, dy);
                
                geometryStartPoint = pos; // Êõ¥Êñ∞Ëµ∑ÂßãÁÇπ
                redrawGeometryCanvas();
                return;
            }
            
            if (geometryCurrentTool === 'line' || geometryCurrentTool === 'segment') {
                geometryTempShape = {
                    type: geometryCurrentTool,
                    x1: geometryStartPoint.x,
                    y1: geometryStartPoint.y,
                    x2: pos.x,
                    y2: pos.y,
                    color: geometryCurrentColor,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(pos.x - geometryStartPoint.x, 2) + Math.pow(pos.y - geometryStartPoint.y, 2));
                geometryTempShape = {
                    type: 'circle',
                    x: geometryStartPoint.x,
                    y: geometryStartPoint.y,
                    radius: radius,
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'rectangle') {
                geometryTempShape = {
                    type: 'rectangle',
                    x: Math.min(geometryStartPoint.x, pos.x),
                    y: Math.min(geometryStartPoint.y, pos.y),
                    width: Math.abs(pos.x - geometryStartPoint.x),
                    height: Math.abs(pos.y - geometryStartPoint.y),
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'triangle') {
                geometryTempShape = {
                    type: 'triangle',
                    x1: geometryStartPoint.x,
                    y1: geometryStartPoint.y,
                    x2: pos.x,
                    y2: geometryStartPoint.y,
                    x3: (geometryStartPoint.x + pos.x) / 2,
                    y3: pos.y,
                    color: geometryCurrentColor,
                    fill: geometryCurrentFill,
                    lineWidth: geometryCurrentLineWidth
                };
            } else if (geometryCurrentTool === 'regular-polygon') {
                const radius = Math.sqrt(Math.pow(pos.x - geometryStartPoint.x, 2) + Math.pow(pos.y - geometryStartPoint.y, 2));
                geometryTempShape.radius = radius;
                geometryTempShape.rotation = Math.atan2(pos.y - geometryStartPoint.y, pos.x - geometryStartPoint.x);
            }
            
            redrawGeometryCanvas();
        }

        function handleGeometryMouseUp(e) {
            // Â§ÑÁêÜË∞ÉÊï¥Â§ßÂ∞èÁªìÊùü
            if (geometryIsResizing) {
                geometryIsResizing = false;
                geometryResizeHandle = null;
                geometryInitialShapeState = null;
                return;
            }
            
            // Â§ÑÁêÜÊóãËΩ¨ÁªìÊùü
            if (geometryIsRotating) {
                geometryIsRotating = false;
                geometryRotationCenter = null;
                geometryInitialAngle = 0;
                geometryInitialShapeState = null;
                return;
            }
            
            if (!geometryIsDrawing) return;
            
            geometryIsDrawing = false;
            
            if (geometryTempShape && geometryCurrentTool !== 'polygon') {
                // Á°Æ‰øùÂõæÂΩ¢ÊúâË∂≥Â§üÁöÑÂ§ßÂ∞èÊâçÊ∑ªÂä†
                if (isValidShape(geometryTempShape)) {
                    addGeometryShape(geometryTempShape);
                }
                geometryTempShape = null;
                redrawGeometryCanvas();
            }
        }

        function isValidShape(shape) {
            if (!shape) return false;
            
            switch (shape.type) {
                case 'line':
                case 'segment':
                    return Math.abs(shape.x2 - shape.x1) > 2 || Math.abs(shape.y2 - shape.y1) > 2;
                case 'circle':
                    return shape.radius > 2;
                case 'rectangle':
                    return shape.width > 2 && shape.height > 2;
                case 'triangle':
                    return Math.abs(shape.x2 - shape.x1) > 2;
                case 'polygon':
                    return shape.points.length >= 3;
                case 'regular-polygon':
                    return shape.radius > 2;
                default:
                    return true;
            }
        }

        function handleGeometryDoubleClick(e) {
            e.preventDefault();
            // ÂèåÂáªÂÆåÊàêÂ§öËæπÂΩ¢
            if (geometryCurrentTool === 'polygon' && geometryTempShape && geometryTempShape.points.length >= 3) {
                addGeometryShape({
                    type: 'polygon',
                    points: [...geometryTempShape.points],
                    color: geometryTempShape.color,
                    fill: geometryTempShape.fill,
                    lineWidth: geometryTempShape.lineWidth
                });
                geometryTempShape = null;
                redrawGeometryCanvas();
                showNotification('Â§öËæπÂΩ¢ÁªòÂà∂ÂÆåÊàê', 'success');
            }
        }

        function handleGeometryRightClick(e) {
            e.preventDefault();
            // Âè≥ÈîÆÂèñÊ∂àÂΩìÂâçÁªòÂà∂
            if (geometryTempShape) {
                geometryTempShape = null;
                redrawGeometryCanvas();
                showNotification('Â∑≤ÂèñÊ∂àÁªòÂà∂', 'info');
            }
        }

        // Ë∞ÉÊï¥ÂõæÂΩ¢Â§ßÂ∞è
        function resizeShape(shape, handleType, pos, initialState) {
            switch (shape.type) {
                case 'point':
                    shape.x = pos.x;
                    shape.y = pos.y;
                    break;
                case 'line':
                case 'segment':
                    if (handleType === 'endpoint1') {
                        shape.x1 = pos.x;
                        shape.y1 = pos.y;
                    } else if (handleType === 'endpoint2') {
                        shape.x2 = pos.x;
                        shape.y2 = pos.y;
                    }
                    break;
                case 'circle':
                    if (handleType === 'center') {
                        shape.x = pos.x;
                        shape.y = pos.y;
                    } else if (handleType === 'radius') {
                        shape.radius = Math.sqrt(Math.pow(pos.x - shape.x, 2) + Math.pow(pos.y - shape.y, 2));
                    }
                    break;
                case 'rectangle':
                    resizeRectangle(shape, handleType, pos, initialState);
                    break;
                case 'triangle':
                    resizeTriangle(shape, handleType, pos);
                    break;
                case 'polygon':
                    resizePolygon(shape, handleType, pos);
                    break;
                case 'regular-polygon':
                    if (handleType === 'center') {
                        shape.centerX = pos.x;
                        shape.centerY = pos.y;
                    } else if (handleType === 'radius') {
                        shape.radius = Math.sqrt(Math.pow(pos.x - shape.centerX, 2) + Math.pow(pos.y - shape.centerY, 2));
                        shape.rotation = Math.atan2(pos.y - shape.centerY, pos.x - shape.centerX);
                    }
                    break;
            }
        }

        // Ë∞ÉÊï¥Áü©ÂΩ¢Â§ßÂ∞è
        function resizeRectangle(shape, handleType, pos, initialState) {
            const oldX = initialState.x;
            const oldY = initialState.y;
            const oldRight = oldX + initialState.width;
            const oldBottom = oldY + initialState.height;
            
            switch (handleType) {
                case 'topleft':
                    shape.x = pos.x;
                    shape.y = pos.y;
                    shape.width = oldRight - pos.x;
                    shape.height = oldBottom - pos.y;
                    break;
                case 'top':
                    shape.y = pos.y;
                    shape.height = oldBottom - pos.y;
                    break;
                case 'topright':
                    shape.y = pos.y;
                    shape.width = pos.x - oldX;
                    shape.height = oldBottom - pos.y;
                    break;
                case 'left':
                    shape.x = pos.x;
                    shape.width = oldRight - pos.x;
                    break;
                case 'right':
                    shape.width = pos.x - oldX;
                    break;
                case 'bottomleft':
                    shape.x = pos.x;
                    shape.width = oldRight - pos.x;
                    shape.height = pos.y - oldY;
                    break;
                case 'bottom':
                    shape.height = pos.y - oldY;
                    break;
                case 'bottomright':
                    shape.width = pos.x - oldX;
                    shape.height = pos.y - oldY;
                    break;
            }
            
            // Á°Æ‰øùÂÆΩÈ´ò‰∏∫Ê≠£
            if (shape.width < 0) {
                shape.x = oldRight;
                shape.width = -shape.width;
            }
            if (shape.height < 0) {
                shape.y = oldBottom;
                shape.height = -shape.height;
            }
        }

        // Ë∞ÉÊï¥‰∏âËßíÂΩ¢Â§ßÂ∞è
        function resizeTriangle(shape, handleType, pos) {
            if (handleType === 'vertex1') {
                shape.x1 = pos.x;
                shape.y1 = pos.y;
            } else if (handleType === 'vertex2') {
                shape.x2 = pos.x;
                shape.y2 = pos.y;
            } else if (handleType === 'vertex3') {
                shape.x3 = pos.x;
                shape.y3 = pos.y;
            }
        }

        // Ë∞ÉÊï¥Â§öËæπÂΩ¢Â§ßÂ∞è
        function resizePolygon(shape, handleType, pos) {
            if (handleType.startsWith('vertex')) {
                const index = parseInt(handleType.replace('vertex', ''));
                if (shape.points[index]) {
                    shape.points[index].x = pos.x;
                    shape.points[index].y = pos.y;
                }
            }
        }

        // ÊóãËΩ¨ÂõæÂΩ¢
        function rotateShape(shape, deltaAngle, center, initialState) {
            shape.rotation = (initialState.rotation || 0) + deltaAngle;
            
            switch (shape.type) {
                case 'line':
                case 'segment':
                    const p1 = rotatePoint(initialState.x1, initialState.y1, center.x, center.y, deltaAngle);
                    const p2 = rotatePoint(initialState.x2, initialState.y2, center.x, center.y, deltaAngle);
                    shape.x1 = p1.x;
                    shape.y1 = p1.y;
                    shape.x2 = p2.x;
                    shape.y2 = p2.y;
                    break;
                case 'rectangle':
                    // Áü©ÂΩ¢ÁöÑÊóãËΩ¨ÈÄöËøáÂõõ‰∏™ËßíÁöÑÊóãËΩ¨Êù•ÂÆûÁé∞
                    const corners = [
                        { x: initialState.x, y: initialState.y },
                        { x: initialState.x + initialState.width, y: initialState.y },
                        { x: initialState.x + initialState.width, y: initialState.y + initialState.height },
                        { x: initialState.x, y: initialState.y + initialState.height }
                    ];
                    const rotatedCorners = corners.map(p => rotatePoint(p.x, p.y, center.x, center.y, deltaAngle));
                    // ËÆ°ÁÆóÊñ∞ÁöÑËæπÁïåÊ°Ü
                    const xs = rotatedCorners.map(p => p.x);
                    const ys = rotatedCorners.map(p => p.y);
                    shape.x = Math.min(...xs);
                    shape.y = Math.min(...ys);
                    shape.width = Math.max(...xs) - shape.x;
                    shape.height = Math.max(...ys) - shape.y;
                    break;
                case 'triangle':
                    const t1 = rotatePoint(initialState.x1, initialState.y1, center.x, center.y, deltaAngle);
                    const t2 = rotatePoint(initialState.x2, initialState.y2, center.x, center.y, deltaAngle);
                    const t3 = rotatePoint(initialState.x3, initialState.y3, center.x, center.y, deltaAngle);
                    shape.x1 = t1.x;
                    shape.y1 = t1.y;
                    shape.x2 = t2.x;
                    shape.y2 = t2.y;
                    shape.x3 = t3.x;
                    shape.y3 = t3.y;
                    break;
                case 'polygon':
                    shape.points = initialState.points.map(p => rotatePoint(p.x, p.y, center.x, center.y, deltaAngle));
                    break;
                case 'regular-polygon':
                    // Ê≠£Â§öËæπÂΩ¢ÁöÑÊóãËΩ¨Â∑≤ÁªèÈÄöËøá rotation Â±ûÊÄßÂ§ÑÁêÜ
                    break;
            }
        }

        // ÊóãËΩ¨ÁÇπ
        function rotatePoint(x, y, cx, cy, angle) {
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            const dx = x - cx;
            const dy = y - cy;
            return {
                x: cx + dx * cos - dy * sin,
                y: cy + dx * sin + dy * cos
            };
        }

        function addGeometryShape(shape) {
            geometryHistory.push([...geometryShapes]);
            geometryShapes.push(shape);
            redrawGeometryCanvas();
        }

        function redrawGeometryCanvas() {
            if (!geometryCtx) return;
            
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            geometryCtx.clearRect(0, 0, geometryCanvas.width, geometryCanvas.height);
            
            // ÁªòÂà∂ÊâÄÊúâÂõæÂΩ¢
            geometryShapes.forEach((shape, index) => {
                const isSelected = (index === geometrySelectedShape);
                drawGeometryShape(shape, false, isSelected);
            });
            
            // ÁªòÂà∂‰∏¥Êó∂ÂõæÂΩ¢
            if (geometryTempShape) {
                drawGeometryShape(geometryTempShape, true, false);
            }
            
            // ÁªòÂà∂Â§öËæπÂΩ¢‰∏¥Êó∂ÁÇπ
            if (geometryTempShape && geometryTempShape.type === 'polygon') {
                geometryTempShape.points.forEach((point, index) => {
                    drawGeometryPoint(point.x, point.y, '#0071e3', index === 0 ? 6 : 4);
                });
            }
        }

        function drawGeometryShape(shape, isTemp = false, isSelected = false) {
            geometryCtx.strokeStyle = shape.color;
            geometryCtx.lineWidth = shape.lineWidth;
            geometryCtx.fillStyle = shape.fill || 'transparent';
            
            if (isTemp) {
                geometryCtx.setLineDash([5, 5]);
            } else {
                geometryCtx.setLineDash([]);
            }
            
            switch (shape.type) {
                case 'point':
                    drawGeometryPoint(shape.x, shape.y, shape.color, shape.lineWidth + 4);
                    if (isSelected) {
                        drawGeometryPoint(shape.x, shape.y, '#0071e3', shape.lineWidth + 8, true);
                    }
                    break;
                case 'line':
                case 'segment':
                    geometryCtx.beginPath();
                    geometryCtx.moveTo(shape.x1, shape.y1);
                    geometryCtx.lineTo(shape.x2, shape.y2);
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x1, shape.y1);
                        drawSelectionIndicator(shape.x2, shape.y2);
                    }
                    break;
                case 'circle':
                    geometryCtx.beginPath();
                    geometryCtx.arc(shape.x, shape.y, shape.radius, 0, Math.PI * 2);
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x, shape.y);
                        drawSelectionIndicator(shape.x + shape.radius, shape.y);
                    }
                    break;
                case 'rectangle':
                    geometryCtx.beginPath();
                    geometryCtx.rect(shape.x, shape.y, shape.width, shape.height);
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x, shape.y);
                        drawSelectionIndicator(shape.x + shape.width, shape.y);
                        drawSelectionIndicator(shape.x, shape.y + shape.height);
                        drawSelectionIndicator(shape.x + shape.width, shape.y + shape.height);
                    }
                    break;
                case 'triangle':
                    geometryCtx.beginPath();
                    geometryCtx.moveTo(shape.x1, shape.y1);
                    geometryCtx.lineTo(shape.x2, shape.y2);
                    geometryCtx.lineTo(shape.x3, shape.y3);
                    geometryCtx.closePath();
                    if (shape.fill && shape.fill !== 'transparent') {
                        geometryCtx.fill();
                    }
                    geometryCtx.stroke();
                    if (isSelected) {
                        drawSelectionIndicator(shape.x1, shape.y1);
                        drawSelectionIndicator(shape.x2, shape.y2);
                        drawSelectionIndicator(shape.x3, shape.y3);
                    }
                    break;
                case 'polygon':
                    if (shape.points.length > 1) {
                        geometryCtx.beginPath();
                        geometryCtx.moveTo(shape.points[0].x, shape.points[0].y);
                        for (let i = 1; i < shape.points.length; i++) {
                            geometryCtx.lineTo(shape.points[i].x, shape.points[i].y);
                        }
                        if (shape.fill && shape.fill !== 'transparent') {
                            geometryCtx.fill();
                        }
                        geometryCtx.stroke();
                        if (isSelected) {
                            shape.points.forEach(p => drawSelectionIndicator(p.x, p.y));
                        }
                    }
                    break;
                case 'regular-polygon':
                    drawRegularPolygon(shape, isSelected);
                    break;
            }
            
            // ÁªòÂà∂ÈÄâ‰∏≠ÂõæÂΩ¢ÁöÑÈÄâÊã©Ê°ÜÂíåÊóãËΩ¨ÊâãÊüÑ
            if (isSelected && shape.type !== 'point') {
                drawSelectionBox(shape);
                drawRotationHandle(shape);
            }
            
            geometryCtx.setLineDash([]);
        }

        // ÁªòÂà∂Ê≠£Â§öËæπÂΩ¢
        function drawRegularPolygon(shape, isSelected) {
            const { centerX, centerY, radius, sides, rotation = 0 } = shape;
            
            geometryCtx.beginPath();
            for (let i = 0; i < sides; i++) {
                const angle = rotation + (i * 2 * Math.PI / sides);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                if (i === 0) {
                    geometryCtx.moveTo(x, y);
                } else {
                    geometryCtx.lineTo(x, y);
                }
            }
            geometryCtx.closePath();
            
            if (shape.fill && shape.fill !== 'transparent') {
                geometryCtx.fill();
            }
            geometryCtx.stroke();
            
            // ÁªòÂà∂‰∏≠ÂøÉÁÇπÂíåÂçäÂæÑÊéßÂà∂ÁÇπ
            if (isSelected) {
                drawSelectionIndicator(centerX, centerY);
                const radiusX = centerX + radius * Math.cos(rotation);
                const radiusY = centerY + radius * Math.sin(rotation);
                drawSelectionIndicator(radiusX, radiusY);
            }
        }

        // ÁªòÂà∂ÈÄâÊã©Ê°Ü
        function drawSelectionBox(shape) {
            const bounds = getShapeBounds(shape);
            geometryCtx.strokeStyle = '#0071e3';
            geometryCtx.lineWidth = 1;
            geometryCtx.setLineDash([3, 3]);
            geometryCtx.strokeRect(bounds.x - 5, bounds.y - 5, bounds.width + 10, bounds.height + 10);
            geometryCtx.setLineDash([]);
            
            // ÁªòÂà∂Ë∞ÉÊï¥Â§ßÂ∞èÊéßÂà∂ÁÇπ
            const handles = getResizeHandles(shape);
            handles.forEach(handle => {
                drawResizeHandle(handle.x, handle.y);
            });
        }

        // ÁªòÂà∂Ë∞ÉÊï¥Â§ßÂ∞èÊéßÂà∂ÁÇπ
        function drawResizeHandle(x, y) {
            const size = 8;
            geometryCtx.fillStyle = '#0071e3';
            geometryCtx.fillRect(x - size/2, y - size/2, size, size);
            geometryCtx.strokeStyle = '#ffffff';
            geometryCtx.lineWidth = 1;
            geometryCtx.strokeRect(x - size/2, y - size/2, size, size);
        }

        // ÁªòÂà∂ÊóãËΩ¨ÊâãÊüÑ
        function drawRotationHandle(shape) {
            const center = getShapeCenter(shape);
            const handlePos = getRotationHandlePosition(shape);
            
            // ÁªòÂà∂ËøûÊé•Á∫ø
            geometryCtx.beginPath();
            geometryCtx.moveTo(center.x, center.y);
            geometryCtx.lineTo(handlePos.x, handlePos.y);
            geometryCtx.strokeStyle = '#0071e3';
            geometryCtx.lineWidth = 1;
            geometryCtx.setLineDash([3, 3]);
            geometryCtx.stroke();
            geometryCtx.setLineDash([]);
            
            // ÁªòÂà∂ÊóãËΩ¨ÊâãÊüÑÂúÜÂúà
            geometryCtx.beginPath();
            geometryCtx.arc(handlePos.x, handlePos.y, 8, 0, Math.PI * 2);
            geometryCtx.fillStyle = '#0071e3';
            geometryCtx.fill();
            geometryCtx.strokeStyle = '#ffffff';
            geometryCtx.lineWidth = 2;
            geometryCtx.stroke();
            
            // ÁªòÂà∂ÊóãËΩ¨ÁÆ≠Â§¥ÂõæÊ†á
            geometryCtx.beginPath();
            geometryCtx.arc(handlePos.x, handlePos.y, 4, 0.5, 2.5);
            geometryCtx.strokeStyle = '#ffffff';
            geometryCtx.lineWidth = 1.5;
            geometryCtx.stroke();
        }

        // ÁªòÂà∂ÈÄâ‰∏≠ÊåáÁ§∫Âô®ÔºàÂ∞èÊñπÂùóÔºâ
        function drawSelectionIndicator(x, y) {
            const size = 6;
            geometryCtx.fillStyle = '#0071e3';
            geometryCtx.fillRect(x - size/2, y - size/2, size, size);
            geometryCtx.strokeStyle = '#ffffff';
            geometryCtx.lineWidth = 1;
            geometryCtx.strokeRect(x - size/2, y - size/2, size, size);
        }

        function drawGeometryPoint(x, y, color, size) {
            geometryCtx.beginPath();
            geometryCtx.arc(x, y, size / 2, 0, Math.PI * 2);
            geometryCtx.fillStyle = color;
            geometryCtx.fill();
        }

        function clearGeometryCanvas() {
            if (geometryShapes.length === 0) return;
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÁîªÂ∏ÉÂêóÔºüÊâÄÊúâÂõæÂΩ¢Â∞ÜË¢´Âà†Èô§„ÄÇ')) {
                geometryHistory.push([...geometryShapes]);
                geometryShapes = [];
                geometryTempShape = null;
                geometrySelectedShape = null;
                redrawGeometryCanvas();
                showNotification('ÁîªÂ∏ÉÂ∑≤Ê∏ÖÁ©∫', 'success');
            }
        }

        // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂá†‰ΩïÂõæÂΩ¢
        function deleteSelectedGeometryShape() {
            if (geometrySelectedShape === null || geometrySelectedShape === undefined) return;
            if (geometrySelectedShape < 0 || geometrySelectedShape >= geometryShapes.length) return;
            
            // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
            geometryHistory.push([...geometryShapes]);
            
            // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂõæÂΩ¢
            geometryShapes.splice(geometrySelectedShape, 1);
            
            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            geometrySelectedShape = null;
            
            // ÈáçÁªòÁîªÂ∏É
            redrawGeometryCanvas();
            
            showNotification('ÂõæÂΩ¢Â∑≤Âà†Èô§', 'success');
        }

        function undoGeometry() {
            if (geometryHistory.length === 0) {
                showNotification('Ê≤°ÊúâÂèØÊí§ÈîÄÁöÑÊìç‰Ωú', 'warning');
                return;
            }
            geometryShapes = geometryHistory.pop();
            geometryTempShape = null;
            redrawGeometryCanvas();
            showNotification('Â∑≤Êí§ÈîÄ', 'success');
        }

        function toggleGeometryGrid() {
            geometryShowGrid = !geometryShowGrid;
            geometryCanvas.classList.toggle('grid-hidden', !geometryShowGrid);
            document.querySelector('#geometry-grid-toggle i').classList.toggle('text-gray-600', geometryShowGrid);
            document.querySelector('#geometry-grid-toggle i').classList.toggle('text-primary', !geometryShowGrid);
        }

        function exportGeometryImage() {
            if (geometryShapes.length === 0) {
                showNotification('ÁîªÂ∏É‰∏∫Á©∫ÔºåÊó†Ê≥ïÂØºÂá∫', 'warning');
                return;
            }
            
            // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏ÉÔºå‰∏çÂåÖÂê´ÁΩëÊ†º
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = geometryCanvas.width;
            tempCanvas.height = geometryCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Â°´ÂÖÖÁôΩËâ≤ËÉåÊôØ
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // ÁªòÂà∂ÊâÄÊúâÂõæÂΩ¢
            geometryShapes.forEach(shape => {
                tempCtx.strokeStyle = shape.color;
                tempCtx.lineWidth = shape.lineWidth;
                tempCtx.fillStyle = shape.fill || 'transparent';
                
                switch (shape.type) {
                    case 'point':
                        tempCtx.beginPath();
                        tempCtx.arc(shape.x, shape.y, (shape.lineWidth + 4) / 2, 0, Math.PI * 2);
                        tempCtx.fillStyle = shape.color;
                        tempCtx.fill();
                        break;
                    case 'line':
                    case 'segment':
                        tempCtx.beginPath();
                        tempCtx.moveTo(shape.x1, shape.y1);
                        tempCtx.lineTo(shape.x2, shape.y2);
                        tempCtx.stroke();
                        break;
                    case 'circle':
                        tempCtx.beginPath();
                        tempCtx.arc(shape.x, shape.y, shape.radius, 0, Math.PI * 2);
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'rectangle':
                        tempCtx.beginPath();
                        tempCtx.rect(shape.x, shape.y, shape.width, shape.height);
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'triangle':
                        tempCtx.beginPath();
                        tempCtx.moveTo(shape.x1, shape.y1);
                        tempCtx.lineTo(shape.x2, shape.y2);
                        tempCtx.lineTo(shape.x3, shape.y3);
                        tempCtx.closePath();
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                    case 'polygon':
                        if (shape.points.length > 1) {
                            tempCtx.beginPath();
                            tempCtx.moveTo(shape.points[0].x, shape.points[0].y);
                            for (let i = 1; i < shape.points.length; i++) {
                                tempCtx.lineTo(shape.points[i].x, shape.points[i].y);
                            }
                            if (shape.fill && shape.fill !== 'transparent') {
                                tempCtx.fill();
                            }
                            tempCtx.stroke();
                        }
                        break;
                    case 'regular-polygon':
                        tempCtx.beginPath();
                        const { centerX, centerY, radius, sides, rotation = 0 } = shape;
                        for (let i = 0; i < sides; i++) {
                            const angle = rotation + (i * 2 * Math.PI / sides);
                            const x = centerX + radius * Math.cos(angle);
                            const y = centerY + radius * Math.sin(angle);
                            if (i === 0) {
                                tempCtx.moveTo(x, y);
                            } else {
                                tempCtx.lineTo(x, y);
                            }
                        }
                        tempCtx.closePath();
                        if (shape.fill && shape.fill !== 'transparent') {
                            tempCtx.fill();
                        }
                        tempCtx.stroke();
                        break;
                }
            });
            
            // ‰∏ãËΩΩÂõæÁâá
            const link = document.createElement('a');
            link.download = `Âá†‰ΩïÂõæÂΩ¢_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
            
            showNotification('ÂõæÁâáÂ∑≤ÂØºÂá∫', 'success');
        }

        // ========== Êî∂ÂÖ•ËÆ∞ÂΩïÁ®ãÂ∫è ==========
        let incomeCurrentDate = new Date();
        let incomeData = {};
        let incomeDefaultRate = 200;
        let incomeEditingDate = null;
        const INCOME_STORAGE_KEY = 'teacherIncomeData';
        const INCOME_SETTINGS_KEY = 'teacherIncomeSettings';

        function initIncomeModule() {
            loadIncomeData();
            loadIncomeSettings();
            renderIncomeCalendar();
            updateIncomeStats();
            
            // ÁªëÂÆöËæìÂÖ•Ê°ÜÂÆûÊó∂ËÆ°ÁÆó
            const hoursInput = document.getElementById('income-hours');
            const rateInput = document.getElementById('income-rate');
            const bonusInput = document.getElementById('income-bonus');
            
            [hoursInput, rateInput, bonusInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', calculateIncomePreview);
                }
            });
        }

        function loadIncomeData() {
            const saved = localStorage.getItem(INCOME_STORAGE_KEY);
            if (saved) {
                incomeData = JSON.parse(saved);
            }
        }

        function saveIncomeData() {
            localStorage.setItem(INCOME_STORAGE_KEY, JSON.stringify(incomeData));
        }

        function loadIncomeSettings() {
            const saved = localStorage.getItem(INCOME_SETTINGS_KEY);
            if (saved) {
                const settings = JSON.parse(saved);
                incomeDefaultRate = settings.defaultRate || 200;
            }
        }

        function saveIncomeSettings() {
            const rate = document.getElementById('income-default-rate').value;
            if (rate) {
                incomeDefaultRate = parseFloat(rate);
                localStorage.setItem(INCOME_SETTINGS_KEY, JSON.stringify({
                    defaultRate: incomeDefaultRate
                }));
                closeIncomeSettings();
                showNotification('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
            }
        }

        function changeIncomeMonth(offset) {
            incomeCurrentDate.setMonth(incomeCurrentDate.getMonth() + offset);
            renderIncomeCalendar();
            updateIncomeStats();
        }

        function renderIncomeCalendar() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            // Êõ¥Êñ∞Ê†áÈ¢ò
            const monthTitle = document.getElementById('income-month-title');
            if (monthTitle) {
                monthTitle.textContent = `${year}Âπ¥${String(month + 1).padStart(2, '0')}Êúà`;
            }
            
            const grid = document.getElementById('income-calendar-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            // Ëé∑ÂèñÊúà‰ªΩÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Ëé∑ÂèñÁ¨¨‰∏ÄÂ§©ÊòØÊòüÊúüÂá†Ôºà0=Âë®Êó•Ôºå1=Âë®‰∏ÄÔºâ
            let startDayOfWeek = firstDay.getDay();
            if (startDayOfWeek === 0) startDayOfWeek = 7;
            startDayOfWeek--; // Ë∞ÉÊï¥‰∏∫Âë®‰∏Ä‰∏∫0
            
            // Ê∑ªÂä†‰∏äÊúàÁöÑÊó•Êúü
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const cell = createIncomeDayCell(day, true);
                grid.appendChild(cell);
            }
            
            // Ê∑ªÂä†ÂΩìÊúàÁöÑÊó•Êúü
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && 
                               today.getMonth() === month && 
                               today.getDate() === day;
                const data = incomeData[dateKey];
                
                const cell = createIncomeDayCell(day, false, isToday, data, dateKey);
                grid.appendChild(cell);
            }
            
            // Ê∑ªÂä†‰∏ãÊúàÁöÑÊó•Êúü
            const remainingCells = 42 - (startDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createIncomeDayCell(day, true);
                grid.appendChild(cell);
            }
        }

        function createIncomeDayCell(day, isOtherMonth, isToday = false, data = null, dateKey = null) {
            const cell = document.createElement('div');
            cell.className = 'income-day-cell';
            
            if (isOtherMonth) {
                cell.classList.add('other-month');
            }
            if (isToday) {
                cell.classList.add('today');
            }
            if (data) {
                cell.classList.add('has-data');
            }
            
            // Âà§Êñ≠ÊòØÂê¶ÊòØÂë®Êú´
            const date = dateKey ? new Date(dateKey) : null;
            if (date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    cell.classList.add('weekend');
                }
            }
            
            let html = `<div class="income-day-number">${day}</div>`;
            
            if (data) {
                if (data.hours > 0) {
                    html += `<div class="income-day-hours">${data.hours}h</div>`;
                }
                const totalAmount = (data.hours * data.rate) + (data.bonus || 0);
                html += `<div class="income-day-amount">${totalAmount}ÂÖÉ</div>`;
            } else if (!isOtherMonth && dateKey) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ºëÊÅØÊó•ÔºàÂèØ‰ª•Ëá™ÂÆö‰πâÔºâ
                const dayOfWeek = new Date(dateKey).getDay();
                if (dayOfWeek === 0) {
                    html += `<div class="income-day-rest">‰ºëÊÅØ</div>`;
                }
            }
            
            cell.innerHTML = html;
            
            if (dateKey) {
                cell.onclick = () => openIncomeModal(dateKey);
            }
            
            return cell;
        }

        function updateIncomeStats() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            let totalHours = 0;
            let totalAmount = 0;
            let totalBonus = 0;
            
            Object.keys(incomeData).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    const data = incomeData[dateKey];
                    totalHours += data.hours || 0;
                    totalAmount += (data.hours || 0) * (data.rate || 0);
                    totalBonus += data.bonus || 0;
                }
            });
            
            const grandTotal = totalAmount + totalBonus;
            
            const totalHoursEl = document.getElementById('income-total-hours');
            const totalAmountEl = document.getElementById('income-total-amount');
            const totalBonusEl = document.getElementById('income-total-bonus');
            const grandTotalEl = document.getElementById('income-grand-total');
            
            if (totalHoursEl) totalHoursEl.textContent = totalHours.toFixed(1) + 'h';
            if (totalAmountEl) totalAmountEl.textContent = totalAmount.toFixed(1) + 'ÂÖÉ';
            if (totalBonusEl) totalBonusEl.textContent = totalBonus.toFixed(1) + 'ÂÖÉ';
            if (grandTotalEl) grandTotalEl.textContent = grandTotal.toFixed(1) + 'ÂÖÉ';
        }

        function openIncomeModal(dateKey) {
            incomeEditingDate = dateKey;
            const data = incomeData[dateKey];
            
            document.getElementById('income-modal-title').textContent = 
                data ? 'ÁºñËæëÊî∂ÂÖ•ËÆ∞ÂΩï' : 'ËÆ∞ÂΩïÊî∂ÂÖ•';
            document.getElementById('income-date').value = dateKey;
            document.getElementById('income-hours').value = data ? data.hours : '';
            document.getElementById('income-rate').value = data ? data.rate : incomeDefaultRate;
            document.getElementById('income-bonus').value = data ? (data.bonus || '') : '';
            document.getElementById('income-note').value = data ? (data.note || '') : '';
            document.getElementById('income-btn-delete').style.display = data ? 'block' : 'none';
            
            calculateIncomePreview();
            document.getElementById('income-modal').classList.add('show');
        }

        function closeIncomeModal() {
            document.getElementById('income-modal').classList.remove('show');
            incomeEditingDate = null;
        }

        function calculateIncomePreview() {
            const hoursInput = document.getElementById('income-hours');
            const rateInput = document.getElementById('income-rate');
            const bonusInput = document.getElementById('income-bonus');
            const amountEl = document.getElementById('income-calc-amount');
            const totalEl = document.getElementById('income-calc-total');
            
            if (!hoursInput || !rateInput || !bonusInput) return;
            
            const hours = parseFloat(hoursInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            const bonus = parseFloat(bonusInput.value) || 0;
            
            const amount = hours * rate;
            const total = amount + bonus;
            
            if (amountEl) amountEl.textContent = amount.toFixed(1) + 'ÂÖÉ';
            if (totalEl) totalEl.textContent = total.toFixed(1) + 'ÂÖÉ';
        }

        function saveIncomeRecord() {
            if (!incomeEditingDate) return;
            
            const hours = parseFloat(document.getElementById('income-hours').value) || 0;
            const rate = parseFloat(document.getElementById('income-rate').value) || 0;
            const bonus = parseFloat(document.getElementById('income-bonus').value) || 0;
            const note = document.getElementById('income-note').value.trim();
            
            if (hours === 0 && bonus === 0) {
                showNotification('ËØ∑ËæìÂÖ•Â∑•‰ΩúÊó∂ÈïøÊàñË°•Ë¥¥ÈáëÈ¢ù', 'warning');
                return;
            }
            
            incomeData[incomeEditingDate] = {
                hours,
                rate,
                bonus,
                note,
                updatedAt: new Date().toISOString()
            };
            
            saveIncomeData();
            renderIncomeCalendar();
            updateIncomeStats();
            closeIncomeModal();
            showNotification('Êî∂ÂÖ•ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò', 'success');
        }

        function deleteIncomeRecord() {
            if (!incomeEditingDate) return;
            
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êî∂ÂÖ•ËÆ∞ÂΩïÂêóÔºü')) {
                delete incomeData[incomeEditingDate];
                saveIncomeData();
                renderIncomeCalendar();
                updateIncomeStats();
                closeIncomeModal();
                showNotification('Êî∂ÂÖ•ËÆ∞ÂΩïÂ∑≤Âà†Èô§', 'success');
            }
        }

        function showIncomeSettings() {
            document.getElementById('income-default-rate').value = incomeDefaultRate;
            document.getElementById('income-settings-modal').classList.add('show');
        }

        function closeIncomeSettings() {
            document.getElementById('income-settings-modal').classList.remove('show');
        }

        function exportIncomeToExcel() {
            const year = incomeCurrentDate.getFullYear();
            const month = incomeCurrentDate.getMonth();
            
            const records = [];
            Object.keys(incomeData).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === year && m === month + 1) {
                    const data = incomeData[dateKey];
                    records.push({
                        date: dateKey,
                        ...data
                    });
                }
            });
            
            if (records.length === 0) {
                showNotification('Êú¨ÊúàÊöÇÊó†Êî∂ÂÖ•ËÆ∞ÂΩïÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            records.sort((a, b) => a.date.localeCompare(b.date));
            
            const data = [['Êó•Êúü', 'Â∑•‰ΩúÊó∂Èïø(Â∞èÊó∂)', 'ËØæÊó∂Ë¥πÂçï‰ª∑(ÂÖÉ)', 'ËØæÊó∂Êî∂ÂÖ•(ÂÖÉ)', 'Ë°•Ë¥¥(ÂÖÉ)', 'ÊÄªÊî∂ÂÖ•(ÂÖÉ)', 'Â§áÊ≥®']];
            
            records.forEach(record => {
                const amount = record.hours * record.rate;
                const total = amount + (record.bonus || 0);
                data.push([
                    record.date,
                    record.hours,
                    record.rate,
                    amount,
                    record.bonus || 0,
                    total,
                    record.note || ''
                ]);
            });
            
            // Ê∑ªÂä†Ê±áÊÄªË°å
            const totalHours = records.reduce((sum, r) => sum + r.hours, 0);
            const totalAmount = records.reduce((sum, r) => sum + (r.hours * r.rate), 0);
            const totalBonus = records.reduce((sum, r) => sum + (r.bonus || 0), 0);
            const grandTotal = totalAmount + totalBonus;
            
            data.push(['', '', '', '', '', '', '']);
            data.push(['Ê±áÊÄª', totalHours, '', totalAmount, totalBonus, grandTotal, '']);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 12 }, { wch: 15 }, { wch: 15 }, 
                { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 30 }
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Êî∂ÂÖ•ËÆ∞ÂΩï');
            XLSX.writeFile(wb, `Êî∂ÂÖ•ËÆ∞ÂΩï_${year}Âπ¥${String(month + 1).padStart(2, '0')}Êúà.xlsx`);
            
            showNotification('Êî∂ÂÖ•ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫Excel', 'success');
        }

        // ========== ËØæÂêéÂèçÈ¶àÁ®ãÂ∫è ==========
        let feedbackData = [];
        const FEEDBACK_STORAGE_KEY = 'teacherFeedbackData';

        function initFeedbackModule() {
            loadFeedbackData();
            renderFeedbackHistory();
            setupFeedbackForm();
            
            // ËÆæÁΩÆÈªòËÆ§Êó•Êúü‰∏∫‰ªäÂ§©
            const dateInput = document.getElementById('feedbackDate');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
        }

        function loadFeedbackData() {
            const saved = localStorage.getItem(FEEDBACK_STORAGE_KEY);
            if (saved) {
                feedbackData = JSON.parse(saved);
            }
        }

        function saveFeedbackData() {
            localStorage.setItem(FEEDBACK_STORAGE_KEY, JSON.stringify(feedbackData));
        }

        function setupFeedbackForm() {
            const form = document.getElementById('feedbackForm');

            // Ë°®ÂçïÊèê‰∫§
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveFeedback();
                });
            }
        }

        function getFeedbackFormData() {
            return {
                id: Date.now(),
                studentName: document.getElementById('feedbackStudentName')?.value || '',
                date: document.getElementById('feedbackDate')?.value || '',
                subject: document.getElementById('feedbackSubject')?.value || '',
                duration: document.getElementById('feedbackDuration')?.value || '',
                content: document.getElementById('feedbackContent')?.value || '',
                understanding: document.getElementById('feedbackUnderstanding')?.value || '',
                issues: document.getElementById('feedbackIssues')?.value || '',
                homework: document.getElementById('feedbackHomework')?.value || '',
                nextPlan: document.getElementById('feedbackNextPlan')?.value || '',
                comment: document.getElementById('feedbackComment')?.value || '',
                createdAt: new Date().toISOString()
            };
        }

        function validateFeedback(data) {
            if (!data.studentName.trim()) {
                showNotification('ËØ∑ËæìÂÖ•Â≠¶ÁîüÂßìÂêç', 'warning');
                return false;
            }
            if (!data.date) {
                showNotification('ËØ∑ÈÄâÊã©ËØæÁ®ãÊó•Êúü', 'warning');
                return false;
            }
            if (!data.subject) {
                showNotification('ËØ∑ÈÄâÊã©ÁßëÁõÆ', 'warning');
                return false;
            }
            if (!data.content.trim()) {
                showNotification('ËØ∑ËæìÂÖ•ÊïôÂ≠¶ÂÜÖÂÆπ', 'warning');
                return false;
            }
            if (!data.understanding.trim()) {
                showNotification('ËØ∑ËæìÂÖ•Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ', 'warning');
                return false;
            }
            if (!data.comment.trim()) {
                showNotification('ËØ∑ËæìÂÖ•ËÄÅÂ∏àËØÑËØ≠', 'warning');
                return false;
            }
            return true;
        }

        function saveFeedback() {
            const data = getFeedbackFormData();
            
            if (!validateFeedback(data)) {
                return;
            }
            
            feedbackData.unshift(data);
            saveFeedbackData();
            renderFeedbackHistory();
            clearFeedbackForm();
            showNotification('ÂèçÈ¶à‰øùÂ≠òÊàêÂäü', 'success');
        }

        function clearFeedbackForm() {
            const form = document.getElementById('feedbackForm');
            if (form) {
                form.reset();
            }

            // ÈáçÁΩÆÊó•Êúü‰∏∫‰ªäÂ§©
            const dateInput = document.getElementById('feedbackDate');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
        }

        function renderFeedbackHistory() {
            const container = document.getElementById('feedbackHistoryList');
            if (!container) return;
            
            if (feedbackData.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fa fa-inbox text-4xl mb-2"></i>
                        <p>ÊöÇÊó†ÂèçÈ¶àËÆ∞ÂΩï</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = feedbackData.map(item => `
                <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-gray-900">${escapeHTML(item.studentName)}</h3>
                            <p class="text-sm text-gray-500">${item.date} ¬∑ ${item.subject} ¬∑ ${item.duration}Â∞èÊó∂</p>
                        </div>
                        <button onclick="deleteFeedback(${item.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                    <p class="text-gray-700 text-sm line-clamp-2">${escapeHTML(item.content)}</p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="viewFeedback(${item.id})" class="text-blue-500 hover:text-blue-700 text-sm">
                            <i class="fa fa-eye mr-1"></i>Êü•Áúã
                        </button>
                        <button onclick="editFeedback(${item.id})" class="text-green-500 hover:text-green-700 text-sm">
                            <i class="fa fa-edit mr-1"></i>ÁºñËæë
                        </button>
                        <button onclick="copyFeedbackById(${item.id})" class="text-gray-500 hover:text-gray-700 text-sm">
                            <i class="fa fa-copy mr-1"></i>Â§çÂà∂
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteFeedback(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂèçÈ¶àÂêóÔºü')) return;
            
            feedbackData = feedbackData.filter(item => item.id !== id);
            saveFeedbackData();
            renderFeedbackHistory();
            showNotification('ÂèçÈ¶àÂ∑≤Âà†Èô§', 'success');
        }

        function viewFeedback(id) {
            const item = feedbackData.find(f => f.id === id);
            if (!item) return;
            
            loadFeedbackToForm(item);
            previewFeedback();
        }

        function editFeedback(id) {
            const item = feedbackData.find(f => f.id === id);
            if (!item) return;
            
            loadFeedbackToForm(item);
            
            // Âà†Èô§ÊóßËÆ∞ÂΩï
            feedbackData = feedbackData.filter(f => f.id !== id);
            saveFeedbackData();
            renderFeedbackHistory();
            
            showNotification('Â∑≤Âä†ËΩΩÂà∞Ë°®ÂçïÔºå‰øÆÊîπÂêéËØ∑ÈáçÊñ∞‰øùÂ≠ò', 'info');
        }

        function loadFeedbackToForm(item) {
            document.getElementById('feedbackStudentName').value = item.studentName || '';
            document.getElementById('feedbackDate').value = item.date || '';
            document.getElementById('feedbackSubject').value = item.subject || '';
            document.getElementById('feedbackDuration').value = item.duration || '';
            document.getElementById('feedbackContent').value = item.content || '';
            document.getElementById('feedbackUnderstanding').value = item.understanding || '';
            document.getElementById('feedbackIssues').value = item.issues || '';
            document.getElementById('feedbackHomework').value = item.homework || '';
            document.getElementById('feedbackNextPlan').value = item.nextPlan || '';
            document.getElementById('feedbackComment').value = item.comment || '';
        }

        function generateFeedbackText(data) {
            let text = `„ÄêËØæÂêéÂèçÈ¶à„Äë\n\n`;
            text += `Â≠¶ÁîüÂßìÂêçÔºö${data.studentName}\n`;
            text += `ËØæÁ®ãÊó•ÊúüÔºö${data.date}\n`;
            text += `ÁßëÁõÆÔºö${data.subject}\n`;
            text += `ËØæÊó∂Ôºö${data.duration}Â∞èÊó∂\n\n`;

            text += `„ÄêÊú¨Ê¨°ÊïôÂ≠¶ÂÜÖÂÆπ„Äë\n${data.content}\n\n`;
            text += `„ÄêÂ≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ„Äë\n${data.understanding}\n\n`;
            
            if (data.issues) {
                text += `„ÄêÂ≠òÂú®ÈóÆÈ¢ò„Äë\n${data.issues}\n\n`;
            }
            
            if (data.homework) {
                text += `„ÄêËØæÂêé‰Ωú‰∏ö„Äë\n${data.homework}\n\n`;
            }
            
            if (data.nextPlan) {
                text += `„Äê‰∏ãËäÇËØæËÆ°Âàí„Äë\n${data.nextPlan}\n\n`;
            }
            
            text += `„ÄêËÄÅÂ∏àËØÑËØ≠„Äë\n${data.comment}\n\n`;
            text += `---\nÂèçÈ¶àÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}`;
            
            return text;
        }

        function generateFeedbackHTML(data) {
            let html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Â≠¶ÁîüÂßìÂêçÔºö</strong>${escapeHTML(data.studentName)}</div>
                        <div><strong>ËØæÁ®ãÊó•ÊúüÔºö</strong>${data.date}</div>
                        <div><strong>ÁßëÁõÆÔºö</strong>${data.subject}</div>
                        <div><strong>ËØæÊó∂Ôºö</strong>${data.duration}Â∞èÊó∂</div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Êú¨Ê¨°ÊïôÂ≠¶ÂÜÖÂÆπ</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.content)}</p>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.understanding)}</p>
                    </div>
            `;
            
            if (data.issues) {
                html += `
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Â≠òÂú®ÈóÆÈ¢ò</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.issues)}</p>
                    </div>
                `;
            }
            
            if (data.homework) {
                html += `
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">ËØæÂêé‰Ωú‰∏ö</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.homework)}</p>
                    </div>
                `;
            }
            
            if (data.nextPlan) {
                html += `
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">‰∏ãËäÇËØæËÆ°Âàí</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.nextPlan)}</p>
                    </div>
                `;
            }
            
            html += `
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-2">ËÄÅÂ∏àËØÑËØ≠</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(data.comment)}</p>
                    </div>
                </div>
            `;
            
            return html;
        }

        function previewFeedback() {
            const data = getFeedbackFormData();
            
            if (!data.studentName || !data.content) {
                showNotification('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÂ≠¶ÁîüÂßìÂêçÂíåÊïôÂ≠¶ÂÜÖÂÆπ', 'warning');
                return;
            }
            
            const modal = document.getElementById('feedbackPreviewModal');
            const content = document.getElementById('feedbackPreviewContent');
            
            if (content) {
                content.innerHTML = generateFeedbackHTML(data);
            }
            
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeFeedbackPreview() {
            const modal = document.getElementById('feedbackPreviewModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function copyFeedback() {
            const data = getFeedbackFormData();
            
            if (!data.studentName || !data.content) {
                showNotification('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÂ≠¶ÁîüÂßìÂêçÂíåÊïôÂ≠¶ÂÜÖÂÆπ', 'warning');
                return;
            }
            
            const text = generateFeedbackText(data);
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('ÂèçÈ¶àÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(() => {
                showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            });
        }

        function copyFeedbackById(id) {
            const item = feedbackData.find(f => f.id === id);
            if (!item) return;
            
            const text = generateFeedbackText(item);
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('ÂèçÈ¶àÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(() => {
                showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            });
        }

        function copyFeedbackFromPreview() {
            const data = getFeedbackFormData();
            const text = generateFeedbackText(data);
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('ÂèçÈ¶àÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                closeFeedbackPreview();
            }).catch(() => {
                showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            });
        }

        // ÂØºÂá∫ÂΩìÂâçÂèçÈ¶à‰∏∫Word
        function exportFeedbackToWord() {
            const data = getFeedbackFormData();
            
            if (!data.studentName || !data.content) {
                showNotification('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÂ≠¶ÁîüÂßìÂêçÂíåÊïôÂ≠¶ÂÜÖÂÆπ', 'warning');
                return;
            }
            
            const html = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>ËØæÂêéÂèçÈ¶à</title>
                    <style>
                        body { font-family: 'Microsoft YaHei', SimSun, sans-serif; line-height: 1.8; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { font-size: 24px; color: #333; }
                        .info { margin-bottom: 20px; }
                        .info-item { margin: 10px 0; }
                        .section { margin: 20px 0; }
                        .section-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; }
                        .section-content { text-indent: 2em; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ËØæÂêéÂèçÈ¶à</h1>
                    </div>
                    <div class="info">
                        <div class="info-item"><strong>Â≠¶ÁîüÂßìÂêçÔºö</strong>${escapeHTML(data.studentName)}</div>
                        <div class="info-item"><strong>ËØæÁ®ãÊó•ÊúüÔºö</strong>${data.date}</div>
                        <div class="info-item"><strong>ÁßëÁõÆÔºö</strong>${data.subject}</div>
                        <div class="info-item"><strong>ËØæÊó∂Ôºö</strong>${data.duration}Â∞èÊó∂</div>
                    </div>
                    <div class="section">
                        <div class="section-title">Êú¨Ê¨°ÊïôÂ≠¶ÂÜÖÂÆπ</div>
                        <div class="section-content">${escapeHTML(data.content).replace(/\n/g, '<br>')}</div>
                    </div>
                    <div class="section">
                        <div class="section-title">Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ</div>
                        <div class="section-content">${escapeHTML(data.understanding).replace(/\n/g, '<br>')}</div>
                    </div>
                    ${data.issues ? `
                    <div class="section">
                        <div class="section-title">Â≠òÂú®ÈóÆÈ¢ò</div>
                        <div class="section-content">${escapeHTML(data.issues).replace(/\n/g, '<br>')}</div>
                    </div>` : ''}
                    ${data.homework ? `
                    <div class="section">
                        <div class="section-title">ËØæÂêé‰Ωú‰∏ö</div>
                        <div class="section-content">${escapeHTML(data.homework).replace(/\n/g, '<br>')}</div>
                    </div>` : ''}
                    ${data.nextPlan ? `
                    <div class="section">
                        <div class="section-title">‰∏ãËäÇËØæËÆ°Âàí</div>
                        <div class="section-content">${escapeHTML(data.nextPlan).replace(/\n/g, '<br>')}</div>
                    </div>` : ''}
                    <div class="section">
                        <div class="section-title">ËÄÅÂ∏àËØÑËØ≠</div>
                        <div class="section-content">${escapeHTML(data.comment).replace(/\n/g, '<br>')}</div>
                    </div>
                    <div style="margin-top: 40px; text-align: right; color: #999; font-size: 12px;">
                        ÂèçÈ¶àÊó∂Èó¥Ôºö${new Date().toLocaleString('zh-CN')}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ËØæÂêéÂèçÈ¶à_${data.studentName}_${data.date}.doc`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            showNotification('WordÊñáÊ°£Â∑≤ÂØºÂá∫', 'success');
        }

        // ÂØºÂá∫ÂΩìÂâçÂèçÈ¶à‰∏∫Excel
        function exportFeedbackToExcel() {
            const data = getFeedbackFormData();
            
            if (!data.studentName || !data.content) {
                showNotification('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÂ≠¶ÁîüÂßìÂêçÂíåÊïôÂ≠¶ÂÜÖÂÆπ', 'warning');
                return;
            }
            
            const csvContent = [
                ['ËØæÂêéÂèçÈ¶à'],
                [],
                ['Â≠¶ÁîüÂßìÂêç', data.studentName],
                ['ËØæÁ®ãÊó•Êúü', data.date],
                ['ÁßëÁõÆ', data.subject],
                ['ËØæÊó∂', data.duration + 'Â∞èÊó∂'],
                [],
                ['Êú¨Ê¨°ÊïôÂ≠¶ÂÜÖÂÆπ'],
                [data.content],
                [],
                ['Â≠¶ÁîüÊéåÊè°ÊÉÖÂÜµ'],
                [data.understanding],
                [],
                ['Â≠òÂú®ÈóÆÈ¢ò', data.issues || 'Êó†'],
                ['ËØæÂêé‰Ωú‰∏ö', data.homework || 'Êó†'],
                ['‰∏ãËäÇËØæËÆ°Âàí', data.nextPlan || 'Êó†'],
                [],
                ['ËÄÅÂ∏àËØÑËØ≠'],
                [data.comment],
                [],
                ['ÂèçÈ¶àÊó∂Èó¥', new Date().toLocaleString('zh-CN')]
            ].map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')).join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ËØæÂêéÂèçÈ¶à_${data.studentName}_${data.date}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            showNotification('ExcelÊñá‰ª∂Â∑≤ÂØºÂá∫', 'success');
        }

        // ÂØºÂá∫ÊâÄÊúâÂèçÈ¶à‰∏∫Excel
        function exportAllFeedbackToExcel() {
            if (feedbackData.length === 0) {
                showNotification('Ê≤°ÊúâÂèçÈ¶àËÆ∞ÂΩïÂèØÂØºÂá∫', 'warning');
                return;
            }
            
            const headers = ['Â≠¶ÁîüÂßìÂêç', 'ËØæÁ®ãÊó•Êúü', 'ÁßëÁõÆ', 'ËØæÊó∂', 'ÊïôÂ≠¶ÂÜÖÂÆπ', 'ÊéåÊè°ÊÉÖÂÜµ', 'Â≠òÂú®ÈóÆÈ¢ò', 'ËØæÂêé‰Ωú‰∏ö', '‰∏ãËäÇËØæËÆ°Âàí', 'ËÄÅÂ∏àËØÑËØ≠', 'ÂàõÂª∫Êó∂Èó¥'];

            const rows = feedbackData.map(item => [
                item.studentName,
                item.date,
                item.subject,
                item.duration,
                item.content,
                item.understanding,
                item.issues || '',
                item.homework || '',
                item.nextPlan || '',
                item.comment,
                new Date(item.createdAt).toLocaleString('zh-CN')
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(','))
                .join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ËØæÂêéÂèçÈ¶àÊ±áÊÄª_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            showNotification(`Â∑≤ÂØºÂá∫ ${feedbackData.length} Êù°ÂèçÈ¶àËÆ∞ÂΩï`, 'success');
        }

        // ========== Â≠¶ÁîüÁÆ°ÁêÜÁ®ãÂ∫è ==========
        let studentsData = [];
        let currentStudentId = null;
        const STUDENTS_STORAGE_KEY = 'teacherStudentsData';

        function initStudentsModule() {
            loadStudentsData();
            renderStudentList();
            updateStudentStats();
        }

        function loadStudentsData() {
            const saved = localStorage.getItem(STUDENTS_STORAGE_KEY);
            if (saved) {
                studentsData = JSON.parse(saved);
            }
        }

        function saveStudentsData() {
            localStorage.setItem(STUDENTS_STORAGE_KEY, JSON.stringify(studentsData));
        }

        function updateStudentStats() {
            const totalCount = studentsData.length;
            const activeCount = studentsData.filter(s => s.status === 'active').length;
            const totalHours = studentsData.reduce((sum, s) => sum + (parseFloat(s.usedHours) || 0), 0);
            const totalIncome = studentsData.reduce((sum, s) => {
                const hours = parseFloat(s.usedHours) || 0;
                const rate = parseFloat(s.hourlyRate) || 0;
                return sum + (hours * rate);
            }, 0);

            const totalCountEl = document.getElementById('student-total-count');
            const activeCountEl = document.getElementById('student-active-count');
            const totalHoursEl = document.getElementById('student-total-hours');
            const totalIncomeEl = document.getElementById('student-total-income');

            if (totalCountEl) totalCountEl.textContent = totalCount;
            if (activeCountEl) activeCountEl.textContent = activeCount;
            if (totalHoursEl) totalHoursEl.textContent = totalHours.toFixed(1) + 'h';
            if (totalIncomeEl) totalIncomeEl.textContent = totalIncome.toFixed(0) + 'ÂÖÉ';
        }

        function renderStudentList() {
            const tbody = document.getElementById('student-list-body');
            const emptyState = document.getElementById('student-empty-state');

            if (!tbody || !emptyState) return;

            if (studentsData.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            tbody.innerHTML = studentsData.map(student => {
                const totalHours = parseFloat(student.totalHours) || 0;
                const usedHours = parseFloat(student.usedHours) || 0;
                const remainingHours = totalHours - usedHours;
                const progressPercent = totalHours > 0 ? (usedHours / totalHours * 100) : 0;
                const hourlyRate = parseFloat(student.hourlyRate) || 0;

                const statusClass = {
                    'active': 'student-status-active',
                    'paused': 'student-status-paused',
                    'graduated': 'student-status-graduated'
                }[student.status] || 'student-status-active';

                const statusText = {
                    'active': 'Âú®ËØª',
                    'paused': 'ÊöÇÂÅú',
                    'graduated': 'ÁªìËØæ'
                }[student.status] || 'Âú®ËØª';

                const avatarText = student.name ? student.name.charAt(0) : '?';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="student-info-cell">
                                <div class="student-avatar">${avatarText}</div>
                                <div>
                                    <div class="student-name">${escapeHTML(student.name)}</div>
                                    ${student.phone ? `<div class="student-phone">${escapeHTML(student.phone)}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${escapeHTML(student.grade || '-')}</div>
                            <div class="text-xs text-gray-500">${escapeHTML(student.school || '')}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="student-hours-info">
                                <div class="student-hours-text">${usedHours.toFixed(1)} / ${totalHours.toFixed(0)} h</div>
                                <div class="student-progress-bar">
                                    <div class="student-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                </div>
                                <div class="student-hours-remaining">Ââ©‰Ωô ${remainingHours.toFixed(1)} h</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="text-sm font-semibold text-gray-900">${hourlyRate}ÂÖÉ/h</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="student-status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="student-action-btn student-action-view" onclick="viewStudent('${student.id}')">
                                <i class="fa fa-eye"></i> Êü•Áúã
                            </button>
                            <button class="student-action-btn student-action-edit" onclick="editStudent('${student.id}')">
                                <i class="fa fa-edit"></i> ÁºñËæë
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openStudentModal() {
            currentStudentId = null;
            document.getElementById('student-modal-title').textContent = 'Ê∑ªÂä†Â≠¶Áîü';
            document.getElementById('student-id').value = '';
            document.getElementById('student-name').value = '';
            document.getElementById('student-grade').value = '';
            document.getElementById('student-school').value = '';
            document.getElementById('student-total-hours-input').value = '';
            document.getElementById('student-used-hours').value = '';
            document.getElementById('student-hourly-rate').value = '';
            document.getElementById('student-phone').value = '';
            document.getElementById('student-weak-points').value = '';
            document.getElementById('student-notes').value = '';
            document.querySelector('input[name="student-status"][value="active"]').checked = true;
            document.getElementById('student-btn-delete').style.display = 'none';

            document.getElementById('student-modal').classList.add('show');
        }

        function closeStudentModal() {
            document.getElementById('student-modal').classList.remove('show');
            currentStudentId = null;
        }

        function editStudent(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            currentStudentId = studentId;
            document.getElementById('student-modal-title').textContent = 'ÁºñËæëÂ≠¶Áîü';
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-grade').value = student.grade || '';
            document.getElementById('student-school').value = student.school || '';
            document.getElementById('student-total-hours-input').value = student.totalHours || '';
            document.getElementById('student-used-hours').value = student.usedHours || '';
            document.getElementById('student-hourly-rate').value = student.hourlyRate || '';
            document.getElementById('student-phone').value = student.phone || '';
            document.getElementById('student-weak-points').value = student.weakPoints || '';
            document.getElementById('student-notes').value = student.notes || '';

            const statusRadio = document.querySelector(`input[name="student-status"][value="${student.status}"]`);
            if (statusRadio) statusRadio.checked = true;

            document.getElementById('student-btn-delete').style.display = 'block';
            document.getElementById('student-modal').classList.add('show');
        }

        function viewStudent(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            currentStudentId = studentId;

            const totalHours = parseFloat(student.totalHours) || 0;
            const usedHours = parseFloat(student.usedHours) || 0;
            const remainingHours = totalHours - usedHours;
            const hourlyRate = parseFloat(student.hourlyRate) || 0;
            const totalIncome = usedHours * hourlyRate;

            const statusText = {
                'active': 'Âú®ËØª',
                'paused': 'ÊöÇÂÅú',
                'graduated': 'ÁªìËØæ'
            }[student.status] || 'Âú®ËØª';

            const weakPoints = student.weakPoints ? student.weakPoints.split(/[,Ôºå]/).filter(p => p.trim()) : [];

            document.getElementById('student-detail-content').innerHTML = `
                <div class="student-detail-grid">
                    <div class="student-detail-section">
                        <div class="student-detail-label">Â≠¶ÁîüÂßìÂêç</div>
                        <div class="student-detail-value">${escapeHTML(student.name)}</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">ÂΩìÂâçÁä∂ÊÄÅ</div>
                        <div class="student-detail-value">${statusText}</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">Âπ¥Á∫ß</div>
                        <div class="student-detail-value">${escapeHTML(student.grade || '-')}</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">Â≠¶Ê†°</div>
                        <div class="student-detail-value">${escapeHTML(student.school || '-')}</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">ËØæÊó∂ËøõÂ∫¶</div>
                        <div class="student-detail-value">${usedHours.toFixed(1)} / ${totalHours.toFixed(0)} Â∞èÊó∂</div>
                        <div class="student-progress-bar" style="margin-top: 8px;">
                            <div class="student-progress-fill" style="width: ${totalHours > 0 ? (usedHours / totalHours * 100) : 0}%"></div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Ââ©‰Ωô ${remainingHours.toFixed(1)} Â∞èÊó∂</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">ËØæÊó∂Ë¥π</div>
                        <div class="student-detail-value">${hourlyRate} ÂÖÉ/Â∞èÊó∂</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">Á¥ØËÆ°Êî∂ÂÖ•</div>
                        <div class="student-detail-value" style="color: #059669;">${totalIncome.toFixed(0)} ÂÖÉ</div>
                    </div>
                    <div class="student-detail-section">
                        <div class="student-detail-label">ËÅîÁ≥ªÁîµËØù</div>
                        <div class="student-detail-value">${escapeHTML(student.phone || '-')}</div>
                    </div>
                </div>
                ${weakPoints.length > 0 ? `
                    <div class="student-detail-section" style="margin-top: 20px;">
                        <div class="student-detail-label">ËñÑÂº±Áü•ËØÜÁÇπ</div>
                        <div class="student-weak-points">
                            ${weakPoints.map(p => `<span class="student-weak-point-tag">${escapeHTML(p.trim())}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${student.notes ? `
                    <div class="student-detail-section" style="margin-top: 20px;">
                        <div class="student-detail-label">Â§áÊ≥®</div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-top: 8px; color: #374151;">${escapeHTML(student.notes)}</div>
                    </div>
                ` : ''}
            `;

            document.getElementById('student-detail-modal').classList.add('show');
        }

        function closeStudentDetailModal() {
            document.getElementById('student-detail-modal').classList.remove('show');
        }

        function editCurrentStudent() {
            closeStudentDetailModal();
            if (currentStudentId) {
                setTimeout(() => editStudent(currentStudentId), 100);
            }
        }

        function saveStudent() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) {
                showNotification('ËØ∑ËæìÂÖ•Â≠¶ÁîüÂßìÂêç', 'warning');
                return;
            }

            const studentData = {
                id: currentStudentId || Date.now().toString(),
                name: name,
                grade: document.getElementById('student-grade').value,
                school: document.getElementById('student-school').value.trim(),
                totalHours: parseFloat(document.getElementById('student-total-hours-input').value) || 0,
                usedHours: parseFloat(document.getElementById('student-used-hours').value) || 0,
                hourlyRate: parseFloat(document.getElementById('student-hourly-rate').value) || 0,
                phone: document.getElementById('student-phone').value.trim(),
                weakPoints: document.getElementById('student-weak-points').value.trim(),
                notes: document.getElementById('student-notes').value.trim(),
                status: document.querySelector('input[name="student-status"]:checked')?.value || 'active',
                updatedAt: new Date().toISOString()
            };

            if (currentStudentId) {
                const index = studentsData.findIndex(s => s.id === currentStudentId);
                if (index !== -1) {
                    studentsData[index] = studentData;
                }
                showNotification('Â≠¶Áîü‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞', 'success');
            } else {
                studentsData.push(studentData);
                showNotification('Â≠¶ÁîüÊ∑ªÂä†ÊàêÂäü', 'success');
            }

            saveStudentsData();
            renderStudentList();
            updateStudentStats();
            closeStudentModal();
        }

        function deleteStudent() {
            if (!currentStudentId) return;

            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰ΩçÂ≠¶ÁîüÁöÑ‰ø°ÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                studentsData = studentsData.filter(s => s.id !== currentStudentId);
                saveStudentsData();
                renderStudentList();
                updateStudentStats();
                closeStudentModal();
                showNotification('Â≠¶ÁîüÂ∑≤Âà†Èô§', 'success');
            }
        }

        function exportStudentsData() {
            if (studentsData.length === 0) {
                showNotification('ÊöÇÊó†Â≠¶ÁîüÊï∞ÊçÆÂèØÂØºÂá∫', 'warning');
                return;
            }

            // ÂáÜÂ§áExcelÊï∞ÊçÆ
            const headers = ['ÂßìÂêç', 'Âπ¥Á∫ß', 'Â≠¶Ê†°', 'ÊÄªËØæÊó∂', 'Â∑≤‰∏äËØæÊó∂', 'Ââ©‰ΩôËØæÊó∂', 'ËØæÊó∂Ë¥π(ÂÖÉ/Â∞èÊó∂)', 'ËÅîÁ≥ªÁîµËØù', 'ËñÑÂº±Áü•ËØÜÁÇπ', 'Â§áÊ≥®', 'Áä∂ÊÄÅ', 'Á¥ØËÆ°Êî∂ÂÖ•(ÂÖÉ)'];
            const data = [headers];

            studentsData.forEach(student => {
                const totalHours = parseFloat(student.totalHours) || 0;
                const usedHours = parseFloat(student.usedHours) || 0;
                const remainingHours = totalHours - usedHours;
                const hourlyRate = parseFloat(student.hourlyRate) || 0;
                const totalIncome = usedHours * hourlyRate;

                const statusText = {
                    'active': 'Âú®ËØª',
                    'paused': 'ÊöÇÂÅú',
                    'graduated': 'ÁªìËØæ'
                }[student.status] || 'Âú®ËØª';

                data.push([
                    student.name,
                    student.grade || '',
                    student.school || '',
                    totalHours,
                    usedHours,
                    remainingHours,
                    hourlyRate,
                    student.phone || '',
                    student.weakPoints || '',
                    student.notes || '',
                    statusText,
                    totalIncome
                ]);
            });

            // Ê∑ªÂä†Ê±áÊÄªË°å
            const totalStudents = studentsData.length;
            const totalHours = studentsData.reduce((sum, s) => sum + (parseFloat(s.usedHours) || 0), 0);
            const totalIncome = studentsData.reduce((sum, s) => {
                const hours = parseFloat(s.usedHours) || 0;
                const rate = parseFloat(s.hourlyRate) || 0;
                return sum + (hours * rate);
            }, 0);

            data.push([]);
            data.push(['Ê±áÊÄª', '', '', '', totalStudents + '‰∫∫', totalHours + 'Â∞èÊó∂', '', '', '', '', '', totalIncome + 'ÂÖÉ']);

            // ÂàõÂª∫Â∑•‰ΩúË°®
            const ws = XLSX.utils.aoa_to_sheet(data);

            // ËÆæÁΩÆÂàóÂÆΩ
            ws['!cols'] = [
                { wch: 12 }, // ÂßìÂêç
                { wch: 10 }, // Âπ¥Á∫ß
                { wch: 20 }, // Â≠¶Ê†°
                { wch: 10 }, // ÊÄªËØæÊó∂
                { wch: 10 }, // Â∑≤‰∏äËØæÊó∂
                { wch: 10 }, // Ââ©‰ΩôËØæÊó∂
                { wch: 15 }, // ËØæÊó∂Ë¥π
                { wch: 15 }, // ËÅîÁ≥ªÁîµËØù
                { wch: 25 }, // ËñÑÂº±Áü•ËØÜÁÇπ
                { wch: 30 }, // Â§áÊ≥®
                { wch: 10 }, // Áä∂ÊÄÅ
                { wch: 15 }  // Á¥ØËÆ°Êî∂ÂÖ•
            ];

            // ÂàõÂª∫Â∑•‰ΩúÁ∞øÂπ∂ÂØºÂá∫
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Â≠¶ÁîüÂàóË°®');
            XLSX.writeFile(wb, `Â≠¶ÁîüÊï∞ÊçÆ_${new Date().toISOString().slice(0, 10)}.xlsx`);

            showNotification('Â≠¶ÁîüÊï∞ÊçÆÂ∑≤ÂØºÂá∫Excel', 'success');
        }

        function importStudentsData() {
            document.getElementById('student-import-file').click();
        }

        function handleStudentImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) {
                        showNotification('ExcelÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ', 'error');
                        return;
                    }

                    // Ëß£ÊûêÊï∞ÊçÆÔºàË∑≥ËøáË°®Â§¥Ôºâ
                    const importedStudents = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0]) continue; // Ë∑≥ËøáÁ©∫Ë°å

                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ±áÊÄªË°å
                        if (row[0] === 'Ê±áÊÄª') break;

                        const statusMap = {
                            'Âú®ËØª': 'active',
                            'ÊöÇÂÅú': 'paused',
                            'ÁªìËØæ': 'graduated'
                        };

                        importedStudents.push({
                            id: Date.now().toString() + '_' + i,
                            name: row[0] || '',
                            grade: row[1] || '',
                            school: row[2] || '',
                            totalHours: parseFloat(row[3]) || 0,
                            usedHours: parseFloat(row[4]) || 0,
                            hourlyRate: parseFloat(row[6]) || 0,
                            phone: row[7] || '',
                            weakPoints: row[8] || '',
                            notes: row[9] || '',
                            status: statusMap[row[10]] || 'active',
                            updatedAt: new Date().toISOString()
                        });
                    }

                    if (importedStudents.length === 0) {
                        showNotification('Êú™ÊâæÂà∞ÊúâÊïàÁöÑÂ≠¶ÁîüÊï∞ÊçÆ', 'warning');
                        return;
                    }

                    if (confirm(`Á°ÆÂÆöË¶ÅÂØºÂÖ• ${importedStudents.length} ‰ΩçÂ≠¶ÁîüÁöÑÊï∞ÊçÆÂêóÔºüËøôÂ∞ÜËøΩÂä†Âà∞Áé∞ÊúâÊï∞ÊçÆ„ÄÇ`)) {
                        studentsData = [...studentsData, ...importedStudents];
                        saveStudentsData();
                        renderStudentList();
                        updateStudentStats();
                        showNotification('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü', 'success');
                    }
                } catch (err) {
                    console.error('ÂØºÂÖ•ÈîôËØØ:', err);
                    showNotification('Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ExcelÊ†ºÂºè', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // ========== ÂáΩÊï∞ÁªòÂà∂Á®ãÂ∫è ==========
        let functionChart = null;
        let chartScale = 1; // ÁîªÂ∏ÉÁº©ÊîæÊØî‰æã
        const baseRange = 10; // Âü∫Á°ÄÂùêÊ†áËåÉÂõ¥
        const { jsPDF } = window.jspdf;
        const coordTooltip = document.getElementById('coord-tooltip');
        const chartContainer = document.getElementById('chart-container');
        const functionTags = document.getElementById('function-tags');
        // È¢úËâ≤Ê±†Ôºö12ÁßçÈ´òÂå∫ÂàÜÂ∫¶È¢úËâ≤
        const colorPool = ['#165DFF', '#36CFC9', '#FF7D00', '#722ED1', '#F759AB', '#13C2C2', '#FF9F1C', '#2F54EB', '#F5222D', '#52C41A', '#FAAD14', '#7B61FF'];
        let colorIndex = 0; 
        let datasetId = 0; 

        function initFunctionDrawing() {
            initTabSwitch();
            initFunctionTypeSwitch();
            initEquationTypeSwitch();
            initChart();
            bindGraphEvents();
            bindEquationEvents();
            bindChartInteractions();
            initSliders();
        }

        // 1. Ê®°ÂùóÈÄâÈ°πÂç°ÂàáÊç¢
        function initTabSwitch() {
            const tabGraph = document.getElementById('tab-graph');
            const tabEquation = document.getElementById('tab-equation');
            const moduleGraph = document.getElementById('module-graph');
            const moduleEquation = document.getElementById('module-equation');

            if (!tabGraph || !tabEquation || !moduleGraph || !moduleEquation) return;

            tabGraph.addEventListener('click', function() {
                tabGraph.classList.add('tab-active');
                tabEquation.classList.remove('tab-active');
                moduleGraph.classList.remove('hidden');
                moduleGraph.classList.add('block');
                moduleEquation.classList.add('hidden');
                moduleEquation.classList.remove('block');
                
                // ÂàáÊç¢Ê†áÁ≠æÂêéÈáçÊñ∞Ë∞ÉÊï¥ÂõæË°®Â§ßÂ∞è
                setTimeout(() => {
                    if (functionChart) {
                        functionChart.resize();
                        functionChart.update();
                    }
                }, 50);
            });

            tabEquation.addEventListener('click', function() {
                tabEquation.classList.add('tab-active');
                tabGraph.classList.remove('tab-active');
                moduleEquation.classList.remove('hidden');
                moduleEquation.classList.add('block');
                moduleGraph.classList.add('hidden');
                moduleGraph.classList.remove('block');
            });
        }

        // 2. ÂáΩÊï∞Á±ªÂûãÈÄâÊã©ÂàáÊç¢
        function initFunctionTypeSwitch() {
            const functionType = document.getElementById('function-type');
            if (!functionType) return;

            const coeffBoxes = [
                'direct', 'linear', 'quadratic', 'hyperbola', 'power',
                'exponential', 'logarithmic', 'sine', 'cosine', 'ellipse', 'conic-hyperbola'
            ];

            functionType.addEventListener('change', function() {
                const value = this.value;
                coeffBoxes.forEach(type => {
                    const el = document.getElementById(`coeff-${type}`);
                    if (el) el.classList.add('hidden');
                });
                const activeEl = document.getElementById(`coeff-${value}`);
                if (activeEl) activeEl.classList.remove('hidden');
            });
        }

        // 3. ÊñπÁ®ãÁ±ªÂûãÈÄâÊã©ÂàáÊç¢
        function initEquationTypeSwitch() {
            // ‰∏ªÈÄâÈ°πÂç°Ôºà‰∏ÄÂÖÉ/‰∫åÂÖÉÔºâ
            const tabSingle = document.getElementById('tab-single');
            const tabSystem = document.getElementById('tab-system');
            const singleEquation = document.getElementById('single-equation');
            const systemEquation = document.getElementById('system-equation');

            if (tabSingle && tabSystem && singleEquation && systemEquation) {
                tabSingle.addEventListener('click', function() {
                    tabSingle.classList.add('tab-active');
                    tabSystem.classList.remove('tab-active');
                    singleEquation.classList.remove('hidden');
                    singleEquation.classList.add('block');
                    systemEquation.classList.add('hidden');
                    systemEquation.classList.remove('block');
                    resetSolutionResult();
                });

                tabSystem.addEventListener('click', function() {
                    tabSystem.classList.add('tab-active');
                    tabSingle.classList.remove('tab-active');
                    systemEquation.classList.remove('hidden');
                    systemEquation.classList.add('block');
                    singleEquation.classList.add('hidden');
                    singleEquation.classList.remove('block');
                    resetSolutionResult();
                });
            }

            // ‰∏ÄÂÖÉÊñπÁ®ãÂ≠êÁ±ªÂûãÔºà‰∏ÄÊ¨°/‰∫åÊ¨°Ôºâ
            const singleType = document.getElementById('single-type');
            const singleOneCoeff = document.getElementById('single-one-coeff');
            const singleTwoCoeff = document.getElementById('single-two-coeff');

            if (singleType && singleOneCoeff && singleTwoCoeff) {
                singleType.addEventListener('change', function() {
                    const value = this.value;
                    singleOneCoeff.classList.add('hidden');
                    singleTwoCoeff.classList.add('hidden');
                    if (value === 'one') singleOneCoeff.classList.remove('hidden');
                    else if (value === 'two') singleTwoCoeff.classList.remove('hidden');
                    resetSolutionResult();
                });
            }
        }

        // 4. ÂàùÂßãÂåñÂáΩÊï∞ÁªòÂõæÁîªÂ∏É - ‰∏çÈôêÂà∂ÂùêÊ†áËΩ¥ËåÉÂõ¥
        function initChart() {
            const chartCanvas = document.getElementById('function-chart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            functionChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'center',
                            grid: { 
                                color: '#E5E7EB',
                                lineWidth: 1
                            },
                            ticks: { 
                                stepSize: 1, 
                                precision: 1,
                                font: {
                                    size: 11
                                }
                            },
                            min: -baseRange * chartScale,
                            max: baseRange * chartScale,
                            animation: false
                        },
                        y: {
                            type: 'linear',
                            position: 'center',
                            grid: { 
                                color: '#E5E7EB',
                                lineWidth: 1
                            },
                            ticks: { 
                                stepSize: 1, 
                                precision: 1,
                                font: {
                                    size: 11
                                }
                            },
                            min: -baseRange * chartScale,
                            max: baseRange * chartScale,
                            animation: false
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: { duration: 300 },
                    interaction: { mode: 'nearest', intersect: false },
                    elements: {
                        line: {
                            spanGaps: false,
                            tension: 0.1
                        },
                        point: {
                            radius: 0,
                            hoverRadius: 4
                        }
                    },
                    layout: {
                        padding: {
                            top: 5,
                            right: 5,
                            bottom: 5,
                            left: 5
                        }
                    }
                }
            });
        }

        // 5. ÁªëÂÆöÁîªÂ∏É‰∫§‰∫íÔºöÊªëËΩÆÁº©Êîæ + Èº†Ê†áÂÆûÊó∂ÂùêÊ†á
        function bindChartInteractions() {
            // ÊªëËΩÆÁº©Êîæ
            chartContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.1 : -0.1;
                chartScale = Math.max(0.2, Math.min(5, chartScale + delta));
                
                // Êõ¥Êñ∞ÂùêÊ†áËΩ¥ËåÉÂõ¥
                functionChart.options.scales.x.min = -baseRange * chartScale;
                functionChart.options.scales.x.max = baseRange * chartScale;
                functionChart.options.scales.y.min = -baseRange * chartScale;
                functionChart.options.scales.y.max = baseRange * chartScale;
                functionChart.update('none');
            });

            // Èº†Ê†áÂÆûÊó∂ÂùêÊ†á
            chartContainer.addEventListener('mousemove', function(e) {
                if (!functionChart) return;
                
                const rect = functionChart.canvas.getBoundingClientRect();
                const x = functionChart.scales.x.getValueForPixel(e.clientX - rect.left);
                const y = functionChart.scales.y.getValueForPixel(e.clientY - rect.top);
                
                // Ê£ÄÊü•ÂùêÊ†áÊòØÂê¶Âú®ÂõæË°®ËåÉÂõ¥ÂÜÖ
                if (x >= functionChart.scales.x.min && x <= functionChart.scales.x.max &&
                    y >= functionChart.scales.y.min && y <= functionChart.scales.y.max) {
                    const xFormatted = x.toFixed(2);
                    const yFormatted = y.toFixed(2);
                    coordTooltip.textContent = `(x, y) = (${xFormatted}, ${yFormatted})`;
                    coordTooltip.style.left = `${e.clientX + 10}px`;
                    coordTooltip.style.top = `${e.clientY + 10}px`;
                    coordTooltip.classList.remove('hidden');
                } else {
                    coordTooltip.classList.add('hidden');
                }
            });

            chartContainer.addEventListener('mouseleave', function() {
                coordTooltip.classList.add('hidden');
            });
        }

        // 6. ÁîüÊàêÂáΩÊï∞Êï∞ÊçÆÁÇπ
        function generateFunctionData(type) {
            const data = [];
            
            // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÁöÑÂõæÂÉèÁªòÂà∂ËåÉÂõ¥
            let xStart = parseFloat(document.getElementById('x-start').value) || -10;
            let xEnd = parseFloat(document.getElementById('x-end').value) || 10;
            
            // Á°Æ‰øùËµ∑ÂßãÂÄºÂ∞è‰∫éÁªìÊùüÂÄº
            if (xStart > xEnd) {
                [xStart, xEnd] = [xEnd, xStart];
            }
            
            // ËÆ°ÁÆóÊ≠•Èïø
            const range = xEnd - xStart;
            const step = Math.max(0.01, range / 500);
            
            switch (type) {
                case 'direct':
                    const kDirect = parseFloat(document.getElementById('k-direct').value) || 1;
                    for (let x = xStart; x <= xEnd; x += step) {
                        data.push({ x, y: kDirect * x });
                    }
                    break;
                
                case 'linear':
                    const k = parseFloat(document.getElementById('k').value) || 1;
                    const b = parseFloat(document.getElementById('b').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        data.push({ x, y: k * x + b });
                    }
                    break;
                
                case 'quadratic':
                    const a = parseFloat(document.getElementById('a').value) || 1;
                    const bq = parseFloat(document.getElementById('bq').value) || 0;
                    const c = parseFloat(document.getElementById('c').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = a * x * x + bq * x + c;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'hyperbola':
                    const kh = parseFloat(document.getElementById('kh').value) || 1;
                    
                    if (xStart < 0 && xEnd > 0) {
                        // Â∑¶‰æßÂàÜÊîØ
                        for (let x = xStart; x <= -0.1; x += step) {
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                        // Ê∑ªÂä†nullÂÄºÊñ≠ÂºÄËøûÊé•
                        data.push({ x: null, y: null });
                        // Âè≥‰æßÂàÜÊîØ
                        for (let x = 0.1; x <= xEnd; x += step) {
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    } else if (xEnd <= 0) {
                        // Âè™Âú®Ë¥üÂçäËΩ¥
                        for (let x = xStart; x <= xEnd; x += step) {
                            if (x === 0) continue;
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    } else {
                        // Âè™Âú®Ê≠£ÂçäËΩ¥
                        for (let x = xStart; x <= xEnd; x += step) {
                            if (x === 0) continue;
                            const y = kh / x;
                            data.push({ x, y: y });
                        }
                    }
                    break;
                
                case 'power':
                    const n = parseFloat(document.getElementById('n').value) || 2;
                    
                    // Âà§Êñ≠ÊòØÂê¶‰∏∫Êï¥Êï∞
                    const isInteger = Math.abs(Math.round(n) - n) < 0.0001;
                    
                    if (isInteger) {
                        const intN = Math.round(n);
                        
                        if (intN > 0) {
                            // Ê≠£Êï¥Êï∞Ê¨°ÂπÇ
                            for (let x = xStart; x <= xEnd; x += step) {
                                const y = Math.pow(x, intN);
                                data.push({ x, y: y });
                            }
                        } else {
                            // Ë¥üÊï¥Êï∞Ê¨°ÂπÇ
                            for (let x = xStart; x <= xEnd; x += step) {
                                if (x === 0) continue;
                                const y = Math.pow(x, intN);
                                data.push({ x, y: y });
                            }
                        }
                    } else {
                        // ÈùûÊï¥Êï∞Ê¨°ÂπÇ
                        const denominator = Math.abs(Math.round(1 / (n - Math.floor(n)))) || 1;
                        
                        if (denominator % 2 === 0) {
                            // ÂàÜÊØç‰∏∫ÂÅ∂Êï∞Êó∂ÔºåÂ∫ïÊï∞ÂøÖÈ°ªÈùûË¥ü
                            for (let x = Math.max(0, xStart); x <= xEnd; x += step) {
                                const y = Math.pow(x, n);
                                data.push({ x, y: y });
                            }
                        } else {
                            // ÂàÜÊØç‰∏∫Â•áÊï∞Êó∂ÔºåÂ∫ïÊï∞ÂèØ‰ª•‰∏∫‰ªªÊÑèÂÆûÊï∞
                            for (let x = xStart; x <= xEnd; x += step) {
                                if (x === 0 && n < 0) continue;
                                const y = Math.pow(x, n);
                                data.push({ x, y: y });
                            }
                        }
                    }
                    break;
                
                case 'exponential':
                    const aExp = parseFloat(document.getElementById('a-exp').value) || 2;
                    const validA = aExp > 0 && aExp !== 1 ? aExp : 2;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = Math.pow(validA, x);
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'logarithmic':
                    const aLog = parseFloat(document.getElementById('a-log').value) || 10;
                    const validALog = aLog > 0 && aLog !== 1 ? aLog : 10;
                    const logStart = Math.max(0.0001, xStart);
                    const smallStep = Math.min(step, 0.001);
                    
                    let x = logStart;
                    while (x <= xEnd) {
                        const y = Math.log(x) / Math.log(validALog);
                        if (Math.abs(y) < 1000) {
                            data.push({ x, y: y });
                        }
                        x += x < 0.1 ? smallStep : step;
                    }
                    break;
                
                case 'sine':
                    const ASin = parseFloat(document.getElementById('A-sin').value) || 1;
                    const wSin = parseFloat(document.getElementById('w-sin').value) || 1;
                    const phiSin = parseFloat(document.getElementById('phi-sin').value) || 0;
                    const dSin = parseFloat(document.getElementById('d-sin').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = ASin * Math.sin(wSin * x + phiSin) + dSin;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'cosine':
                    const ACos = parseFloat(document.getElementById('A-cos').value) || 1;
                    const wCos = parseFloat(document.getElementById('w-cos').value) || 1;
                    const phiCos = parseFloat(document.getElementById('phi-cos').value) || 0;
                    const dCos = parseFloat(document.getElementById('d-cos').value) || 0;
                    for (let x = xStart; x <= xEnd; x += step) {
                        const y = ACos * Math.cos(wCos * x + phiCos) + dCos;
                        data.push({ x, y: y });
                    }
                    break;
                
                case 'ellipse':
                    const aEllipse = parseFloat(document.getElementById('a-ellipse').value) || 3;
                    const bEllipse = parseFloat(document.getElementById('b-ellipse').value) || 2;
                    // ‰ΩøÁî®ÂèÇÊï∞ÊñπÁ®ãÁîüÊàêÊ§≠ÂúÜÊï∞ÊçÆÁÇπ
                    const angleStep = 0.01;
                    for (let t = 0; t < 2 * Math.PI; t += angleStep) {
                        const x = aEllipse * Math.cos(t);
                        const y = bEllipse * Math.sin(t);
                        data.push({ x, y });
                    }
                    // Èó≠ÂêàÊ§≠ÂúÜ
                    data.push(data[0]);
                    break;
                
                case 'conic-hyperbola':
                    const aHyperbola = parseFloat(document.getElementById('a-hyperbola').value) || 2;
                    const bHyperbola = parseFloat(document.getElementById('b-hyperbola').value) || 1;
                    // ‰ΩøÁî®ÂèÇÊï∞ÊñπÁ®ãÁîüÊàêÂèåÊõ≤Á∫øÊï∞ÊçÆÁÇπ
                    const hyperbolaStep = 0.01;
                    // Âè≥ÊîØ
                    for (let t = -Math.PI/2 + 0.01; t < Math.PI/2 - 0.01; t += hyperbolaStep) {
                        const x = aHyperbola / Math.cos(t);
                        const y = bHyperbola * Math.tan(t);
                        data.push({ x, y });
                    }
                    // Ê∑ªÂä†Êñ≠ÁÇπ
                    data.push({ x: null, y: null });
                    // Â∑¶ÊîØ
                    for (let t = Math.PI/2 + 0.01; t < 3*Math.PI/2 - 0.01; t += hyperbolaStep) {
                        const x = aHyperbola / Math.cos(t);
                        const y = bHyperbola * Math.tan(t);
                        data.push({ x, y });
                    }
                    break;
            }
            return data;
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑Âèñ‰∏ã‰∏Ä‰∏™‰∏çÈáçÂ§çÁöÑÈ¢úËâ≤
        function getNextColor() {
            const color = colorPool[colorIndex];
            colorIndex = (colorIndex + 1) % colorPool.length;
            return color;
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÂáΩÊï∞ÂêçÁß∞
        function getFunctionName(type) {
            const nameMap = {
                direct: 'Ê≠£ÊØî‰æãÂáΩÊï∞', linear: '‰∏ÄÊ¨°ÂáΩÊï∞', quadratic: '‰∫åÊ¨°ÂáΩÊï∞',
                hyperbola: 'ÂèçÊØî‰æãÂáΩÊï∞', power: 'ÂπÇÂáΩÊï∞', exponential: 'ÊåáÊï∞ÂáΩÊï∞',
                logarithmic: 'ÂØπÊï∞ÂáΩÊï∞', sine: 'Ê≠£Âº¶ÂáΩÊï∞', cosine: '‰ΩôÂº¶ÂáΩÊï∞',
                ellipse: 'Ê§≠ÂúÜ', 'conic-hyperbola': 'ÂúÜÈî•Êõ≤Á∫øÂèåÊõ≤Á∫ø'
            };
            return nameMap[type] || 'ÂáΩÊï∞';
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÂàõÂª∫ÂáΩÊï∞Ê†áÁ≠æ
        function createFunctionTag(id, type, color) {
            const name = getFunctionName(type);
            const tag = document.createElement('div');
            tag.className = 'func-tag';
            tag.dataset.id = id;
            tag.innerHTML = `
                <span class="w-2 h-2 rounded-full" style="background-color: ${color};"></span>
                <span class="text-sm">${name}</span>
                <i class="fa fa-times func-delete ml-1" title="Âà†Èô§ËØ•ÂáΩÊï∞"></i>
            `;
            
            // Ê∏ÖÁ©∫ÈªòËÆ§ÊèêÁ§∫
            if (functionTags.innerHTML.includes('ÊöÇÊó†ÂáΩÊï∞')) {
                functionTags.innerHTML = '';
            }
            
            functionTags.appendChild(tag);

            // ÁªëÂÆöÂà†Èô§‰∫ã‰ª∂
            tag.querySelector('.func-delete').addEventListener('click', function() {
                functionChart.data.datasets = functionChart.data.datasets.filter(ds => ds.id !== id);
                functionChart.update();
                tag.remove();
                
                // Â¶ÇÊûúÊ≤°ÊúâÂáΩÊï∞‰∫ÜÔºåÊòæÁ§∫ÊèêÁ§∫
                if (functionTags.children.length === 0) {
                    functionTags.innerHTML = '<span class="text-xs text-gray-500">ÊöÇÊó†ÂáΩÊï∞</span>';
                }
            });
        }

        // È™åËØÅÂáΩÊï∞Á≥ªÊï∞ÊòØÂê¶ÂêàÊ≥ï
        function validateFunctionCoefficients(type) {
            switch(type) {
                case 'direct':
                    const kDirect = parseFloat(document.getElementById('k-direct').value);
                    if (kDirect === 0) {
                        alert('ÈîôËØØÔºöÊ≠£ÊØî‰æãÂáΩÊï∞ÁöÑÊØî‰æãÁ≥ªÊï∞k‰∏çËÉΩ‰∏∫0ÔºÅ');
                        return false;
                    }
                    break;
                case 'linear':
                    const kLinear = parseFloat(document.getElementById('k').value);
                    if (kLinear === 0) {
                        alert('ÈîôËØØÔºö‰∏ÄÊ¨°ÂáΩÊï∞ÁöÑÊñúÁéák‰∏çËÉΩ‰∏∫0ÔºÅ');
                        return false;
                    }
                    break;
                case 'quadratic':
                    const aQuadratic = parseFloat(document.getElementById('a').value);
                    if (aQuadratic === 0) {
                        alert('ÈîôËØØÔºö‰∫åÊ¨°ÂáΩÊï∞ÁöÑ‰∫åÊ¨°È°πÁ≥ªÊï∞a‰∏çËÉΩ‰∏∫0ÔºÅ');
                        return false;
                    }
                    break;
                case 'hyperbola':
                    const kHyperbola = parseFloat(document.getElementById('kh').value);
                    if (kHyperbola === 0) {
                        alert('ÈîôËØØÔºöÂèçÊØî‰æãÂáΩÊï∞ÁöÑÊØî‰æãÁ≥ªÊï∞k‰∏çËÉΩ‰∏∫0ÔºÅ');
                        return false;
                    }
                    break;
                case 'exponential':
                    const aExponential = parseFloat(document.getElementById('a-exp').value);
                    if (aExponential <= 0 || aExponential === 1) {
                        alert('ÈîôËØØÔºöÊåáÊï∞ÂáΩÊï∞ÁöÑÂ∫ïÊï∞aÂøÖÈ°ªÊª°Ë∂≥a>0‰∏îa‚â†1ÔºÅ');
                        return false;
                    }
                    break;
                case 'logarithmic':
                    const aLogarithmic = parseFloat(document.getElementById('a-log').value);
                    if (aLogarithmic <= 0 || aLogarithmic === 1) {
                        alert('ÈîôËØØÔºöÂØπÊï∞ÂáΩÊï∞ÁöÑÂ∫ïÊï∞aÂøÖÈ°ªÊª°Ë∂≥a>0‰∏îa‚â†1ÔºÅ');
                        return false;
                    }
                    break;
                case 'ellipse':
                    const aEllipse = parseFloat(document.getElementById('a-ellipse').value);
                    const bEllipse = parseFloat(document.getElementById('b-ellipse').value);
                    if (aEllipse <= 0 || bEllipse <= 0) {
                        alert('ÈîôËØØÔºöÊ§≠ÂúÜÁöÑÈïøÂçäËΩ¥aÂíåÁü≠ÂçäËΩ¥bÂøÖÈ°ªÂ§ß‰∫é0ÔºÅ');
                        return false;
                    }
                    break;
                case 'conic-hyperbola':
                    const aHyperbola = parseFloat(document.getElementById('a-hyperbola').value);
                    const bHyperbola = parseFloat(document.getElementById('b-hyperbola').value);
                    if (aHyperbola <= 0 || bHyperbola <= 0) {
                        alert('ÈîôËØØÔºöÂèåÊõ≤Á∫øÁöÑÂÆûÂçäËΩ¥aÂíåËôöÂçäËΩ¥bÂøÖÈ°ªÂ§ß‰∫é0ÔºÅ');
                        return false;
                    }
                    break;
            }
            return true;
        }

        // ÁªëÂÆöÂõæÂÉèÁªòÂà∂Áõ∏ÂÖ≥‰∫ã‰ª∂
        function bindGraphEvents() {
            // ÁªòÂà∂ÂõæÂÉèÊåâÈíÆ
            document.getElementById('draw-graph').addEventListener('click', function() {
                const functionType = document.getElementById('function-type').value;
                
                // È™åËØÅÁ≥ªÊï∞
                if (!validateFunctionCoefficients(functionType)) {
                    return;
                }
                
                // ÁîüÊàêÂáΩÊï∞Êï∞ÊçÆ
                const data = generateFunctionData(functionType);
                
                // ÂàõÂª∫Êñ∞ÁöÑÊï∞ÊçÆÈõÜ
                const color = getNextColor();
                const newDataset = {
                    id: datasetId++,
                    label: getFunctionName(functionType),
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    fill: false
                };
                
                // Ê∑ªÂä†Âà∞ÂõæË°®
                functionChart.data.datasets.push(newDataset);
                functionChart.update();
                
                // ÂàõÂª∫ÂáΩÊï∞Ê†áÁ≠æ
                createFunctionTag(newDataset.id, functionType, color);
            });
            
            // Ê∏ÖÁ©∫ÊâÄÊúâÂõæÂÉèÊåâÈíÆ
            document.getElementById('reset-graph').addEventListener('click', function() {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂáΩÊï∞ÂõæÂÉèÂêóÔºü')) {
                    functionChart.data.datasets = [];
                    functionChart.update();
                    functionTags.innerHTML = '<span class="text-xs text-gray-500">ÊöÇÊó†ÂáΩÊï∞</span>';
                    colorIndex = 0;
                    datasetId = 0;
                }
            });
            
            // ÂØºÂá∫PDFÊåâÈíÆ
            document.getElementById('export-pdf').addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                
                html2canvas(document.getElementById('chart-container')).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 280;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    doc.save('ÂáΩÊï∞ÂõæÂÉè_' + new Date().toISOString().slice(0,10) + '.pdf');
                });
            });
        }

        // ÁªëÂÆöÊñπÁ®ãÊ±ÇËß£Áõ∏ÂÖ≥‰∫ã‰ª∂
        function bindEquationEvents() {
            document.getElementById('solve-equation').addEventListener('click', function() {
                const singleType = document.getElementById('single-type').value;
                const tabSingle = document.getElementById('tab-single');
                
                if (tabSingle.classList.contains('tab-active')) {
                    if (singleType === 'one') {
                        solveLinearEquation();
                    } else if (singleType === 'two') {
                        solveQuadraticEquation();
                    }
                } else {
                    solveSystemEquation();
                }
            });
        }

        // Ëß£‰∏ÄÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ã
        function solveLinearEquation() {
            const a = parseFloat(document.getElementById('sa1').value);
            const b = parseFloat(document.getElementById('sb1').value);
            
            if (a === 0) {
                alert('ÈîôËØØÔºö‰∏ÄÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁöÑÁ≥ªÊï∞a‰∏çËÉΩ‰∏∫0ÔºÅ');
                return;
            }
            
            const x = -b / a;
            const solution = `x = ${x}`;
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">‰∏ÄÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÊ±ÇËß£</h3>
                    <p class="mb-2">ÊñπÁ®ãÔºö${a}x + ${b} = 0</p>
                    <p class="mb-2">ÁßªÈ°πÂæóÔºö${a}x = ${-b}</p>
                    <p class="mb-2">Ëß£ÂæóÔºöx = ${-b} √∑ ${a} = ${x}</p>
                    <p class="font-medium mt-2">Ëß£Ôºö${solution}</p>
                </div>
            `);
        }

        // Ëß£‰∏ÄÂÖÉ‰∫åÊ¨°ÊñπÁ®ã
        function solveQuadraticEquation() {
            const a = parseFloat(document.getElementById('sa2').value);
            const b = parseFloat(document.getElementById('sb2').value);
            const c = parseFloat(document.getElementById('sc2').value);
            
            if (a === 0) {
                alert('ÈîôËØØÔºö‰∏ÄÂÖÉ‰∫åÊ¨°ÊñπÁ®ãÁöÑ‰∫åÊ¨°È°πÁ≥ªÊï∞a‰∏çËÉΩ‰∏∫0ÔºÅ');
                return;
            }
            
            const delta = b * b - 4 * a * c;
            let solution = '';
            
            if (delta < 0) {
                solution = 'Êó†ÂÆûÊï∞Ëß£';
            } else if (delta === 0) {
                const x = -b / (2 * a);
                solution = `x‚ÇÅ = x‚ÇÇ = ${x}`;
            } else {
                const x1 = (-b + Math.sqrt(delta)) / (2 * a);
                const x2 = (-b - Math.sqrt(delta)) / (2 * a);
                solution = `x‚ÇÅ = ${x1.toFixed(4)}, x‚ÇÇ = ${x2.toFixed(4)}`;
            }
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">‰∏ÄÂÖÉ‰∫åÊ¨°ÊñπÁ®ãÊ±ÇËß£</h3>
                    <p class="mb-2">ÊñπÁ®ãÔºö${a}x¬≤ + ${b}x + ${c} = 0</p>
                    <p class="mb-2">Âà§Âà´ÂºèÔºöŒî = b¬≤ - 4ac = ${b}¬≤ - 4√ó${a}√ó${c} = ${delta}</p>
                    ${delta < 0 ? '<p class="mb-2">Âõ†‰∏∫Œî < 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÊó†ÂÆûÊï∞Ëß£</p>' : 
                      delta === 0 ? `<p class="mb-2">Âõ†‰∏∫Œî = 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÊúâ‰∏Ä‰∏™ÂÆûÊï∞Ëß£</p><p class="mb-2">x = -b/(2a) = ${-b}/(2√ó${a}) = ${(-b/(2*a)).toFixed(4)}</p>` : 
                      `<p class="mb-2">Âõ†‰∏∫Œî > 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÊúâ‰∏§‰∏™ÂÆûÊï∞Ëß£</p><p class="mb-2">x‚ÇÅ = (-b + ‚àöŒî)/(2a) = (${-b} + ‚àö${delta})/(2√ó${a}) = ${((-b + Math.sqrt(delta))/(2*a)).toFixed(4)}</p><p class="mb-2">x‚ÇÇ = (-b - ‚àöŒî)/(2a) = (${-b} - ‚àö${delta})/(2√ó${a}) = ${((-b - Math.sqrt(delta))/(2*a)).toFixed(4)}</p>`}
                    <p class="font-medium mt-2">Ëß£Ôºö${solution}</p>
                </div>
            `);
        }

        // Ëß£‰∫åÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁªÑ
        function solveSystemEquation() {
            const a1 = parseFloat(document.getElementById('a1').value);
            const b1 = parseFloat(document.getElementById('b1').value);
            const c1 = parseFloat(document.getElementById('c1').value);
            const a2 = parseFloat(document.getElementById('a2').value);
            const b2 = parseFloat(document.getElementById('b2').value);
            const c2 = parseFloat(document.getElementById('c2').value);
            
            const D = a1 * b2 - a2 * b1;
            const Dx = c1 * b2 - c2 * b1;
            const Dy = a1 * c2 - a2 * c1;
            
            let solution = '';
            
            if (D === 0) {
                if (Dx === 0 && Dy === 0) {
                    solution = 'ÊñπÁ®ãÁªÑÊúâÊó†Êï∞Ëß£';
                } else {
                    solution = 'ÊñπÁ®ãÁªÑÊó†Ëß£';
                }
            } else {
                const x = Dx / D;
                const y = Dy / D;
                solution = `x = ${x.toFixed(4)}, y = ${y.toFixed(4)}`;
            }
            
            displaySolution(`
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium mb-2">‰∫åÂÖÉ‰∏ÄÊ¨°ÊñπÁ®ãÁªÑÊ±ÇËß£</h3>
                    <p class="mb-2">ÊñπÁ®ãÁªÑÔºö</p>
                    <p class="mb-2">‚ë† ${a1}x + ${b1}y = ${c1}</p>
                    <p class="mb-2">‚ë° ${a2}x + ${b2}y = ${c2}</p>
                    <p class="mb-2">Á≥ªÊï∞Ë°åÂàóÂºèÔºöD = ${a1}√ó${b2} - ${a2}√ó${b1} = ${D}</p>
                    <p class="mb-2">Dx = ${c1}√ó${b2} - ${c2}√ó${b1} = ${Dx}</p>
                    <p class="mb-2">Dy = ${a1}√ó${c2} - ${a2}√ó${c1} = ${Dy}</p>
                    ${D !== 0 ? `<p class="mb-2">Âõ†‰∏∫D ‚â† 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÁªÑÊúâÂîØ‰∏ÄËß£</p><p class="mb-2">x = Dx/D = ${Dx}/${D} = ${(Dx/D).toFixed(4)}</p><p class="mb-2">y = Dy/D = ${Dy}/${D} = ${(Dy/D).toFixed(4)}</p>` : 
                      Dx === 0 && Dy === 0 ? '<p class="mb-2">Âõ†‰∏∫D = 0‰∏îDx = Dy = 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÁªÑÊúâÊó†Êï∞Ëß£</p>' : 
                      '<p class="mb-2">Âõ†‰∏∫D = 0‰ΩÜDxÊàñDy ‚â† 0ÔºåÊâÄ‰ª•ÊñπÁ®ãÁªÑÊó†Ëß£</p>'}
                    <p class="font-medium mt-2">Ëß£Ôºö${solution}</p>
                </div>
            `);
        }

        // ÊòæÁ§∫ÊñπÁ®ãÊ±ÇËß£ÁªìÊûú
        function displaySolution(html) {
            document.getElementById('solution-result').innerHTML = html;
        }

        // ÈáçÁΩÆÊñπÁ®ãÊ±ÇËß£ÁªìÊûú
        function resetSolutionResult() {
            document.getElementById('solution-result').innerHTML = `
                <div class="text-center text-gray-500 py-8 md:py-10">
                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                    <p>ËØ∑ÈÄâÊã©ÊñπÁ®ãÁ±ªÂûãÂπ∂ËæìÂÖ•Á≥ªÊï∞ÔºåÁÇπÂáªÊ±ÇËß£ÊåâÈíÆÊü•ÁúãÁªìÊûú</p>
                    <p class="text-xs mt-2 text-gray-400">Ëß£È¢òÊ≠•È™§‰∏•Ê†ºÈÅµÂæ™‰∏≠Â≠¶Êï∞Â≠¶‰π¶ÂÜôËßÑËåÉ</p>
                </div>
            `;
        }

        // ÂàùÂßãÂåñÊªëÂùó
        function initSliders() {
            // ÁªòÂà∂ËåÉÂõ¥ÊªëÂùó
            const xStart = document.getElementById('x-start');
            const xStartSlider = document.getElementById('x-start-slider');
            if (xStart && xStartSlider) {
                xStart.addEventListener('input', function() {
                    xStartSlider.value = this.value;
                });
                xStartSlider.addEventListener('input', function() {
                    xStart.value = this.value;
                });
            }
            
            const xEnd = document.getElementById('x-end');
            const xEndSlider = document.getElementById('x-end-slider');
            if (xEnd && xEndSlider) {
                xEnd.addEventListener('input', function() {
                    xEndSlider.value = this.value;
                });
                xEndSlider.addEventListener('input', function() {
                    xEnd.value = this.value;
                });
            }
            
            // ÂÖ∂‰ªñÊªëÂùó...
        }

        // ÂàùÂßãÂåñÊâÄÊúâÊ®°Âùó
        window.addEventListener('load', function() {
            try {
                // È¶ñÂÖàÁªëÂÆöÂØºËà™Ê†áÁ≠æÁÇπÂáª‰∫ã‰ª∂
                const navTabs = document.querySelectorAll('.nav-tab');
                console.log('ÊâæÂà∞ÂØºËà™Ê†áÁ≠æÊï∞Èáè:', navTabs.length);
                navTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        console.log('ÁÇπÂáªÂØºËà™Ê†áÁ≠æ:', this.dataset.tab);
                        switchToTab(this.dataset.tab);
                    });
                });
                
                // ÁÑ∂ÂêéÂàùÂßãÂåñÂêÑÊ®°Âùó
                initTheme();
                initWeather();
                startWeatherAutoRefresh();
                initTomato();
                initSchedule();
                initGeometryDrawing();
                initIncomeModule();
                initStudentsModule();
                initFunctionDrawing();
                initFeedbackModule();

                console.log('ÊâÄÊúâÊ®°ÂùóÂàùÂßãÂåñÂÆåÊàê');
            } catch (error) {
                console.error('ÂàùÂßãÂåñÈîôËØØ:', error);
            }
        });
    </script>
</body>
</html>
